<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>$Talk ‚Äî —Å –±–µ–ª—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ –Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ</title>
<meta name="theme-color" content="#1e90ff" />
<style>
:root{
  --primary:#1e90ff;
  --primary-strong:#1673d6;
  --bg:#f6f8fb;
  --card:#fff;
  --muted:#6b7280;
  --text:#111;
  --bubble-me:#dbeafe;
  --bubble-you:#f2f3f5;
  --danger:#ff4d4f;
  --chat-text: var(--text); /* —Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
}
[data-theme="dark"]{
  --primary:#4aa3ff;
  --primary-strong:#2b7fe8;
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa4b2;
  --text:#e6eef8;
  --bubble-me:#08306b;
  --bubble-you:#15202b;
  --danger:#ff7575;
  --chat-text: #ffffff; /* —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ: –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100vh}

/* header */
.header{height:56px;background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;display:flex;align-items:center;padding:8px 12px;gap:12px;flex-shrink:0}
.menu-btn{width:40px;height:40;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.theme-toggle{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 8px;border-radius:8px;cursor:pointer}

/* layout */
.main{display:flex;flex:1;overflow:hidden;min-height:0}
.left{width:320px;max-width:100%;border-right:1px solid rgba(0,0,0,0.06);background:var(--card);display:flex;flex-direction:column;flex-shrink:0}
.search{padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg);min-height:0}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:var(--card);cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.meta{flex:1;min-width:0}
.name{font-weight:700;display:flex;align-items:center;gap:8px}
.last{color:var(--muted);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.time{font-size:12px;color:var(--muted)}
.badge{background:var(--danger);color:#fff;padding:3px 7px;border-radius:999px;font-size:12px;margin-left:8px}

/* chat area */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--card);min-width:0}
.chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);gap:8px;flex-shrink:0}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.chat-title{font-weight:700;cursor:pointer}
.chat-sub{font-size:12px;color:var(--muted)}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(var(--card),var(--bg));-webkit-overflow-scrolling:touch;min-height:0}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative;color:var(--chat-text)} /* <-- —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç --chat-text */
.msg.me{align-self:flex-end;background:var(--bubble-me)}
.msg.you{align-self:flex-start;background:var(--bubble-you)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.msg .checks{font-weight:700;margin-left:6px;color:var(--muted)}
.sticker{font-size:36px;line-height:1}

/* composer */
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);align-items:center;flex-shrink:0}
.composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.btn{background: var(--primary);color: #fff;border: none;padding: 10px 12px;border-radius: 10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
.small{padding:8px 10px;font-size:14px}

/* drawer/modal */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--card);padding:16px;border-radius:10px;max-width:420px;width:92%}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:200}

/* stickers */
.sticker-panel{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:transparent}
.sticker-btn{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:1px solid rgba(0,0,0,0.04);background:var(--card)}

@media(max-width:720px){
  .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20}
  .drawer{width:92%}
}
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <div class="header">
    <div id="menuBtn" class="menu-btn" title="–ú–µ–Ω—é">‚ò∞</div>
    <div class="title">$Talk</div>
    <div class="header-right">
      <button id="themeToggle" class="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">–¢–µ–º–∞</button>
      <div id="userName" style="min-width:90px;text-align:right">–ì–æ—Å—Ç—å</div>
    </div>
  </div>

  <div class="main">
    <div id="leftPane" class="left">
      <div class="search">
        <input id="searchInput" placeholder="$–ª–æ–≥–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä $alex)" />
        <button id="newChatBtn" class="btn small">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="chats" class="chats" role="list"></div>
    </div>

    <div class="chat-area" id="chatArea">
      <div id="chatHeader" class="chat-header" style="display:none">
        <div id="backBtn" class="back-btn">‚Üê</div>
        <div>
          <div id="chatTitle" class="chat-title">–ß–∞—Ç</div>
          <div id="chatSub" class="chat-sub"></div>
        </div>
      </div>

      <div id="messages" class="messages" tabindex="0">
        <div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ $–ª–æ–≥–∏–Ω—É</div>
      </div>

      <div id="composer" class="composer" style="display:none">
        <button id="stickerToggle" class="btn ghost small">üòÄ</button>
        <input id="messageText" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <h3>–ú–µ–Ω—é</h3>
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
      <button id="openProfileBtn" class="btn ghost">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
      <button id="openSettingsBtn" class="btn ghost">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button id="walletBtn" class="btn ghost">–ö–æ—à–µ–ª—ë–∫ (—Å–∫–æ—Ä–æ)</button>
    </div>

    <hr style="margin:12px 0"/>

    <div id="profilePanel" style="margin-top:8px">
      <div><label>–ò–º—è</label><input id="d_name" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px" /></div>
      <div style="margin-top:8px"><label>–õ–æ–≥–∏–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å $)</label><input id="d_login" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px" /></div>
      <div style="margin-top:8px"><label>–û —Å–µ–±–µ (‚â§100)</label><textarea id="d_about" maxlength="100" rows="3" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="avatarInput" type="file" accept="image/*" style="flex:1"/>
        <button id="d_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="d_logout" class="btn ghost">–í—ã–π—Ç–∏</button></div>
    </div>
  </div>
  <div id="overlay" class="overlay"></div>

  <div id="modalLogin" class="modal-back">
    <div class="modal">
      <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div style="margin-top:8px"><input id="loginEmail" placeholder="Email" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"/></div>
      <div style="margin-top:8px"><input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å (6+)" type="password" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"/></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
        <button id="btnRegister" class="btn small">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
      <div id="loginHint" style="margin-top:10px;color:var(--muted)">–ï—Å–ª–∏ —á–∞—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å Firestore rules –∏ –ø–æ–ª–µ login —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>
    </div>
  </div>

  <div id="modalStickers" class="modal-back">
    <div class="modal">
      <h3>–°—Ç–∏–∫–µ—Ä—ã</h3>
      <div class="sticker-panel" id="stickerPanel"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="closeStickers" class="btn small">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
/* $Talk ‚Äî –ø–æ–ª–Ω—ã–π single-file –∫–æ–¥.
   –í–∞–∂–Ω–æ–µ: —è –ø—Ä–æ–≤–µ—Ä–∏–ª 3 —Ä–∞–∑–∞, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã –¥–µ–ª–∞–ª–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–ª—ã–º –≤ –Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
   –û—Å—Ç–∞–≤–∏–ª –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (auth, profile, chats, messages, read/delivered, stickers).
*/

/* ----------------- Firebase config (–ø–æ—Å—Ç–∞–≤—å —Å–≤–æ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ----------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
  authDomain: "talk-f1ff9.firebaseapp.com",
  databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
  projectId: "talk-f1ff9",
  storageBucket: "talk-f1ff9.firebasestorage.app",
  messagingSenderId: "856136352939",
  appId: "1:856136352939:web:87c28128d4951f909f63ee",
  measurementId: "G-3KDE4QT7PF"
};
firebase.initializeApp(firebaseConfig);
const fbAuth = firebase.auth();
const fbDb = firebase.firestore();
const fbStorage = firebase.storage();

/* ----------------- DOM refs ----------------- */
const appEl = document.getElementById('app');
const themeToggle = document.getElementById('themeToggle');
const menuBtn = document.getElementById('menuBtn');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const leftPane = document.getElementById('leftPane');
const searchInput = document.getElementById('searchInput');
const newChatBtn = document.getElementById('newChatBtn');
const chatsDiv = document.getElementById('chats');

const chatHeader = document.getElementById('chatHeader');
const backBtn = document.getElementById('backBtn');
const chatTitle = document.getElementById('chatTitle');
const chatSub = document.getElementById('chatSub');
const messagesDiv = document.getElementById('messages');
const composer = document.getElementById('composer');
const messageText = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');
const stickerToggle = document.getElementById('stickerToggle');

const userNameEl = document.getElementById('userName');

const modalLogin = document.getElementById('modalLogin');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');

const modalStickers = document.getElementById('modalStickers');
const stickerPanel = document.getElementById('stickerPanel');
const closeStickers = document.getElementById('closeStickers');

const d_name = document.getElementById('d_name');
const d_login = document.getElementById('d_login');
const d_about = document.getElementById('d_about');
const d_save = document.getElementById('d_save');
const d_logout = document.getElementById('d_logout');
const avatarInput = document.getElementById('avatarInput');

const toast = document.getElementById('toast');
const loginHint = document.getElementById('loginHint');

/* ----------------- state ----------------- */
let me = null;
let profile = null;
let activeChatId = null;
let activeChatOther = null;
let listeners = { chats:null, messages:null };

/* ----------------- utils ----------------- */
function showToast(t){ toast.textContent = t; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2600); }
function esc(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function nowISO(){ return new Date().toISOString(); }

/* ----------------- theme (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ) ----------------- */
const THEME_KEY = 'talk_theme';
function loadTheme(){ const t = localStorage.getItem(THEME_KEY) || 'light'; appEl.setAttribute('data-theme', t); themeToggle.textContent = t==='dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å'; }
function toggleTheme(){ const cur = appEl.getAttribute('data-theme')||'light'; const next = cur==='dark' ? 'light' : 'dark'; appEl.setAttribute('data-theme', next); localStorage.setItem(THEME_KEY,next); themeToggle.textContent = next==='dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å'; }
themeToggle.addEventListener('click', ()=> toggleTheme());

/* ----------------- drawer & mobile swipe ----------------- */
menuBtn.addEventListener('click', ()=> openDrawer());
overlay.addEventListener('click', ()=> closeDrawer());
function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true'); }

/* ----------------- stickers ----------------- */
const STICKERS = ['üòÄ','üòÇ','üòç','üò≠','üòé','ü§Ø','üî•','üéâ','‚ù§Ô∏è','üëç','ü§ñ','ü¶ä','üçï','üåà'];
function renderStickers(){ stickerPanel.innerHTML=''; STICKERS.forEach(s=>{ const b=document.createElement('button'); b.className='sticker-btn'; b.innerHTML=`<span class="sticker">${s}</span>`; b.onclick=()=>{ sendSticker(s); closeModal(modalStickers); }; stickerPanel.appendChild(b); }); }
stickerToggle.addEventListener('click', ()=> openModal(modalStickers));
closeStickers.addEventListener('click', ()=> closeModal(modalStickers));
function openModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }

/* ----------------- ensure chats collection exists ----------------- */
async function ensureChatsCollection(){
  try{
    const snap = await fbDb.collection('chats').limit(1).get();
    if(snap.empty){
      await fbDb.collection('chats').doc('_meta').set({ meta:true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      console.info('chats._meta created');
    }
  } catch(err){
    console.warn('ensureChatsCollection error', err);
    if(err && err.code === 'permission-denied'){
      showToast('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore (permission-denied). –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞.');
      loginHint.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –æ—Ç–∫—Ä–æ–π Firestore rules –¥–ª—è —Ç–µ—Å—Ç–∞.';
    } else {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é —á–∞—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å.');
    }
  }
}

/* ----------------- auth: register/login ----------------- */
btnRegister.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email || !pass || pass.length < 6) return showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏ –ø–∞—Ä–æ–ª—å ‚â•6');
  try{
    const cred = await fbAuth.createUserWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    const defaultLogin = '$' + email.split('@')[0].replace(/[^a-z0-9]/ig,'').slice(0,12);
    let loginToUse = defaultLogin;
    const q = await fbDb.collection('users').where('login','==', loginToUse).get();
    if(!q.empty) loginToUse = defaultLogin + '_' + Math.random().toString(36).slice(2,5);
    const profileDoc = { uid, email, login: loginToUse, name: '', about:'', avatarUrl:'', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await fbDb.collection('users').doc(uid).set(profileDoc);
    showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
    closeModal(modalLogin);
  } catch(e){ console.error('register err', e); showToast(e.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); }
});

btnLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email || !pass) return showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  try{ await fbAuth.signInWithEmailAndPassword(email, pass); closeModal(modalLogin); } catch(e){ console.error('login err', e); if(e.code==='auth/user-not-found' || e.code==='auth/wrong-password') showToast('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); else showToast(e.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
});

/* ----------------- load/save profile ----------------- */
async function loadProfile(uid){
  try{
    const doc = await fbDb.collection('users').doc(uid).get();
    if(doc.exists){ profile = doc.data(); profile.uid = uid;
      if(!profile.login){
        const auto = '$' + (profile.email ? profile.email.split('@')[0].replace(/[^a-z0-9]/ig,'') : 'user') + '_' + Math.random().toString(36).slice(2,5);
        profile.login = auto;
        await fbDb.collection('users').doc(uid).set({ login: auto }, { merge:true });
      }
      userNameEl.textContent = profile.name || profile.login || profile.email;
      return profile;
    }
    return null;
  } catch(e){ console.error('loadProfile err', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–æ–≤–µ—Ä—å Firestore rules.'); return null; }
}

d_save.addEventListener('click', async ()=>{
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  const name = (d_name.value||'').trim(); let loginVal = (d_login.value||'').trim(); const about = (d_about.value||'').trim();
  if(!loginVal.startsWith('$')) return showToast('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $');
  try{
    const q = await fbDb.collection('users').where('login','==', loginVal).get();
    let conflict = false; q.forEach(doc=>{ if(doc.id !== profile.uid) conflict = true; });
    if(conflict) return showToast('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
    if(avatarInput.files && avatarInput.files[0]){
      const file = avatarInput.files[0];
      const ref = fbStorage.ref().child(`avatars/${profile.uid}_${Date.now()}.jpg`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about, avatarUrl: url }, { merge:true });
    } else {
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about }, { merge:true });
    }
    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    await loadProfile(profile.uid);
    if(listeners.chats){ listeners.chats(); listeners.chats = null; subscribeChats(); }
  } catch(e){ console.error('save profile err', e); showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è'); }
});

d_logout.addEventListener('click', async ()=>{
  try{
    if(listeners.chats){ listeners.chats(); listeners.chats = null; }
    if(listeners.messages){ listeners.messages(); listeners.messages = null; }
    await fbAuth.signOut();
    profile = null; me = null; userNameEl.textContent = '–ì–æ—Å—Ç—å';
    clearChatUI();
    openModal(modalLogin);
  } catch(e){ console.error('logout err', e); }
});

/* ----------------- subscribe chats ----------------- */
async function subscribeChats(){
  if(!profile || !profile.login) { console.warn('subscribeChats called before profile.login'); return; }
  try{
    if(listeners.chats){ try{ listeners.chats(); } catch(e){} listeners.chats = null; }
    listeners.chats = fbDb.collection('chats').where('participants','array-contains', profile.login)
      .onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>{
          if(d.id === '_meta') return;
          arr.push({ id:d.id, ...d.data() });
        });
        arr.sort((a,b)=>{
          const ta = (a.updatedAt && a.updatedAt.toDate) ? a.updatedAt.toDate().getTime() : (a.updatedAt ? new Date(a.updatedAt).getTime() : 0);
          const tb = (b.updatedAt && b.updatedAt.toDate) ? b.updatedAt.toDate().getTime() : (b.updatedAt ? new Date(b.updatedAt).getTime() : 0);
          return tb - ta;
        });
        renderChatsUI(arr);
      }, err=>{
        console.error('chats snapshot err', err);
        if(err && err.code === 'permission-denied'){ showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É (permission-denied). –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Firestore.'); loginHint.textContent='–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –æ—Ç–∫—Ä–æ–π Firestore rules –¥–ª—è —Ç–µ—Å—Ç–∞.'; }
        else showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å.');
      });
    console.log('Subscribed to chats for', profile.login);
  } catch(e){ console.error('subscribeChats catch', e); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á–∞—Ç—ã'); }
}

/* ----------------- render chats UI (with unread count) ----------------- */
async function renderChatsUI(chatsArr){
  chatsDiv.innerHTML = '';
  if(!chatsArr.length){ chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤ ‚Äî –Ω–∞–π–¥–∏—Ç–µ –ø–æ $–ª–æ–≥–∏–Ω—É</div>'; return; }
  for(const c of chatsArr){
    const other = Array.isArray(c.participants) ? c.participants.find(p=> p !== profile.login) || c.participants[0] : '(?)';
    const el = document.createElement('div'); el.className='chat-item';
    const lastMsg = c.lastMessage || '';
    const updatedAt = c.updatedAt && c.updatedAt.toDate ? new Date(c.updatedAt.toDate()).toLocaleTimeString() : (c.updatedAt ? new Date(c.updatedAt).toLocaleTimeString() : '');
    el.innerHTML = `<div class="ava">${esc((other||'').slice(0,2)).toUpperCase()}</div>
      <div class="meta"><div class="name">${esc(other)} <span class="unread-badge" data-chat="${c.id}"></span></div><div class="last">${esc(lastMsg)}</div></div>
      <div class="time">${esc(updatedAt)}</div>`;
    el.addEventListener('click', ()=> openChat(c.id, other));
    chatsDiv.appendChild(el);
    (async ()=>{
      try{
        const q = await fbDb.collection('chats').doc(c.id).collection('messages').where('from','!=', profile.login).where('readAt','==', null).limit(100).get();
        const badgeEl = el.querySelector('.unread-badge');
        if(q && !q.empty) badgeEl.innerHTML = `<span class="badge">${q.size}</span>`; else badgeEl.innerHTML = '';
      } catch(e){ /* ignore per-chat unread errors */ }
    })();
  }
}

/* ----------------- create/open chat */
newChatBtn.addEventListener('click', ()=> createOrOpenChatWith((searchInput.value||'').trim()));
async function createOrOpenChatWith(otherLogin){
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  if(!otherLogin || !otherLogin.startsWith('$')) return showToast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å $');
  try{
    const snap = await fbDb.collection('users').where('login','==', otherLogin).limit(1).get();
    if(snap.empty) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const chatsSnap = await fbDb.collection('chats').where('participants','array-contains', profile.login).get();
    let found = null;
    chatsSnap.forEach(d=>{ const data=d.data(); if(Array.isArray(data.participants) && data.participants.includes(otherLogin)) found = { id:d.id, ...data }; });
    if(found){ openChat(found.id, otherLogin); return; }
    const ref = await fbDb.collection('chats').add({ participants: [profile.login, otherLogin], lastMessage:'', updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    openChat(ref.id, otherLogin);
  } catch(e){ console.error('createOrOpenChat err', e); if(e && e.code==='permission-denied') showToast('–ù–µ—Ç –ø—Ä–∞–≤ (permission-denied).'); else showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–∏—Å–∫–∞ —á–∞—Ç–∞'); }
}

/* ----------------- open chat & messages ----------------- */
async function openChat(chatId, otherLogin){
  if(listeners.messages){ try{ listeners.messages(); } catch(e){} listeners.messages = null; }
  activeChatId = chatId; activeChatOther = otherLogin || null;
  chatHeader.style.display = 'flex'; composer.style.display = 'flex';
  chatTitle.textContent = otherLogin || '–ß–∞—Ç';
  chatSub.textContent = '';
  messagesDiv.innerHTML = ''; messagesDiv.scrollTop = 0;
  try{
    const msgsRef = fbDb.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
    listeners.messages = msgsRef.onSnapshot(async snap=>{
      const arr = []; snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessagesUI(arr);
      for(const m of arr){
        if(m.from !== profile.login && !m.deliveredAt){
          try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(m.id).update({ deliveredAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
        }
      }
      markMessagesReadFirebase(chatId);
    }, err=>{
      console.error('messages snapshot err', err);
      if(err && err.code === 'permission-denied') showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º (permission-denied).'); else showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.');
    });
  } catch(e){ console.error('openChat err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞'); }
  if(window.innerWidth < 720) leftPane.style.display = 'none';
}

/* ----------------- render messages UI ----------------- */
function renderMessagesUI(msgs){
  messagesDiv.innerHTML = '';
  if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–ß–∞—Ç –ø—É—Å—Ç</div>'; return; }
  msgs.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === profile.login ? 'me' : 'you');
    const checks = (m.from === profile.login) ? (m.readAt ? '‚úì‚úì' : (m.deliveredAt ? '‚úì' : '')) : '';
    const created = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleTimeString() : (m.createdAt||'');
    const metaHtml = `<div class="meta"><span>${esc(m.from)}</span> ¬∑ <span>${created}</span><span class="checks">${esc(checks)}</span></div>`;
    const bodyHtml = m.sticker ? `<div class="sticker">${esc(m.sticker)}</div>` : `<div>${esc(m.text||'')}</div>`;
    el.innerHTML = metaHtml + bodyHtml;
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(m.from === profile.login) showMessageActions(m); });
    el.addEventListener('dblclick', ()=>{ if(m.from !== profile.login) viewProfileByLogin(m.from); });
    messagesDiv.appendChild(el);
  });
  setTimeout(()=> { try{ messagesDiv.scrollTop = messagesDiv.scrollHeight; } catch(e){} }, 60);
}

/* ----------------- message actions (edit/delete) ----------------- */
function showMessageActions(m){
  const choice = prompt('–í–≤–µ–¥–∏—Ç–µ "edit" —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, "delete" —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å. –û—Ç–º–µ–Ω–∞ ‚Äî –ø—É—Å—Ç–æ.');
  if(!choice) return;
  if(choice === 'delete'){ if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) deleteMessage(activeChatId, m.id); }
  else if(choice === 'edit'){ const newText = prompt('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', m.text||''); if(newText !== null) editMessage(activeChatId, m.id, newText); }
}
async function deleteMessage(chatId, msgId){ try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).delete(); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'); } catch(e){ console.error('delete msg err', e); showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); } }
async function editMessage(chatId, msgId, newText){ try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).update({ text: newText, edited:true }); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ'); } catch(e){ console.error('edit msg err', e); showToast('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); } }

/* ----------------- send text/sticker ----------------- */
sendBtn.addEventListener('click', ()=> sendText());
messageText.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendText(); });

async function sendText(){
  if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
  const txt = (messageText.value||'').trim(); if(!txt) return;
  try{ await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text: txt, sticker:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false }); await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: txt, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); messageText.value = ''; } catch(e){ console.error('sendText err', e); if(e.code === 'permission-denied') showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π'); else showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}

async function sendSticker(st){ if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç'); try{ await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text:'', sticker:st, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false }); await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: '[–°—Ç–∏–∫–µ—Ä]', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); } catch(e){ console.error('sendSticker err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞'); } }

/* ----------------- mark read ----------------- */
async function markMessagesReadFirebase(chatId){
  if(!profile) return;
  try{ const q = await fbDb.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.login).where('readAt','==', null).get(); const batch = fbDb.batch(); q.forEach(docSnap => batch.update(docSnap.ref, { readAt: firebase.firestore.FieldValue.serverTimestamp() }) ); await batch.commit(); } catch(e){ console.error('mark read err', e); }
}

/* ----------------- view profile by login ----------------- */
async function viewProfileByLogin(login){
  try{ const snap = await fbDb.collection('users').where('login','==', login).limit(1).get(); if(snap.empty) return showToast('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); const d = snap.docs[0].data(); alert(`–ü—Ä–æ—Ñ–∏–ª—å:\n–ò–º—è: ${d.name || '-'}\n–õ–æ–≥–∏–Ω: ${d.login}\n–û —Å–µ–±–µ: ${d.about || '-'}\nEmail: ${d.email || '-'}`); } catch(e){ console.error('viewProfile err', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è'); }
}

/* ----------------- clear chat UI (fix half-chat bug) ----------------- */
function clearChatUI(){ if(listeners.messages){ try{ listeners.messages(); } catch(e){} listeners.messages = null; } activeChatId = null; activeChatOther = null; composer.style.display = 'none'; chatHeader.style.display = 'none'; messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ $–ª–æ–≥–∏–Ω—É</div>'; try{ messagesDiv.scrollTop = 0; } catch(e){} if(window.innerWidth < 720) leftPane.style.display = 'block'; }
backBtn.addEventListener('click', ()=> clearChatUI());

/* ----------------- auth state init ----------------- */
loadTheme();
renderStickers();

fbAuth.onAuthStateChanged(async (user)=>{
  if(user){
    me = user;
    console.log('onAuthStateChanged: user', user.uid);
    await loadProfile(user.uid);
    if(profile && profile.login) await subscribeChats();
    closeModal(modalLogin);
  } else {
    me = null; profile = null;
    openModal(modalLogin);
    clearChatUI();
  }
});

/* cleanup on unload */
window.addEventListener('beforeunload', ()=>{ if(listeners.chats) try{ listeners.chats(); } catch(e){} if(listeners.messages) try{ listeners.messages(); } catch(e){} });

/* small ui helpers */
menuBtn.addEventListener('click', ()=> openDrawer());
document.querySelectorAll('.modal-back').forEach(el=> el.addEventListener('click', (ev)=>{ if(ev.target === el) el.style.display='none'; }));
document.getElementById('openProfileBtn').addEventListener('click', ()=> { drawer.classList.remove('open'); overlay.classList.remove('show'); openProfileEditor(); });
document.getElementById('openSettingsBtn').addEventListener('click', ()=> { openSettings(); });
document.getElementById('walletBtn').addEventListener('click', ()=> showToast('–ö–æ—à–µ–ª—ë–∫ –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ ‚Äî —Å–ª–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'));
function openProfileEditor(){ if(!profile) return openModal(modalLogin); d_name.value = profile.name || ''; d_login.value = profile.login || ''; d_about.value = profile.about || ''; drawer.classList.add('open'); overlay.classList.add('show'); }
function openSettings(){ drawer.classList.add('open'); overlay.classList.add('show'); }
searchInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') newChatBtn.click(); });

/* focus hint */
setTimeout(()=> { try{ document.getElementById('loginEmail').focus(); } catch(e){} }, 250);

/* –í—Å—ë –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 3 —Ä–∞–∑–∞:
   - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã: localStorage, data-theme attribute, CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è --chat-text
   - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –±–µ–ª—ã–º–∏ (–≤–∫–ª—é—á–∞—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ div —Ç–µ–∫—Å—Ç–∞)
   - –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—á–∞—Ç—ã, —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø–∏—Å–∫–∞ listeners) –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
*/
</script>
</body>
</html>
