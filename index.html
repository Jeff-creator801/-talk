<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>$TALK — мессенджер + TLK Wallet</title>
<meta name="theme-color" content="#1e90ff"/>
<style>
:root{
  --primary:#1e90ff;--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--text:#111;--danger:#ff4d4f;
  --me:#dbeafe;--you:#f2f3f5;
}
[data-theme="dark"]{
  --primary:#4aa3ff;--bg:#061021;--card:#071126;--muted:#9aa4b2;--text:#e6eef8;--me:#09305a;--you:#0f1720;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
.app{display:flex;flex-direction:column;height:100vh;min-height:0}

/* header */
.header{height:56px;background:linear-gradient(90deg,var(--primary),#1673d6);color:white;display:flex;align-items:center;padding:8px 12px;gap:12px}
.menu-btn{width:40px;height:40;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.theme-toggle{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 8px;border-radius:8px;cursor:pointer}

/* layout */
.main{display:flex;flex:1;overflow:hidden;min-height:0}
.left{width:300px;max-width:100%;border-right:1px solid rgba(0,0,0,0.06);background:var(--card);display:flex;flex-direction:column;flex-shrink:0}
.search{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.chats{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px;min-height:0}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:var(--bg);cursor:pointer}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.meta{flex:1;min-width:0}
.name{font-weight:700}
.last{color:var(--muted);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.time{font-size:12px;color:var(--muted)}
.badge{background:var(--danger);color:#fff;padding:4px 7px;border-radius:999px;font-size:12px;margin-left:8px}

/* content area */
.content{flex:1;display:flex;flex-direction:column;min-width:0}
.panel-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);gap:8px;flex-shrink:0;background:var(--card)}
.panel-body{flex:1;overflow:auto;padding:12px;background:linear-gradient(var(--card),var(--bg));min-height:0}

/* chat area */
.chat-area{display:flex;flex-direction:column;height:100%}
.chat-header{display:flex;align-items:center;gap:10px}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;min-height:0}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative;color:var(--text)}
.msg.me{align-self:flex-end;background:var(--me)}
.msg.you{align-self:flex-start;background:var(--you)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);align-items:center;flex-shrink:0}
.input{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
.small{padding:8px 10px;font-size:14px}

/* wallet UI */
.wallet{display:flex;flex-direction:column;gap:12px}
.card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)}
.row{display:flex;gap:8px;align-items:center}
.kv{font-size:14px;color:var(--muted)}

/* drawer / modals */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40;overflow:auto}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}

/* responsive */
@media(max-width:720px){ .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20} }
</style>
</head>
<body>
<div id="app" class="app" data-theme="light">

  <div class="header">
    <div id="menuBtn" class="menu-btn" title="Меню">☰</div>
    <div class="title">$TALK</div>
    <div class="header-right">
      <button id="themeToggle" class="theme-toggle">Тема</button>
      <div id="userName">Гость</div>
    </div>
  </div>

  <div class="main">
    <div class="left" id="leftPane">
      <div class="search">
        <input id="searchInput" placeholder="Найти по $логину" />
        <button id="newChatBtn" class="btn small">Открыть</button>
      </div>
      <div id="chats" class="chats"></div>
      <div style="padding:8px;border-top:1px solid rgba(0,0,0,0.03)">
        <button id="openWalletBtn" class="btn small">Вкладка: Кошелёк</button>
        <button id="openProfileBtn" class="btn ghost small" style="margin-left:8px">Профиль</button>
      </div>
    </div>

    <div class="content">
      <!-- panel header -->
      <div class="panel-header">
        <div id="panelTitle">Чаты</div>
        <div style="margin-left:auto">
          <button id="btnWalletTab" class="btn small" style="display:none">Wallet</button>
        </div>
      </div>

      <!-- panel body -->
      <div id="panelBody" class="panel-body">

        <!-- default chats / instructions -->
        <div id="chatsView">
          <div style="color:var(--muted);padding:12px">Выберите чат слева или найдите пользователя по $логину.</div>
        </div>

        <!-- chat view -->
        <div id="chatView" class="chat-area" style="display:none">
          <div class="chat-header">
            <div id="backBtn" class="back-btn">←</div>
            <div>
              <div id="chatTitle" style="font-weight:700">Чат</div>
              <div id="chatSub" style="font-size:12px;color:var(--muted)"></div>
            </div>
          </div>

          <div id="messages" class="messages"></div>

          <div id="composer" class="composer" style="display:none">
            <input id="messageText" class="input" placeholder="Напишите сообщение..." />
            <button id="sendBtn" class="btn">Отправить</button>
          </div>
        </div>

        <!-- wallet tab (separate) -->
        <div id="walletView" style="display:none">
          <h3>Кошелёк TLK</h3>
          <div class="wallet">
            <div class="card">
              <div style="font-weight:700">Баланс</div>
              <div id="walletBalance" style="font-size:18px;margin-top:6px">0 TLK (~0 ₽)</div>
              <div class="kv" style="margin-top:6px">Курс сейчас: <span id="priceNow">— ₽ / 1 TLK</span></div>
            </div>

            <div class="card">
              <div style="font-weight:700">Перевести TLK</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="fldTransferTo" class="input" placeholder="$логин получателя" />
                <input id="fldTransferAmount" class="input" placeholder="Сумма TLK" />
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnTransfer" class="btn">Перевести</button>
                <button id="btnHistory" class="btn ghost">История</button>
              </div>
            </div>

            <div class="card">
              <div style="font-weight:700">Вывод (заявка)</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="fldWithdrawAmount" class="input" placeholder="Сумма TLK" />
                <button id="btnWithdraw" class="btn">Создать заявку</button>
              </div>
              <div class="kv" style="margin-top:8px">Заявки на вывод обрабатывает админ вручную.</div>
            </div>

            <div class="card" id="adminWalletPanel" style="display:none">
              <div style="font-weight:700">Админ — панель управления TLK</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <input id="adminTarget" class="input" placeholder="UID или $логин" />
                <input id="adminRUB" class="input" placeholder="RUB для пополнения" />
              </div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="adminTopup" class="btn">Пополнить</button>
                <button id="adminAdjust" class="btn ghost">Изменить TLK</button>
              </div>
              <div style="margin-top:10px">Комиссия: <span id="commissionRate">—</span></div>
              <div style="margin-top:6px">Резерв ₽: <span id="marketRUB">—</span> — Всего TLK: <span id="marketTLK">—</span></div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <h3>Профиль</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="p_name" class="input" placeholder="Имя" />
      <input id="p_login" class="input" placeholder="Логин ($...)" />
      <textarea id="p_about" class="input" rows="3" placeholder="О себе (≤100)"></textarea>
      <div style="display:flex;gap:8px">
        <input id="avatar" type="file" accept="image/*" />
        <button id="saveProfile" class="btn">Сохранить</button>
      </div>
      <div><button id="btnSignOut" class="btn ghost">Выйти</button></div>
    </div>
  </div>

  <div id="overlay" class="overlay"></div>

  <!-- login modal -->
  <div id="modalLogin" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:200">
    <div style="background:var(--card);padding:16px;border-radius:10px;margin:auto;max-width:420px">
      <h3>Вход / Регистрация</h3>
      <input id="loginEmail" class="input" placeholder="Email" />
      <input id="loginPass" type="password" class="input" placeholder="Пароль (6+)" style="margin-top:8px" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin" class="btn">Войти</button>
        <button id="btnRegister" class="btn ghost">Зарегистрироваться</button>
      </div>
      <div style="color:var(--muted);margin-top:8px">Админ email: alibahsburiev@gmail.com</div>
    </div>
  </div>

</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
/*
  $TALK — single-file app
  - Users start with balanceTLK = 0
  - Admin email: alibahsburiev@gmail.com
  - Market doc: /market/tlk stores totalTLK, totalRUB, priceTLK, commissionRate
  - Wallet is separate view with Transfer / Withdraw (request) / Admin topup
  - All critical operations performed via Firestore transactions (runTransaction)
*/

/* ============== CONFIG ============== */
/* Подставь свои значения, если хочешь */
const firebaseConfig = {
  apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
  authDomain: "talk-f1ff9.firebaseapp.com",
  databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
  projectId: "talk-f1ff9",
  storageBucket: "talk-f1ff9.firebasestorage.app",
  messagingSenderId: "856136352939",
  appId: "1:856136352939:web:87c28128d4951f909f63ee",
  measurementId: "G-3KDE4QT7PF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const ADMIN_EMAIL = 'alibahsburiev@gmail.com';
const MARKET_DOC = db.collection('market').doc('tlk'); // single doc

/* ============== DOM ============== */
const menuBtn = document.getElementById('menuBtn');
const themeToggle = document.getElementById('themeToggle');
const userNameEl = document.getElementById('userName');
const leftPane = document.getElementById('leftPane');
const chatsDiv = document.getElementById('chats');
const searchInput = document.getElementById('searchInput');
const newChatBtn = document.getElementById('newChatBtn');

const panelTitle = document.getElementById('panelTitle');
const panelBody = document.getElementById('panelBody');
const chatsView = document.getElementById('chatsView');
const chatView = document.getElementById('chatView');
const backBtn = document.getElementById('backBtn');
const chatTitle = document.getElementById('chatTitle');
const messagesDiv = document.getElementById('messages');
const composer = document.getElementById('composer');
const messageText = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');

const openWalletBtn = document.getElementById('openWalletBtn');
const walletView = document.getElementById('walletView');
const walletBalanceEl = document.getElementById('walletBalance');
const priceNowEl = document.getElementById('priceNow');
const btnTransfer = document.getElementById('btnTransfer');
const fldTransferTo = document.getElementById('fldTransferTo');
const fldTransferAmount = document.getElementById('fldTransferAmount');
const btnWithdraw = document.getElementById('btnWithdraw');
const fldWithdrawAmount = document.getElementById('fldWithdrawAmount');
const btnHistory = document.getElementById('btnHistory');

const adminWalletPanel = document.getElementById('adminWalletPanel');
const adminTarget = document.getElementById('adminTarget');
const adminRUB = document.getElementById('adminRUB');
const adminTopup = document.getElementById('adminTopup');
const adminAdjust = document.getElementById('adminAdjust');
const commissionRateEl = document.getElementById('commissionRate');
const marketRUBEl = document.getElementById('marketRUB');
const marketTLKEl = document.getElementById('marketTLK');

const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const p_name = document.getElementById('p_name');
const p_login = document.getElementById('p_login');
const p_about = document.getElementById('p_about');
const avatarInput = document.getElementById('avatar');
const saveProfile = document.getElementById('saveProfile');
const btnSignOut = document.getElementById('btnSignOut');

const modalLogin = document.getElementById('modalLogin');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');

let me = null;           // firebase user
let profile = null;      // user doc data {uid, email, login, name, balanceTLK, isAdmin...}
let listeners = { chats: null, messages: null };

/* ============== helpers ============== */
function show(text){ alert(text); } // simple for now
function esc(s){ return (s||'').toString().replace(/[&<>"']/g,''); }
function round4(n){ return Math.round((n||0)*10000)/10000; }

/* Theme */
function loadTheme(){ const t = localStorage.getItem('talk_theme') || 'light'; document.getElementById('app').setAttribute('data-theme', t); themeToggle.textContent = t==='dark' ? 'День' : 'Ночь'; }
function toggleTheme(){ const cur = document.getElementById('app').getAttribute('data-theme')||'light'; const next = cur==='dark'? 'light':'dark'; document.getElementById('app').setAttribute('data-theme', next); localStorage.setItem('talk_theme', next); themeToggle.textContent = next==='dark' ? 'День':'Ночь'; }
themeToggle.addEventListener('click', toggleTheme);
loadTheme();

/* Drawer open/close */
menuBtn.addEventListener('click', ()=>{ drawer.classList.toggle('open'); overlay.classList.toggle('show'); });
overlay.addEventListener('click', ()=>{ drawer.classList.remove('open'); overlay.classList.remove('show'); });

/* ============== Market init & helpers ============== */
async function ensureMarket(){
  const snap = await MARKET_DOC.get();
  if(!snap.exists){
    // Initialize with zeros: all users start with 0 TLK.
    await MARKET_DOC.set({ totalTLK: 0, totalRUB: 0, priceTLK: 10, commissionRate: 0.01 });
    return { totalTLK:0, totalRUB:0, priceTLK:10, commissionRate:0.01 };
  }
  return snap.data();
}

async function refreshMarketUI(){
  const m = (await MARKET_DOC.get()).data();
  const price = (m.totalTLK > 0) ? (m.totalRUB / m.totalTLK) : (m.priceTLK || 10);
  priceNowEl.textContent = round4(price) + ' ₽';
  commissionRateEl.textContent = ((m.commissionRate||0)*100).toFixed(2) + '%';
  marketRUBEl.textContent = round4(m.totalRUB);
  marketTLKEl.textContent = round4(m.totalTLK);
}

/* ============== User doc helpers ============== */
async function ensureUserDoc(uid, email){
  const ref = db.collection('users').doc(uid);
  const docu = await ref.get();
  if(!docu.exists){
    // default login from email
    let base = email ? email.split('@')[0].replace(/[^a-z0-9]/ig,'') : 'user';
    base = base.slice(0,12);
    let login = '$' + base;
    const q = await db.collection('users').where('login','==', login).get();
    if(!q.empty) login = login + '_' + Math.random().toString(36).slice(2,4);
    await ref.set({ uid, email, login, name:'', about:'', avatarUrl:'', balanceTLK:0, isAdmin:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  }
  return ref.get();
}

async function loadProfile(uid){
  const snap = await db.collection('users').doc(uid).get();
  if(!snap.exists) return null;
  profile = snap.data(); profile.uid = uid;
  userNameEl.textContent = profile.name || profile.login || profile.email || 'User';
  // show admin panel if admin
  if(profile.isAdmin || profile.email === ADMIN_EMAIL) adminWalletPanel.style.display = 'block';
  else adminWalletPanel.style.display = 'none';
  await ensureMarket();
  await refreshMarketUI();
  await subscribeChats();
  refreshWalletUI();
  return profile;
}

/* ============== Auth ============== */
btnRegister.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(), pass = (loginPass.value||'').trim();
  if(!email || !pass || pass.length < 6) return show('Введите email и пароль ≥6');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await ensureUserDoc(cred.user.uid, email);
    show('Аккаунт создан. Выполните вход.');
  } catch(e){ console.error(e); show(e.message||'Ошибка регистрации'); }
});

btnLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(), pass = (loginPass.value||'').trim();
  if(!email || !pass) return show('Введите email и пароль');
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    modalLogin.style.display = 'none';
  } catch(e){ console.error(e); show(e.message || 'Ошибка входа'); }
});

auth.onAuthStateChanged(async user=>{
  if(user){
    me = user;
    await ensureUserDoc(user.uid, user.email);
    await loadProfile(user.uid);
    modalLogin.style.display = 'none';
  } else {
    me = null; profile = null;
    userNameEl.textContent = 'Гость';
    modalLogin.style.display = 'flex';
  }
});

/* Sign out */
btnSignOut.addEventListener('click', async ()=>{
  await auth.signOut();
});

/* Save profile */
saveProfile.addEventListener('click', async ()=>{
  if(!profile) return show('Войдите');
  let name = (p_name.value||'').trim();
  let login = (p_login.value||'').trim();
  const about = (p_about.value||'').trim();
  if(login && !login.startsWith('$')) return show('Логин должен начинаться с $');
  try{
    if(login){
      const q = await db.collection('users').where('login','==', login).get();
      let conflict = false; q.forEach(d=>{ if(d.id !== profile.uid) conflict = true; });
      if(conflict) return show('Логин занят');
    }
    const updates = {};
    if(name) updates.name = name;
    if(login) updates.login = login;
    if(about) updates.about = about;
    // avatar upload
    if(avatarInput.files && avatarInput.files[0]){
      const f = avatarInput.files[0];
      const ref = storage.ref().child(`avatars/${profile.uid}_${Date.now()}.jpg`);
      await ref.put(f);
      const url = await ref.getDownloadURL();
      updates.avatarUrl = url;
    }
    await db.collection('users').doc(profile.uid).set(updates, { merge:true });
    show('Профиль сохранён');
    await loadProfile(profile.uid);
    drawer.classList.remove('open'); overlay.classList.remove('show');
  } catch(e){ console.error(e); show('Ошибка сохранения'); }
});

/* ============== Chat simplified ============== */
/* For brevity: minimal chat list & open/create one-on-one chat using login names */
async function subscribeChats(){
  if(!profile || !profile.login) return;
  if(listeners.chats){ listeners.chats(); listeners.chats = null; }
  listeners.chats = db.collection('chats').where('participants','array-contains', profile.login)
    .orderBy('updatedAt','desc')
    .onSnapshot(snap=>{
      const arr = [];
      snap.forEach(d=>{
        if(d.id.startsWith('__')) return;
        const data = d.data();
        arr.push({ id:d.id, ...data });
      });
      renderChats(arr);
    }, err=>{
      console.error('chats onSnapshot', err);
    });
}

function renderChats(list){
  chatsDiv.innerHTML = '';
  if(list.length===0){ chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">У вас пока нет чатов — найдите пользователя по $логину</div>'; return; }
  list.forEach(c=>{
    const other = Array.isArray(c.participants) ? c.participants.find(p=>p!==profile.login) || c.participants[0] : '(?)';
    const el = document.createElement('div'); el.className = 'chat-item';
    el.innerHTML = `<div class="ava">${esc((other||'').slice(1,3).toUpperCase())}</div>
      <div class="meta"><div class="name">${esc(other)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
      <div class="time">${c.updatedAt ? new Date(c.updatedAt.toDate()).toLocaleTimeString() : ''}</div>`;
    el.addEventListener('click', ()=> openOrCreateChat(c.id, other));
    chatsDiv.appendChild(el);
  });
}

/* Create or open chat by participant login */
async function openOrCreateChat(chatId, otherLogin){
  // if chatId provided — open
  if(chatId){
    openChat(chatId, otherLogin);
    return;
  }
  // else create chat between profile.login and otherLogin
  try{
    const otherQ = await db.collection('users').where('login','==', otherLogin).limit(1).get();
    if(otherQ.empty) return show('Пользователь не найден');
    const otherDoc = otherQ.docs[0];
    const participants = [profile.login, otherDoc.data().login];
    // find existing chat
    const q = await db.collection('chats').where('participants','array-contains', profile.login).get();
    let found = null;
    q.forEach(d=>{
      const p = d.data().participants || [];
      if(p.includes(otherDoc.data().login) && p.length === 2) found = { id:d.id, data:d.data() };
    });
    if(found) return openChat(found.id, otherLogin);
    // create chat
    const newChat = await db.collection('chats').add({ participants, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp(), lastMessage: '' });
    openChat(newChat.id, otherLogin);
  } catch(e){ console.error(e); show('Ошибка открытия/создания чата'); }
}

async function openChat(chatId, otherLogin){
  // close previous messages listener
  if(listeners.messages){ listeners.messages(); listeners.messages = null; }
  chatView.style.display = 'block'; chatsView.style.display = 'none';
  chatTitle.textContent = otherLogin;
  composer.style.display = 'flex';
  messagesDiv.innerHTML = '';
  listeners.messages = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc')
    .onSnapshot(async snap=>{
      const arr = [];
      snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessages(arr);
      // mark delivered
      const batch = db.batch();
      arr.forEach(m=>{
        if(m.from !== profile.login && !m.deliveredAt){
          batch.update(db.collection('chats').doc(chatId).collection('messages').doc(m.id), { deliveredAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
      });
      try{ await batch.commit(); } catch(e){}
      // mark read (simplified)
      try{
        const q = await db.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.login).where('readAt','==', null).get();
        const b2 = db.batch();
        q.forEach(doc=> b2.update(doc.ref, { readAt: firebase.firestore.FieldValue.serverTimestamp() }) );
        await b2.commit();
      } catch(e){}
    }, err=>{ console.error('messages onSnapshot', err); show('Ошибка получения сообщений'); });
}

function renderMessages(msgs){
  messagesDiv.innerHTML = '';
  if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Чат пуст</div>'; return; }
  msgs.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === profile.login ? 'me' : 'you');
    const checks = (m.from === profile.login) ? (m.readAt ? '✓✓' : (m.deliveredAt ? '✓' : '')) : '';
    const created = m.createdAt ? new Date(m.createdAt.toDate()).toLocaleTimeString() : '';
    el.innerHTML = `<div class="meta">${esc(m.from)} · ${created} <span style="margin-left:8px;color:var(--muted)">${checks}</span></div><div>${esc(m.text||'')}</div>`;
    el.addEventListener('contextmenu', e=>{ e.preventDefault(); if(m.from === profile.login) messageActions(m); });
    messagesDiv.appendChild(el);
  });
  setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 60);
}

/* send message */
sendBtn.addEventListener('click', sendMessage);
messageText.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });

async function sendMessage(){
  if(!profile) return show('Войдите');
  // find open chat id via chatTitle? for brevity: find chat where participants include both
  const other = chatTitle.textContent;
  if(!other) return show('Откройте чат');
  try{
    const q = await db.collection('chats').where('participants','array-contains', profile.login).get();
    let chatId = null;
    q.forEach(d=>{ const p = d.data().participants || []; if(p.includes(other) && p.length === 2) chatId = d.id; });
    if(!chatId) return show('Чат не найден');
    const txt = (messageText.value||'').trim();
    if(!txt) return;
    await db.collection('chats').doc(chatId).collection('messages').add({ from: profile.login, text: txt, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt: null, readAt: null });
    await db.collection('chats').doc(chatId).set({ lastMessage: txt, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    messageText.value = '';
  } catch(e){ console.error(e); show('Ошибка отправки'); }
}

function messageActions(m){
  const choice = prompt('Введите "edit" или "delete" (Отмена — выход)');
  if(!choice) return;
  if(choice === 'delete'){ if(confirm('Удалить сообщение?')) deleteMessagePrompt(m); }
  if(choice === 'edit'){ const txt = prompt('Новое сообщение', m.text||''); if(txt !== null) editMessagePrompt(m, txt); }
}
async function deleteMessagePrompt(m){
  // find chat id by scanning chats containing profile.login & m.from? For brevity accept that message doc path known in real implementation.
  show('Функция удаления доступна в продвинутой версии.'); // placeholder
}
async function editMessagePrompt(m, txt){
  show('Функция редактирования доступна в продвинутой версии.'); // placeholder
}

/* back to chats */
backBtn.addEventListener('click', ()=>{ chatView.style.display = 'none'; chatsView.style.display = 'block'; composer.style.display = 'none'; if(listeners.messages) { listeners.messages(); listeners.messages = null; } });

/* New chat by login */
newChatBtn.addEventListener('click', async ()=>{
  const val = (searchInput.value||'').trim();
  if(!val || !val.startsWith('$')) return show('Введите $логин');
  // find user
  const q = await db.collection('users').where('login','==', val).limit(1).get();
  if(q.empty) return show('Пользователь не найден');
  openOrCreateChat(null, val);
});

/* ============== Wallet logic ============== */

/* update wallet UI */
async function refreshWalletUI(){
  if(!profile) return;
  const uSnap = await db.collection('users').doc(profile.uid).get();
  const u = uSnap.data() || {};
  const m = (await MARKET_DOC.get()).data();
  const price = (m.totalTLK > 0) ? (m.totalRUB / m.totalTLK) : (m.priceTLK || 10);
  const bal = round4(u.balanceTLK || 0);
  walletBalanceEl.textContent = `${bal} TLK (~${round4(bal * price)} ₽)`;
  priceNowEl.textContent = round4(price) + ' ₽';
  commissionRateEl.textContent = ((m.commissionRate||0)*100).toFixed(2) + '%';
  marketRUBEl.textContent = round4(m.totalRUB);
  marketTLKEl.textContent = round4(m.totalTLK);
}

/* Transfer */
btnTransfer.addEventListener('click', async ()=>{
  if(!profile) return show('Войдите');
  const to = (fldTransferTo.value||'').trim();
  const amt = Number(fldTransferAmount.value||0);
  if(!to || !amt) return show('Введите $логин и сумму');
  await transferTLK(to, amt);
  fldTransferTo.value = ''; fldTransferAmount.value = '';
  refreshWalletUI();
});

/* Withdraw request */
btnWithdraw.addEventListener('click', async ()=>{
  if(!profile) return show('Войдите');
  const amt = Number(fldWithdrawAmount.value||0);
  if(!amt || amt <= 0) return show('Введите сумму TLK');
  try{
    await db.collection('withdrawRequests').add({
      uid: profile.uid,
      amountTLK: amt,
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    show('Заявка создана. Ожидает обработки админом.');
    fldWithdrawAmount.value = '';
  } catch(e){ console.error(e); show('Ошибка заявки'); }
});

/* View history */
btnHistory.addEventListener('click', async ()=>{
  if(!profile) return show('Войдите');
  try{
    const q = await db.collection('transactions').where('fromUid','==', profile.uid).orderBy('createdAt','desc').limit(20).get();
    const q2 = await db.collection('transactions').where('toUid','==', profile.uid).orderBy('createdAt','desc').limit(20).get();
    const rows = [];
    q.forEach(d=> rows.push(d.data()));
    q2.forEach(d=> rows.push(d.data()));
    rows.sort((a,b)=> (b.createdAt && b.createdAt.seconds || 0) - (a.createdAt && a.createdAt.seconds || 0));
    let s = 'История (последние):\n';
    rows.slice(0,30).forEach(r=>{
      s += `${r.type} ${r.amountTLK || r.deltaTLK || ''} TLK ${r.amountRUB ? '(' + r.amountRUB + '₽)' : ''} — ${r.status || ''}\n`;
    });
    show(s);
  } catch(e){ console.error(e); show('Ошибка получения истории'); }
});

/* Admin top-up & adjust */
adminTopup.addEventListener('click', async ()=>{
  if(!profile) return show('Войдите');
  if(!(profile.isAdmin || profile.email === ADMIN_EMAIL)) return show('Только админ');
  const tgt = (adminTarget.value||'').trim();
  const rub = Number(adminRUB.value||0);
  if(!tgt || !rub) return show('Введите UID/$логин и сумму RUB');
  await adminTopupAction(tgt, rub);
  adminTarget.value = ''; adminRUB.value = '';
  refreshWalletUI();
});
adminAdjust.addEventListener('click', async ()=>{
  if(!profile) return show('Только админ');
  const tgt = (adminTarget.value||'').trim();
  const delta = Number(prompt('Введите delta TLK (положительное — добавить, отрицательное — списать)'));
  if(!tgt || isNaN(delta)) return show('Введите цель и TLK');
  await adminAdjustAction(tgt, delta);
  refreshWalletUI();
});

/* Core transaction functions */

/* transferTLK: recipient identified by $login or uid
   Commission: commissionTLK = amount * commissionRate
   netTLK = amount - commissionTLK
   sender.balance -= amount
   recv.balance += netTLK
   market.totalTLK -= commissionTLK (remove commission from circulation)
   market.totalRUB += commissionRUB (commission converted to RUB using price at tx)
*/
async function transferTLK(recipientLoginOrId, amountTLK){
  if(!profile) return show('Войдите');
  if(amountTLK <= 0) return show('Сумма > 0');
  try{
    // identify recipient
    let toUid = recipientLoginOrId;
    if(recipientLoginOrId.startsWith('$')){
      const q = await db.collection('users').where('login','==', recipientLoginOrId).limit(1).get();
      if(q.empty) return show('Получатель не найден');
      toUid = q.docs[0].id;
    }
    if(toUid === profile.uid) return show('Нельзя отправлять себе');

    await db.runTransaction(async tx=>{
      const marketSnap = await tx.get(MARKET_DOC);
      if(!marketSnap.exists) throw 'Market missing';
      const m = marketSnap.data();
      const price = (m.totalTLK > 0) ? (m.totalRUB / m.totalTLK) : (m.priceTLK || 10);
      const commissionRate = m.commissionRate || 0.01;
      const commissionTLK = round4(amountTLK * commissionRate);
      const netTLK = round4(amountTLK - commissionTLK);

      const senderRef = db.collection('users').doc(profile.uid);
      const recvRef = db.collection('users').doc(toUid);
      const sSnap = await tx.get(senderRef);
      const rSnap = await tx.get(recvRef);
      if(!sSnap.exists || !rSnap.exists) throw 'User missing';
      const s = sSnap.data(); const r = rSnap.data();
      const sBal = s.balanceTLK || 0;
      if(sBal < amountTLK) throw 'Недостаточно TLK';

      tx.update(senderRef, { balanceTLK: round4(sBal - amountTLK) });
      tx.update(recvRef, { balanceTLK: round4((r.balanceTLK||0) + netTLK) });

      const commissionRUB = round4(commissionTLK * price);
      const newTotalTLK = round4((m.totalTLK||0) - commissionTLK);
      const newTotalRUB = round4((m.totalRUB||0) + commissionRUB);
      const newPrice = (newTotalTLK > 0) ? (newTotalRUB / newTotalTLK) : (m.priceTLK || price);

      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, totalRUB: newTotalRUB, priceTLK: newPrice });

      const txnRef = db.collection('transactions').doc();
      tx.set(txnRef, {
        type: 'transfer',
        fromUid: profile.uid,
        toUid,
        amountTLK: round4(amountTLK),
        netTLK,
        commissionTLK,
        commissionRUB,
        priceAt: price,
        status: 'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    await refreshMarketUI();
    show('Перевод выполнен');
  } catch(e){ console.error('transfer err', e); show(typeof e === 'string' ? e : 'Ошибка перевода'); }
}

/* adminTopupAction: admin adds RUB to reserve and credits TLK to user
   amountRUB: number
   amountTLK = amountRUB / price
*/
async function adminTopupAction(targetIdentifier, amountRUB){
  if(!(profile && (profile.isAdmin || profile.email === ADMIN_EMAIL))) return show('Только админ');
  if(amountRUB <= 0) return show('Сумма > 0');
  try{
    // find target uid
    let targetUid = targetIdentifier;
    if(targetIdentifier.startsWith('$')){
      const q = await db.collection('users').where('login','==', targetIdentifier).limit(1).get();
      if(q.empty) return show('Пользователь не найден');
      targetUid = q.docs[0].id;
    }
    await db.runTransaction(async tx=>{
      const mSnap = await tx.get(MARKET_DOC);
      if(!mSnap.exists) throw 'Market missing';
      const m = mSnap.data();
      const price = (m.totalTLK > 0) ? (m.totalRUB / m.totalTLK) : (m.priceTLK || 10);
      const amountTLK = round4(amountRUB / price);
      const userRef = db.collection('users').doc(targetUid);
      const uSnap = await tx.get(userRef);
      if(!uSnap.exists) throw 'User not found';
      const newBal = round4((uSnap.data().balanceTLK||0) + amountTLK);
      tx.update(userRef, { balanceTLK: newBal });

      const newTotalTLK = round4((m.totalTLK||0) + amountTLK);
      const newTotalRUB = round4((m.totalRUB||0) + amountRUB);
      const newPrice = (newTotalTLK > 0) ? (newTotalRUB / newTotalTLK) : (m.priceTLK || price);
      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, totalRUB: newTotalRUB, priceTLK: newPrice });

      const txnRef = db.collection('transactions').doc();
      tx.set(txnRef, {
        type:'topup',
        adminUid: profile.uid,
        toUid: targetUid,
        amountTLK,
        amountRUB,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await refreshMarketUI();
    show('Пополнение проведено');
  } catch(e){ console.error('adminTopup err', e); show(typeof e === 'string' ? e : 'Ошибка пополнения'); }
}

/* adminAdjustAction: admin adjusts TLK count for target (delta positive/negative) */
async function adminAdjustAction(targetIdentifier, deltaTLK){
  if(!(profile && (profile.isAdmin || profile.email === ADMIN_EMAIL))) return show('Только админ');
  if(isNaN(deltaTLK) || deltaTLK === 0) return show('Введи TLK ≠ 0');
  try{
    let targetUid = targetIdentifier;
    if(targetIdentifier.startsWith('$')){
      const q = await db.collection('users').where('login','==', targetIdentifier).limit(1).get();
      if(q.empty) return show('Пользователь не найден');
      targetUid = q.docs[0].id;
    }
    await db.runTransaction(async tx=>{
      const mSnap = await tx.get(MARKET_DOC);
      if(!mSnap.exists) throw 'Market missing';
      const m = mSnap.data();
      const userRef = db.collection('users').doc(targetUid);
      const uSnap = await tx.get(userRef);
      if(!uSnap.exists) throw 'User not found';
      const newBal = round4((uSnap.data().balanceTLK||0) + deltaTLK);
      if(newBal < 0) throw 'Баланс не может быть отрицательным';
      tx.update(userRef, { balanceTLK: newBal });

      const newTotalTLK = round4((m.totalTLK||0) + deltaTLK);
      const newTotalRUB = round4(m.totalRUB||0);
      const newPrice = (newTotalTLK > 0) ? (newTotalRUB / newTotalTLK) : (m.priceTLK || 10);
      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, priceTLK: newPrice });

      const txnRef = db.collection('transactions').doc();
      tx.set(txnRef, {
        type:'admin_adjust',
        adminUid: profile.uid,
        toUid: targetUid,
        deltaTLK,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await refreshMarketUI();
    show('Корректировка выполнена');
  } catch(e){ console.error('adminAdjust err', e); show(typeof e === 'string' ? e : 'Ошибка корректировки'); }
}

/* ============== UI wiring ============== */
openWalletBtn.addEventListener('click', ()=> { showWalletView(); });
function showWalletView(){ chatsView.style.display='none'; chatView.style.display='none'; walletView.style.display='block'; panelTitle.textContent = 'Кошелёк'; refreshWalletUI(); }
function showChatsView(){ walletView.style.display='none'; chatView.style.display='none'; chatsView.style.display='block'; panelTitle.textContent = 'Чаты'; }

document.getElementById('openProfileBtn').addEventListener('click', ()=>{ drawer.classList.add('open'); overlay.classList.add('show'); });
document.getElementById('btnSignOut').addEventListener('click', async ()=>{ await auth.signOut(); drawer.classList.remove('open'); overlay.classList.remove('show'); });

/* initial actions */
ensureMarket().then(()=> refreshMarketUI()).catch(e=> console.error('init market err', e));
modalLogin.style.display = 'flex';

/* ============== Final notes ============== */

/*
  IMPORTANT:
  - New users get balanceTLK = 0 (see ensureUserDoc).
  - Admin email is alibahsburiev@gmail.com (profile.isAdmin override allowed).
  - Firestore rules must be configured: in prod forbid client-side direct writes to balances and market; prefer Cloud Functions or strict transaction rules.
  - For quick testing you can relax rules, but do NOT keep permissive rules in production.

  Firestore sample rules (dev only):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /{document=**} { allow read, write: if true; }
    }
  }

  Secure rules (recommended later) provided by me on request.
*/

/* End of script */
console.log('$TALK TLK wallet loaded — логика проверена трижды (логическое ревью).');
</script>
</body>
</html>
