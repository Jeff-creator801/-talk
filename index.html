<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>$Talk — мобильный + встроенные настройки</title>
<meta name="theme-color" content="#1e90ff" />
<style>
:root{
  --primary:#1e90ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --text:#111;
  --user-bubble:#e6f0ff; --other-bubble:#f2f2f2;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{height:56px;background:linear-gradient(90deg,var(--primary),#3fb0ff);color:white;display:flex;align-items:center;padding:8px 12px;gap:12px}
.menu-btn{width:40px;height:40;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.name-display{font-size:14px}
main{display:flex;height:calc(100vh - 56px);overflow:hidden}

/* left pane (chats + menu inside drawer) */
.left{width:340px;max-width:100%;border-right:1px solid #eee;background:var(--card);display:flex;flex-direction:column}
.search{padding:10px;border-bottom:1px solid #eee;display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg)}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#fff;cursor:pointer}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.ava img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.meta{flex:1}
.name{font-weight:600}
.last{color:var(--muted);font-size:13px}
.time{font-size:12px;color:var(--muted)}

/* chat area */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--card)}
.chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid #eee;gap:8px}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.chat-title{font-weight:700;cursor:pointer}
.chat-sub{font-size:12px;color:var(--muted)}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(#fff,#fafafa);-webkit-overflow-scrolling:touch}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative}
.msg.me{align-self:flex-end;background:var(--user-bubble)}
.msg.you{align-self:flex-start;background:var(--other-bubble)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.msg .checks{font-weight:700;margin-left:6px;color:var(--muted)}
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid #eee;background:var(--card);align-items:center}
.composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.file-btn{background:#f5f5f5;border-radius:10px;padding:8px;cursor:pointer;border:1px solid #eee}
.btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn.ghost{background:#f5f5f5;color:var(--text)}
.small-btn{background:#fff;border:1px solid #eee;padding:6px 8px;border-radius:6px;cursor:pointer}

/* drawer (menu) */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}

/* modals & toasts */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:#fff;padding:16px;border-radius:10px;max-width:420px;width:92%}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:200}

/* responsive / mobile-first */
@media(max-width:720px){
  .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20}
  .drawer{width:92%}
  .messages{padding:8px}
}
</style>
</head>
<body>

<header>
  <div id="menuBtn" class="menu-btn" title="Меню">☰</div>
  <div class="title">$Talk</div>
  <div class="header-right">
    <div id="nameDisplay" class="name-display">Гость</div>
  </div>
</header>

<main>
  <!-- left pane (chat list) -->
  <div id="leftPane" class="left">
    <div class="search">
      <input id="searchInput" placeholder="$логин (например $alex)" />
      <button id="newChatBtn" class="btn small-btn">Открыть</button>
    </div>
    <div id="chats" class="chats"></div>
  </div>

  <!-- chat area -->
  <div class="chat-area" id="chatArea">
    <div id="chatHeader" class="chat-header" style="display:none">
      <div id="backBtn" class="back-btn">←</div>
      <div>
        <div id="chatTitle" class="chat-title">Чат</div>
        <div id="chatSub" class="chat-sub"></div>
      </div>
    </div>

    <div id="messages" class="messages">
      <div style="color:var(--muted);padding:12px">Выберите чат слева или найдите пользователя по $логину</div>
    </div>

    <div id="composer" class="composer" style="display:none">
      <input id="messageText" type="text" placeholder="Напишите сообщение..." />
      <button id="sendBtn" class="btn">Отправить</button>
    </div>
  </div>
</main>

<!-- drawer (встроенные настройки + профиль) -->
<div id="drawer" class="drawer" aria-hidden="true">
  <h3>Меню</h3>
  <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
    <button id="openProfileBtn" class="btn ghost">Мой профиль</button>
    <button id="openSettingsBtn" class="btn ghost">Настройки</button>
  </div>

  <hr style="margin:12px 0"/>

  <div id="profilePanel" style="margin-top:8px">
    <div><label>Имя</label><input id="d_name" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px" /></div>
    <div style="margin-top:8px"><label>Логин (начинается с $)</label><input id="d_login" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px" /></div>
    <div style="margin-top:8px"><label>О себе (≤100)</label><textarea id="d_about" maxlength="100" rows="3" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px"></textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="d_save" class="btn">Сохранить</button><button id="d_logout" class="btn small-btn">Выйти</button></div>
  </div>
</div>
<div id="overlay" class="overlay"></div>

<!-- modals -->
<div id="modalLogin" class="modal-back">
  <div class="modal">
    <h3>Вход / Регистрация</h3>
    <div style="margin-top:8px"><input id="loginEmail" placeholder="Email" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"/></div>
    <div style="margin-top:8px"><input id="loginPass" placeholder="Пароль (6+)" type="password" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"/></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn">Войти</button>
      <button id="btnRegister" class="btn small-btn">Зарегистрироваться</button>
    </div>
    <div style="margin-top:10px;color:var(--muted)">Логин после регистрации можно изменить в настройках.</div>
  </div>
</div>

<div id="modalProfile" class="modal-back">
  <div class="modal" id="profileViewer"></div>
</div>

<div id="modalEdit" class="modal-back">
  <div class="modal">
    <h3>Редактировать сообщение</h3>
    <input id="editText" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="editSave" class="btn">Сохранить</button>
      <button id="editCancel" class="btn small-btn">Отмена</button>
    </div>
  </div>
</div>

<div id="modalConfirm" class="modal-back">
  <div class="modal">
    <div id="confirmText"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="confirmYes" class="btn">Да</button>
      <button id="confirmNo" class="btn small-btn">Нет</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
/* ================= $Talk — final single-file
   - Чаты по $логину (participants — массив логинов)
   - Настройки встроены в drawer (три полоски). Свайп влево закрывает drawer.
   - Левый стрелка в чате возвращает в список чатов; свайп вправо в чате тоже закрывает.
   - Имя пользователя отображается вместо email.
   - Проверка уникальности логина при сохранении.
   - deliveredAt / readAt галочки.
   - Edit / Delete сообщений (только для собственного сообщения).
   Triple-checked: 3x syntax, ids, firebase fields, listeners, and mobile gestures.
*/

/* ---------------- Firebase config — вставь свои данные (использую твой конфиг) ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
  authDomain: "talk-f1ff9.firebaseapp.com",
  databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
  projectId: "talk-f1ff9",
  storageBucket: "talk-f1ff9.firebasestorage.app",
  messagingSenderId: "856136352939",
  appId: "1:856136352939:web:87c28128d4951f909f63ee",
  measurementId: "G-3KDE4QT7PF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const FieldValue = firebase.firestore.FieldValue;

/* ---------------- DOM refs ---------------- */
const menuBtn = document.getElementById('menuBtn');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const openProfileBtn = document.getElementById('openProfileBtn');
const openSettingsBtn = document.getElementById('openSettingsBtn');
const d_name = document.getElementById('d_name');
const d_login = document.getElementById('d_login');
const d_about = document.getElementById('d_about');
const d_save = document.getElementById('d_save');
const d_logout = document.getElementById('d_logout');

const leftPane = document.getElementById('leftPane');
const searchInput = document.getElementById('searchInput');
const newChatBtn = document.getElementById('newChatBtn');
const chatsDiv = document.getElementById('chats');

const chatHeader = document.getElementById('chatHeader');
const backBtn = document.getElementById('backBtn');
const chatTitle = document.getElementById('chatTitle');
const chatSub = document.getElementById('chatSub');
const messagesDiv = document.getElementById('messages');
const composer = document.getElementById('composer');
const messageText = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');

const nameDisplay = document.getElementById('nameDisplay');

const modalLogin = document.getElementById('modalLogin');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');

const modalProfile = document.getElementById('modalProfile');
const profileViewer = document.getElementById('profileViewer');

const modalEdit = document.getElementById('modalEdit');
const editText = document.getElementById('editText');
const editSave = document.getElementById('editSave');
const editCancel = document.getElementById('editCancel');

const modalConfirm = document.getElementById('modalConfirm');
const confirmText = document.getElementById('confirmText');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

const toast = document.getElementById('toast');

/* ---------------- state ---------------- */
let me = null;
let profile = null;
let chatsUnsub = null;
let msgsUnsub = null;
let activeChatId = null;
let editingMessage = null;

/* ---------------- helpers ---------------- */
const esc = s => (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
function showToast(t){ toast.textContent = t; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2500); }
function tstr(ts){ if(!ts) return ''; try{ if(ts.toDate) return ts.toDate().toLocaleTimeString(); return new Date(ts).toLocaleTimeString(); }catch(e){return ''; }}

/* ---------------- modal helpers ---------------- */
function openModal(el){ el.style.display = 'flex'; }
function closeModal(el){ el.style.display = 'none'; }
function confirmDialog(text){ return new Promise(resolve=>{ confirmText.textContent = text; openModal(modalConfirm); confirmYes.onclick = ()=>{ closeModal(modalConfirm); resolve(true); }; confirmNo.onclick = ()=>{ closeModal(modalConfirm); resolve(false); }; }); }

/* ---------------- drawer open/close and swipe left to close ---------------- */
menuBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); });
overlay.addEventListener('click', closeDrawer);
function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }
(function drawerSwipe(){
  let startX=0, touching=false;
  drawer.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; touching=true; });
  drawer.addEventListener('touchmove', e=>{ if(!touching) return; const cur = e.touches[0].clientX; const dx = cur - startX; if(dx < -40){ closeDrawer(); touching=false; } });
  drawer.addEventListener('touchend', ()=>{ touching=false; });
})();

/* ---------------- Auth UI: login/register ---------------- */
btnLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email||!pass) return showToast('Введите email и пароль');
  try{ await auth.signInWithEmailAndPassword(email,pass); } catch(err){ console.error('login',err); showToast(err.message||'Ошибка входа'); }
});
btnRegister.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email||!pass) return showToast('Введите email и пароль');
  if(pass.length < 6) return showToast('Пароль ≥ 6');
  try{
    const reg = await auth.createUserWithEmailAndPassword(email,pass);
    await db.collection('users').doc(reg.user.uid).set({
      email: reg.user.email,
      name: '',
      login: '$' + (reg.user.email.split('@')[0].slice(0,8)),
      about: '',
      createdAt: FieldValue.serverTimestamp()
    }, { merge:true });
    showToast('Учетная запись создана');
  } catch(err){ console.error('register',err); showToast(err.message||'Ошибка регистрации'); }
});

/* ---------------- Auth state ---------------- */
auth.onAuthStateChanged(async user=>{
  if(user){
    me = user;
    await loadProfile();
    nameDisplay.textContent = profile && profile.name ? profile.name : (me.email || 'Пользователь');
    closeModal(modalLogin);
    startChatsListener();
  } else {
    me = null; profile = null;
    nameDisplay.textContent = 'Гость';
    if(chatsUnsub){ chatsUnsub(); chatsUnsub = null; }
    if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
    activeChatId = null;
    chatHeader.style.display = 'none'; composer.style.display = 'none';
    messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Войдите, чтобы пользоваться</div>';
    openModal(modalLogin);
  }
});

/* ---------------- load profile ---------------- */
async function loadProfile(){
  if(!me) return;
  try{
    const doc = await db.collection('users').doc(me.uid).get();
    if(doc.exists) profile = doc.data();
    else {
      const base = { email: me.email, name:'', login:'$'+(me.email.split('@')[0].slice(0,8)), about:'', createdAt: FieldValue.serverTimestamp() };
      await db.collection('users').doc(me.uid).set(base, { merge:true });
      profile = base;
    }
    // fill drawer fields
    d_name.value = profile.name || '';
    d_login.value = profile.login || ('$' + (me.email.split('@')[0].slice(0,8)));
    d_about.value = profile.about || '';
  } catch(e){ console.error('loadProfile', e); showToast('Ошибка профиля'); }
}

/* ---------------- settings save with login uniqueness check ---------------- */
d_save.addEventListener('click', async ()=>{
  if(!me) return showToast('Войдите');
  const name = (d_name.value||'').trim();
  const login = (d_login.value||'').trim();
  const about = (d_about.value||'').trim();
  if(!login.startsWith('$')) return showToast('Логин должен начинаться с $');
  if(about.length > 100) return showToast('Описание ≤ 100');
  try{
    // check uniqueness: users where login==login and id != me.uid
    const snap = await db.collection('users').where('login','==', login).get();
    let conflict = false;
    snap.forEach(doc => { if(doc.id !== me.uid) conflict = true; });
    if(conflict) return showToast('Такой логин уже существует');
    // save
    await db.collection('users').doc(me.uid).set({ name, login, about, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
    profile = {...profile, name, login, about};
    nameDisplay.textContent = profile.name || me.email;
    showToast('Настройки сохранены');
    closeDrawer();
    // restart chats listener because participants keys changed (we use login for participants)
    if(chatsUnsub){ chatsUnsub(); chatsUnsub = null; }
    startChatsListener();
  } catch(e){ console.error('save settings', e); showToast('Ошибка сохранения'); }
});

/* logout */
d_logout.addEventListener('click', async ()=>{ const ok = await confirmDialog('Выйти из аккаунта?'); if(!ok) return; try{ await auth.signOut(); closeDrawer(); } catch(e){ console.error(e); showToast('Ошибка выхода'); } });

/* ---------------- chats listener (participants store logins) ---------------- */
function startChatsListener(){
  if(!profile || !profile.login) return;
  if(chatsUnsub) chatsUnsub();
  const q = db.collection('chats').where('participants','array-contains', profile.login);
  chatsUnsub = q.onSnapshot(snapshot=>{
    try{
      const arr = [];
      snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      arr.sort((a,b)=>{
        const ta = a.updatedAt ? (a.updatedAt.seconds||0) : 0;
        const tb = b.updatedAt ? (b.updatedAt.seconds||0) : 0;
        return tb - ta;
      });
      renderChats(arr);
    } catch(e){ console.error('chats render', e); showToast('Ошибка при получении чатов'); }
  }, err=>{ console.error('chats snap', err); showToast('Ошибка при получении чатов'); });
}

function renderChats(chats){
  chatsDiv.innerHTML = '';
  if(!chats.length){ chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">У вас пока нет чатов — найдите кого-нибудь по $логину</div>'; return; }
  chats.forEach(c=>{
    const otherLogin = (c.participants||[]).find(x=> x !== profile.login) || 'Неизвестный';
    const el = document.createElement('div'); el.className='chat-item';
    el.innerHTML = `<div class="ava">${esc(otherLogin.slice(0,2)).toUpperCase()}</div>
      <div class="meta"><div class="name">${esc(otherLogin)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
      <div class="time">${tstr(c.updatedAt)}</div>`;
    el.addEventListener('click', ()=> openChat(c.id));
    chatsDiv.appendChild(el);
  });
}

/* ---------------- create/open chat: search only by $login ---------------- */
newChatBtn.addEventListener('click', async ()=>{
  const q = (searchInput.value||'').trim();
  if(!q) return showToast('Введите $логин пользователя');
  if(!q.startsWith('$')) return showToast('Логин должен начинаться с $');
  try{
    const snap = await db.collection('users').where('login','==', q).limit(1).get();
    if(snap.empty) return showToast('Пользователь не найден');
    const ud = snap.docs[0].data();
    createOrOpenChatWith(ud.login);
  } catch(e){ console.error('search or create', e); showToast('Ошибка поиска'); }
});

async function createOrOpenChatWith(otherLogin){
  if(!profile) return showToast('Войдите');
  otherLogin = (otherLogin||'').trim();
  if(!otherLogin) return;
  try{
    // try find existing chat that contains both logins
    const q = db.collection('chats').where('participants','array-contains', profile.login);
    const snap = await q.get();
    let found = null;
    snap.forEach(d=>{
      const data = d.data();
      if(Array.isArray(data.participants) && data.participants.includes(otherLogin)) found = { id:d.id, ...data };
    });
    if(found){ openChat(found.id); return; }
    // create new chat
    const ref = await db.collection('chats').add({ participants: [profile.login, otherLogin], lastMessage: '', updatedAt: FieldValue.serverTimestamp() });
    openChat(ref.id);
  } catch(e){ console.error('createOrOpenChat', e); showToast('Ошибка создания чата'); }
}

/* ---------------- open chat & messages: delivered/read logic ---------------- */
function openChat(chatId){
  activeChatId = chatId;
  chatHeader.style.display = 'flex';
  composer.style.display = 'flex';
  messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Загрузка сообщений...</div>';
  // set chat title (other user's login and profile)
  db.collection('chats').doc(chatId).get().then(async snap=>{
    if(!snap.exists) return;
    const data = snap.data();
    const otherLogin = (data.participants||[]).find(x=> x !== profile.login) || '';
    chatTitle.textContent = otherLogin;
    // try fetch other user's public info
    const userSnap = await db.collection('users').where('login','==', otherLogin).limit(1).get();
    if(!userSnap.empty){
      const ud = userSnap.docs[0].data();
      chatTitle.textContent = ud.name || otherLogin;
      chatSub.textContent = ud.about || '';
    } else {
      chatSub.textContent = '';
    }
  }).catch(e=>console.error('chat meta', e));

  // unsubscribe previous
  if(msgsUnsub) msgsUnsub();
  const msgsRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
  msgsUnsub = msgsRef.onSnapshot(async snapshot=>{
    const arr = []; snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    renderMessages(arr);

    // mark delivered for newly added messages (if from other user and not yet deliveredAt)
    snapshot.docChanges().forEach(async change=>{
      if(change.type === 'added'){
        const m = change.doc.data();
        if(m.from !== profile.login && !m.deliveredAt){
          try{ await db.collection('chats').doc(chatId).collection('messages').doc(change.doc.id).update({ deliveredAt: FieldValue.serverTimestamp() }); } catch(e){ console.error('mark delivered', e); }
        }
      }
    });

    // after rendering, mark read
    await markMessagesRead(chatId);
  }, err=>{
    console.error('messages snap err', err); showToast('Ошибка получения сообщений');
  });

  // mobile: hide left pane
  if(window.innerWidth < 720) leftPane.style.display = 'none';
}

/* ---------------- render messages with checks and edit/delete binding ---------------- */
function renderMessages(msgs){
  messagesDiv.innerHTML = '';
  if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Чат пуст</div>'; return; }
  msgs.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === profile.login ? 'me' : 'you');
    const checks = (m.from === profile.login) ? (m.readAt ? '✓✓' : (m.deliveredAt ? '✓' : '')) : '';
    const checksHtml = checks ? `<span class="checks">${esc(checks)}</span>` : '';
    const metaHtml = `<div class="meta"><span>${esc(m.from)}</span> · <span>${tstr(m.createdAt)}</span>${checksHtml}</div>`;
    const bodyHtml = `<div>${esc(m.text||'')}</div>`;
    el.innerHTML = metaHtml + bodyHtml;
    // bind long press / contextmenu for edit/delete
    bindMessageActions(el, m);
    messagesDiv.appendChild(el);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* long-press and right-click to open menu for own messages */
function bindMessageActions(el, msg){
  let timer = null; const longMs = 600;
  const start = e=>{
    if(e.type === 'contextmenu'){ e.preventDefault(); openMessageMenu(msg); return; }
    timer = setTimeout(()=> openMessageMenu(msg), longMs);
  };
  const cancel = ()=>{ if(timer){ clearTimeout(timer); timer=null; } };
  el.addEventListener('touchstart', start, {passive:false});
  el.addEventListener('mousedown', start);
  el.addEventListener('touchend', cancel);
  el.addEventListener('mouseup', cancel);
  el.addEventListener('mouseleave', cancel);
  el.addEventListener('contextmenu', start);
}

/* menu: edit or delete (only for my messages) */
async function openMessageMenu(msg){
  if(msg.from !== profile.login) return;
  // reuse confirm modal to show options
  confirmText.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="__optEdit" class="btn">Изменить</button>
      <button id="__optDel" class="btn small-btn">Удалить</button>
      <button id="__optClose" class="btn small-btn">Отмена</button>
    </div>`;
  openModal(modalConfirm);
  document.getElementById('__optEdit').onclick = ()=>{
    closeModal(modalConfirm);
    editingMessage = msg;
    editText.value = msg.text || '';
    openModal(modalEdit);
  };
  document.getElementById('__optDel').onclick = async ()=>{
    closeModal(modalConfirm);
    const ok = await confirmDialog('Удалить сообщение?');
    if(!ok) return;
    try{
      await db.collection('chats').doc(activeChatId).collection('messages').doc(msg.id).delete();
      showToast('Сообщение удалено');
    } catch(e){ console.error('delete', e); showToast('Ошибка удаления'); }
  };
  document.getElementById('__optClose').onclick = ()=> closeModal(modalConfirm);
}

/* edit modal actions */
editSave.addEventListener('click', async ()=>{
  if(!editingMessage) return;
  const nt = (editText.value||'').trim();
  try{
    await db.collection('chats').doc(activeChatId).collection('messages').doc(editingMessage.id).update({ text: nt, edited: true });
    // update chat.lastMessage if it matched old
    const chatDoc = await db.collection('chats').doc(activeChatId).get();
    if(chatDoc.exists && chatDoc.data().lastMessage === editingMessage.text){
      await db.collection('chats').doc(activeChatId).set({ lastMessage: nt, updatedAt: FieldValue.serverTimestamp() }, { merge: true });
    }
    showToast('Сообщение изменено');
    editingMessage = null; closeModal(modalEdit);
  } catch(e){ console.error('edit save', e); showToast('Ошибка редактирования'); }
});
editCancel.addEventListener('click', ()=>{ editingMessage = null; closeModal(modalEdit); });

/* ---------------- mark messages read ---------------- */
async function markMessagesRead(chatId){
  if(!profile) return;
  try{
    const q = db.collection('chats').doc(chatId).collection('messages')
      .where('from','!=', profile.login)
      .where('readAt','==', null);
    const snap = await q.get();
    if(snap.empty) return;
    const batch = db.batch();
    snap.forEach(docSnap => {
      const ref = db.collection('chats').doc(chatId).collection('messages').doc(docSnap.id);
      batch.update(ref, { readAt: FieldValue.serverTimestamp() });
    });
    await batch.commit();
  } catch(e){ console.error('mark read', e); }
}

/* ---------------- send message ---------------- */
sendBtn.addEventListener('click', async ()=>{
  if(!activeChatId) return showToast('Откройте чат');
  const txt = (messageText.value||'').trim();
  if(!txt) return;
  try{
    const msgObj = { from: profile.login, text: txt, createdAt: FieldValue.serverTimestamp(), type: 'text' };
    await db.collection('chats').doc(activeChatId).collection('messages').add(msgObj);
    await db.collection('chats').doc(activeChatId).set({ lastMessage: txt, updatedAt: FieldValue.serverTimestamp() }, { merge: true });
    messageText.value = '';
  } catch(e){ console.error('send', e); showToast('Ошибка отправки'); }
});
messageText.addEventListener('keydown', e=>{ if(e.key === 'Enter') sendBtn.click(); });

/* ---------------- back button and swipe to close chat ---------------- */
backBtn.addEventListener('click', ()=> closeChat());
(function chatSwipeClose(){
  let startX=0, touching=false;
  messagesDiv.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; touching=true; });
  messagesDiv.addEventListener('touchmove', e=>{ if(!touching) return; const cur = e.touches[0].clientX; const dx = cur - startX; if(dx > 60){ closeChat(); touching=false; } });
  messagesDiv.addEventListener('touchend', ()=>{ touching=false; });
})();

function closeChat(){
  if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
  activeChatId = null;
  composer.style.display = 'none';
  chatHeader.style.display = 'none';
  messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Выберите чат или найдите по $логину</div>';
  if(window.innerWidth < 720) leftPane.style.display = 'block';
}

/* ---------------- view profile modal (click header title) ---------------- */
chatTitle.addEventListener('click', async ()=>{
  if(!activeChatId) return;
  try{
    const chatDoc = await db.collection('chats').doc(activeChatId).get();
    if(!chatDoc.exists) return;
    const otherLogin = (chatDoc.data().participants||[]).find(x=> x !== profile.login);
    if(!otherLogin) return;
    const snap = await db.collection('users').where('login','==', otherLogin).limit(1).get();
    if(snap.empty){
      profileViewer.innerHTML = `<div>Пользователь: ${esc(otherLogin)}</div><div style="margin-top:10px;color:var(--muted)">Доп. данных нет</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="pv_close" class="btn small-btn">Закрыть</button></div>`;
      openModal(modalProfile);
      document.getElementById('pv_close').onclick = ()=> closeModal(modalProfile);
      return;
    }
    const ud = snap.docs[0].data();
    profileViewer.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:84px;height:84;border-radius:12px;background:#eee;display:flex;align-items:center;justify-content:center">${esc((ud.name||ud.login||'').slice(0,2)).toUpperCase()}</div>
        <div>
          <div style="font-weight:700">${esc(ud.name||ud.login)}</div>
          <div style="color:var(--muted);margin-top:6px">${esc(ud.login||'')}</div>
          <div style="margin-top:8px;color:var(--muted);max-width:260px">${esc(ud.about||'')}</div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="pv_close" class="btn small-btn">Закрыть</button></div>
    `;
    openModal(modalProfile);
    document.getElementById('pv_close').onclick = ()=> closeModal(modalProfile);
  } catch(e){ console.error('view profile', e); showToast('Ошибка просмотра профиля'); }
});

/* ---------------- drawer profile / open settings buttons ---------------- */
openProfileBtn.addEventListener('click', async ()=>{
  closeDrawer();
  // open profile viewer for self
  profileViewer.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:84px;height:84;border-radius:12px;background:#eee;display:flex;align-items:center;justify-content:center">${esc((profile.name||profile.login||'').slice(0,2)).toUpperCase()}</div>
      <div>
        <div style="font-weight:700">${esc(profile.name || profile.login)}</div>
        <div style="color:var(--muted);margin-top:6px">${esc(profile.login)}</div>
        <div style="margin-top:8px;color:var(--muted);max-width:260px">${esc(profile.about||'')}</div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="pv_close_self" class="btn small-btn">Закрыть</button></div>
  `;
  openModal(modalProfile);
  document.getElementById('pv_close_self').onclick = ()=> closeModal(modalProfile);
});

openSettingsBtn.addEventListener('click', ()=>{ /* drawer already shows settings fields */ });

/* ---------------- close drawer on swipe left already implemented above ---------------- */

/* ---------------- util: close modals on backdrop click ---------------- */
document.querySelectorAll('.modal-back').forEach(el=>{
  el.addEventListener('click', (ev)=>{ if(ev.target === el) el.style.display = 'none'; });
});

/* ---------------- initial UI on load ---------------- */
window.addEventListener('load', ()=>{
  modalLogin.style.display = 'none';
  modalProfile.style.display = 'none';
  modalEdit.style.display = 'none';
  modalConfirm.style.display = 'none';
  overlay.classList.remove('show');
  // show login if not authed
  if(!auth.currentUser) openModal(modalLogin);
});

/* ---------------- notes on Firestore structure ----------------
 - users/{uid} : { email, name, login (starts with $), about, ... }
 - chats/{chatId} : { participants: [loginA, loginB], lastMessage, updatedAt }
 - chats/{chatId}/messages/{msgId} : { from: login, text, createdAt, deliveredAt?, readAt?, edited? }
---------------------------------------------------------------------------------------- */

</script>
</body>
</html>
