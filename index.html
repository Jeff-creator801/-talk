<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>$Talk ‚Äî v2 (mobile)</title>
  <meta name="theme-color" content="#1e90ff">
  <style>
    /* Mobile-first styles */
    :root{
      --primary:#1e90ff;
      --bg:#ffffff;
      --text:#222;
      --muted:#6b7280;
      --user-bubble:#e6f0ff;
      --other-bubble:#f2f2f2;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
    .app{height:100vh;display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:10px;padding:12px;background:linear-gradient(90deg,var(--primary),#3fb0ff);color:white}
    .icon-btn{width:40px;height:40;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .title{font-weight:700;font-size:16px}
    .top-right{margin-left:auto;display:flex;gap:8px;align-items:center}
    main{flex:1;display:flex;flex-direction:column;overflow:hidden}
    /* layout for larger screens */
    @media(min-width:720px){ main{flex-direction:row} }
    /* left panel */
    .left{width:100%;max-width:420px;border-right:1px solid #eee;background:#fff;display:flex;flex-direction:column}
    .search-row{display:flex;gap:8px;padding:10px;border-bottom:1px solid #eee;background:#fff}
    .search-row input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
    .chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:#fafafa}
    .chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:white;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
    .ava{width:46px;height:46;border-radius:8px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700}
    .meta{flex:1}
    .meta .name{font-weight:600}
    .meta .last{color:var(--muted);font-size:13px}
    .meta .time{font-size:12px;color:var(--muted);margin-left:6px}
    /* chat area */
    .chat-area{flex:1;display:flex;flex-direction:column;background:#fff}
    .messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word}
    .msg.me{align-self:flex-end;background:var(--user-bubble)}
    .msg.you{align-self:flex-start;background:var(--other-bubble)}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;padding:10px;gap:8px;border-top:1px solid #eee;background:#fff}
    .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#f5f5f5;color:var(--text)}
    /* overlay drawer */
    .drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:#fff;box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
    .drawer.open{left:0}
    .overlay-click{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:35;display:none}
    .overlay-click.show{display:block}
    .field{margin-bottom:12px}
    .field label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    .field input,.field textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eee}
    /* login modal */
    .overlay-modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .card{width:92%;max-width:420px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,0.2)}
    .muted{color:var(--muted);font-size:13px}
    .center{text-align:center}
    /* small helpers */
    .checks{font-size:12px;color:var(--muted);margin-left:6px}
    .check-grey{color:#9aa4b2}
    .check-blue{color:#1e90ff}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div id="menuBtn" class="icon-btn" title="–ú–µ–Ω—é">‚â°</div>
      <div class="title">$Talk</div>

      <div class="top-right">
        <div id="searchBtn" class="icon-btn" title="–ü–æ–∏—Å–∫">üîç</div>
        <div id="composeBtn" class="icon-btn" title="–ù–æ–≤—ã–π —á–∞—Ç">Ôºã</div>
      </div>
    </header>

    <main>
      <div id="leftPanel" class="left" style="display:flex">
        <div class="search-row">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ $–ª–æ–≥–∏–Ω—É –∏–ª–∏ email" />
          <button id="searchGo" class="btn ghost">–ù–∞–π—Ç–∏</button>
        </div>
        <div id="chats" class="chats"></div>
      </div>

      <div id="chatArea" class="chat-area" style="display:flex;flex-direction:column">
        <div id="messages" class="messages"><div class="center muted">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div></div>
        <div class="composer" id="composer" style="display:none">
          <input id="msgText" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
          <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer (Profile / Settings) -->
  <div id="overlayClick" class="overlay-click"></div>
  <div id="drawer" class="drawer" role="dialog" aria-hidden="true">
    <h3>–ú–µ–Ω—é</h3>
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
      <button id="btnSettings" class="btn ghost">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button id="btnProfile" class="btn ghost">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <hr style="margin:14px 0">

    <div id="profilePanel" style="display:none">
      <div class="field"><label>Email</label><input id="p_email" disabled /></div>
      <div class="field"><label>–ò–º—è</label><input id="p_name" maxlength="30" /></div>
      <div class="field"><label>–õ–æ–≥–∏–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å $)</label><input id="p_login" /></div>
      <div class="field"><label>–û —Å–µ–±–µ (‚â§100)</label><textarea id="p_about" rows="3" maxlength="100"></textarea></div>
      <div style="display:flex;gap:8px"><button id="p_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="p_logout" class="btn ghost">–í—ã–π—Ç–∏</button></div>
    </div>

    <div id="settingsPanel" style="display:none">
      <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ)</div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="overlay-modal" style="display:none">
    <div class="card">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <div style="width:44px;height:44;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">$</div>
        <div style="margin-left:10px">
          <div style="font-weight:700">$Talk</div>
          <div class="muted">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</div>
        </div>
      </div>
      <div class="field"><label>Email</label><input id="loginEmail" type="email" /></div>
      <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="loginPass" type="password" /></div>
      <div style="display:flex;gap:8px">
        <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
        <button id="btnRegister" class="btn ghost">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
      <div style="margin-top:10px" class="muted">–ü–∞—Ä–æ–ª—å ‚â• 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
/* ================= $Talk v2 single-file =================
   - Uses compat SDK so mobile browsers don't choke on modules
   - Firestore structure:
     /chats/{chatId} { participants: [emailA,emailB], lastMessage, updatedAt }
     /chats/{chatId}/messages/{msgId} { from, text, createdAt, delivered, read }
   - read/delivered flags:
     - Sender creates message (delivered:false, read:false)
     - Recipient's onSnapshot sees it and sets delivered:true (one check)
     - When recipient opens chat, client sets read:true for unread messages (two checks)
   ======================================================= */

  // ---------- FIREBASE CONFIG (—Ç–≤–æ–π –∫–æ–Ω—Ñ–∏–≥) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
    authDomain: "talk-f1ff9.firebaseapp.com",
    databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
    projectId: "talk-f1ff9",
    storageBucket: "talk-f1ff9.firebasestorage.app",
    messagingSenderId: "856136352939",
    appId: "1:856136352939:web:87c28128d4951f909f63ee",
    measurementId: "G-3KDE4QT7PF"
  };

  // init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const F = firebase.firestore.FieldValue;

  // DOM refs
  const loginModal = document.getElementById('loginModal');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');

  const overlayClick = document.getElementById('overlayClick');
  const drawer = document.getElementById('drawer');
  const menuBtn = document.getElementById('menuBtn');
  const btnProfile = document.getElementById('btnProfile');
  const btnSettings = document.getElementById('btnSettings');
  const profilePanel = document.getElementById('profilePanel');
  const settingsPanel = document.getElementById('settingsPanel');

  const p_email = document.getElementById('p_email');
  const p_name = document.getElementById('p_name');
  const p_login = document.getElementById('p_login');
  const p_about = document.getElementById('p_about');
  const p_save = document.getElementById('p_save');
  const p_logout = document.getElementById('p_logout');

  const searchInput = document.getElementById('searchInput');
  const searchGo = document.getElementById('searchGo');
  const searchBtn = document.getElementById('searchBtn');
  const composeBtn = document.getElementById('composeBtn');

  const chatsDiv = document.getElementById('chats');
  const messagesDiv = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const msgText = document.getElementById('msgText');
  const sendBtn = document.getElementById('sendBtn');

  // state
  let me = null; // firebase.User
  let profile = null; // profile doc
  let chatsUnsub = null;
  let msgsUnsub = null;
  let activeChatId = null;

  // helpers
  const esc = s => (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
  function tstr(ts){ if(!ts) return ''; try { if(ts.toDate) return ts.toDate().toLocaleTimeString(); return new Date(ts).toLocaleTimeString(); } catch(e){ return ''; } }
  const toast = (t) => { alert(t); console.log('TOAST:', t); };

  // ---------------- AUTH ----------------
  function openLogin(){ loginModal.style.display = 'flex'; }
  function closeLogin(){ loginModal.style.display = 'none'; }

  btnLogin.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'').trim();
    if(!email || !pass){ toast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      closeLogin();
    } catch(err){
      console.error('login error', err);
      toast(err.code + ' ‚Äî ' + err.message);
    }
  });

  btnRegister.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'').trim();
    if(!email || !pass){ toast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
    if(pass.length < 6){ toast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6+ —Å–∏–º–≤–æ–ª–æ–≤'); return; }
    try {
      const reg = await auth.createUserWithEmailAndPassword(email, pass);
      // create profile
      await db.collection('users').doc(reg.user.uid).set({
        email: reg.user.email,
        name: '',
        login: '$' + (reg.user.email.split('@')[0].slice(0,8)),
        about: '',
        createdAt: F.serverTimestamp()
      }, { merge: true });
      closeLogin();
      toast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
    } catch(err){
      console.error('register error', err);
      toast(err.code + ' ‚Äî ' + err.message);
    }
  });

  // onAuthState
  auth.onAuthStateChanged(async user=>{
    if(user){
      me = user;
      closeLogin();
      await loadProfile();
      startChats();
      renderUIState();
      console.log('Logged in:', me.email);
    } else {
      me = null;
      profile = null;
      stopAll();
      renderUIState();
      openLogin();
      console.log('Logged out');
    }
  });

  // ---------------- PROFILE ----------------
  async function loadProfile(){
    if(!me) return;
    const docRef = db.collection('users').doc(me.uid);
    const snap = await docRef.get();
    if(snap.exists){
      profile = snap.data();
    } else {
      const base = { email: me.email, name:'', login: '$' + (me.email.split('@')[0].slice(0,8)), about:'', createdAt: F.serverTimestamp() };
      await docRef.set(base, { merge: true });
      profile = base;
    }
    // sync UI
    p_email.value = profile.email || me.email;
    p_name.value = profile.name || '';
    p_login.value = profile.login || ('$' + (me.email.split('@')[0].slice(0,8)));
    p_about.value = profile.about || '';
  }

  p_save.addEventListener('click', async ()=>{
    if(!me) return toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
    const name = (p_name.value||'').trim();
    const login = (p_login.value||'').trim();
    const about = (p_about.value||'').trim();
    if(!login.startsWith('$')) return toast('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $');
    if(about.length > 100) return toast('–û–ø–∏—Å. ‚â§ 100');
    try {
      await db.collection('users').doc(me.uid).set({ name, login, about, updatedAt: F.serverTimestamp() }, { merge: true });
      profile = { ...profile, name, login, about };
      toast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    } catch(e){ console.error('save profile', e); toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
  });

  p_logout.addEventListener('click', async ()=>{
    if(confirm('–í—ã–π—Ç–∏?')) { try{ await auth.signOut(); } catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞'); } }
  });

  // ---------------- UI state ----------------
  function renderUIState(){
    // drawer default view profile
    profilePanel.style.display = 'block';
    settingsPanel.style.display = 'none';
    // show/hide composer
    composer.style.display = activeChatId ? 'flex' : 'none';
  }

  // drawer open/close and swipe-to-close
  menuBtn.addEventListener('click', ()=> { drawer.classList.add('open'); overlayClick.classList.add('show'); drawer.setAttribute('aria-hidden','false'); });
  overlayClick.addEventListener('click', closeDrawer);
  function closeDrawer(){ drawer.classList.remove('open'); overlayClick.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }

  // swipe to close (touch)
  (function addDrawerSwipe(){
    let startX = 0, curX = 0, touching = false;
    drawer.addEventListener('touchstart', (e)=>{ startX = e.touches[0].clientX; touching=true; });
    drawer.addEventListener('touchmove', (e)=>{ if(!touching) return; curX = e.touches[0].clientX; const delta = curX - startX; if(delta < -30){ closeDrawer(); touching=false; } });
    drawer.addEventListener('touchend', ()=>{ touching=false; });
  })();

  btnProfile.addEventListener('click', ()=>{ profilePanel.style.display='block'; settingsPanel.style.display='none'; });
  btnSettings.addEventListener('click', ()=>{ profilePanel.style.display='none'; settingsPanel.style.display='block'; });

  // ---------------- SEARCH / CREATE CHAT ----------------
  // search by login prefix or full email
  searchGo.addEventListener('click', async ()=>{
    const q = (searchInput.value||'').trim();
    if(!q) return toast('–í–≤–µ–¥–∏—Ç–µ $–ª–æ–≥–∏–Ω –∏–ª–∏ email');
    if(q.startsWith('$')){
      // search users by login prefix
      try {
        const start = q;
        const end = q + '\uf8ff';
        const usersRef = db.collection('users').orderBy('login').startAt(start).endAt(end);
        const snap = await usersRef.get();
        if(snap.empty) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        // if multiple, open first
        const userDoc = snap.docs[0].data();
        await createOrOpenChatWith(userDoc.email);
      } catch(e){ console.error('search login', e); toast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞'); }
    } else {
      // treat as email
      await createOrOpenChatWith(q);
    }
  });

  searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchGo.click(); });
  searchBtn.addEventListener('click', ()=> { document.getElementById('searchInput').focus(); });

  composeBtn.addEventListener('click', async ()=>{
    const email = prompt('Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ (–∏–ª–∏ $–ª–æ–≥–∏–Ω):');
    if(!email) return;
    if(email.startsWith('$')){
      // find user
      const start = email; const end = email + '\uf8ff';
      const snap = await db.collection('users').orderBy('login').startAt(start).endAt(end).get();
      if(snap.empty) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      createOrOpenChatWith(snap.docs[0].data().email);
    } else createOrOpenChatWith(email.trim());
  });

  // ---------------- Chats list ----------------
  async function startChats(){
    if(!profile || !profile.email) return;
    if(chatsUnsub) chatsUnsub();
    const q = db.collection('chats').where('participants','array-contains', profile.email).orderBy('updatedAt','desc');
    chatsUnsub = q.onSnapshot(snapshot=>{
      const arr = [];
      snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderChats(arr);
    }, err => { console.error('chats snap', err); toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞—Ç–æ–≤'); });
  }

  function renderChats(chats){
    chatsDiv.innerHTML = '';
    if(!chats || !chats.length){ chatsDiv.innerHTML = '<div class="muted" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤</div>'; return; }
    chats.forEach(c=>{
      const other = (c.participants||[]).find(x=> x !== profile.email) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.innerHTML = `<div class="ava">${esc(other.slice(0,2)).toUpperCase()}</div>
                        <div class="meta"><div class="name">${esc(other)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
                        <div class="time">${tstr(c.updatedAt)}</div>`;
      item.addEventListener('click', ()=> openChat(c.id));
      chatsDiv.appendChild(item);
    });
  }

  // ---------------- Create / Open chat ----------------
  async function createOrOpenChatWith(email){
    if(!profile) return toast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
    email = (email||'').trim();
    if(!email) return;
    try {
      // find existing chat where both participants present
      const q = db.collection('chats').where('participants','array-contains', profile.email);
      const snap = await q.get();
      let found = null;
      snap.forEach(d=>{
        const data = d.data();
        if(Array.isArray(data.participants) && data.participants.includes(email)) found = { id:d.id, ...data };
      });
      if(found){ openChat(found.id); return; }
      // create new chat
      const ref = await db.collection('chats').add({ participants:[profile.email, email], lastMessage:'', updatedAt: F.serverTimestamp() });
      openChat(ref.id);
    } catch(e){ console.error('create/open chat', e); toast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞'); }
  }

  // ---------------- Open chat & messages ----------------
  function openChat(chatId){
    activeChatId = chatId;
    renderUIState();
    // unsubscribe old listener
    if(msgsUnsub) msgsUnsub();
    // load messages ordered
    const msgsRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
    msgsUnsub = msgsRef.onSnapshot(snapshot=>{
      const arr = [];
      snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessages(arr);
      // For any newly seen messages from others, mark delivered=true
      snapshot.docChanges().forEach(change=>{
        if(change.type === 'added'){
          const m = change.doc.data();
          if(m.from !== profile.email && !m.delivered){
            // mark delivered
            db.collection('chats').doc(chatId).collection('messages').doc(change.doc.id).update({ delivered:true }).catch(e=>console.error('mark delivered',e));
          }
        }
      });
      // If user currently viewing this chat, mark unread as read
      markMessagesRead(chatId);
    }, err => { console.error('msgs snap', err); toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π'); });

    // scroll to bottom after a short delay when messages render
    setTimeout(()=> messagesDiv.scrollTop = messagesDiv.scrollHeight, 150);
  }

  function renderMessages(msgs){
    messagesDiv.innerHTML = '';
    if(!msgs.length){ messagesDiv.innerHTML = '<div class="center muted">–ß–∞—Ç –ø—É—Å—Ç</div>'; return; }
    msgs.forEach(m=>{
      const el = document.createElement('div');
      el.className = (m.from === profile.email) ? 'msg me' : 'msg you';
      // checks: one gray check = delivered true, two blue checks = read true
      let checks = '';
      if(m.from === profile.email){
        if(m.read) checks = `<span class="checks check-blue">‚úì‚úì</span>`;
        else if(m.delivered) checks = `<span class="checks check-grey">‚úì</span>`;
      }
      el.innerHTML = `<div class="meta">${esc(m.from)} ¬∑ ${tstr(m.createdAt)} ${checks}</div><div>${esc(m.text)}</div>`;
      messagesDiv.appendChild(el);
    });
    // auto-scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // mark unread messages as read when opening chat
  async function markMessagesRead(chatId){
    if(!profile) return;
    try {
      const msgsRef = db.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.email).where('read','==', false);
      const snap = await msgsRef.get();
      const batch = db.batch();
      snap.forEach(docSnap => {
        batch.update(doc(db.collection('chats').doc(chatId).collection('messages').doc(docSnap.id)), { read:true });
      });
      if(!snap.empty) await batch.commit();
    } catch(e){ console.error('markMessagesRead', e); }
  }

  // ---------------- Send message ----------------
  sendBtn.addEventListener('click', async ()=>{
    const text = (msgText.value||'').trim();
    if(!text) return;
    if(!activeChatId) return toast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
    try {
      // add message with flags
      await db.collection('chats').doc(activeChatId).collection('messages').add({
        from: profile.email,
        text,
        createdAt: F.serverTimestamp(),
        delivered: false,
        read: false
      });
      // update chat meta
      await db.collection('chats').doc(activeChatId).set({ lastMessage:text, updatedAt: F.serverTimestamp() }, { merge: true });
      msgText.value = '';
    } catch(e){ console.error('send msg', e); toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
  });

  // allow Enter to send
  msgText.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendBtn.click(); });

  // ---------------- Utilities ----------------
  function stopAll(){
    if(chatsUnsub){ chatsUnsub(); chatsUnsub = null; }
    if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
    activeChatId = null;
    messagesDiv.innerHTML = '<div class="center muted">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>';
    chatsDiv.innerHTML = '';
  }

  // ---------------- Initial UI events ----------------
  // overlay click will close drawer if open
  overlayClick.addEventListener('click', closeDrawer);
  // clicking outside messages shouldn't block scroll ‚Äî nothing else needed

  // small adaptive behavior: hide left panel on very small screens when chat open
  function adjustLayout(){
    const width = window.innerWidth;
    const leftPanel = document.getElementById('leftPanel');
    if(width < 720 && activeChatId){
      leftPanel.style.display = 'none';
    } else {
      leftPanel.style.display = 'flex';
    }
  }
  window.addEventListener('resize', adjustLayout);
  setInterval(adjustLayout, 500);

  // expose debug
  window.$TalkDebug = { auth, db, meProfile: ()=> profile, openChat, createOrOpenChatWith };

  // done
  console.log('$Talk v2 loaded');
  </script>
</body>
</html>
