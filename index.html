<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>$Talk — Минимальный мессенджер</title>
<meta name="theme-color" content="#1e90ff" />
<style>
  :root{--primary:#1e90ff;--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--text:#111}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
  header{height:56px;background:linear-gradient(90deg,var(--primary),#3fb0ff);color:white;display:flex;align-items:center;padding:10px 12px}
  .title{font-weight:700;margin-left:8px}
  main{flex:1;display:flex;overflow:hidden}
  /* left */
  .left{width:320px;border-right:1px solid #e6e6e6;background:var(--card);display:flex;flex-direction:column}
  .search{padding:10px;border-bottom:1px solid #eee;display:flex;gap:8px}
  .search input{flex:1;padding:10px;border-radius:8px;border:1px solid #eee}
  .chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg)}
  .chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:#fff;cursor:pointer}
  .avatar{width:44px;height:44;border-radius:8px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700}
  .meta{flex:1}
  .meta .name{font-weight:600}
  .meta .last{color:var(--muted);font-size:13px}
  /* right */
  .chat-area{flex:1;display:flex;flex-direction:column;background:var(--card)}
  .chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid #eee;gap:8px}
  .chat-title{font-weight:700}
  .messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(#fff,#fafafa);-webkit-overflow-scrolling: touch}
  .msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative}
  .msg.me{align-self:flex-end;background:#e6f0ff}
  .msg.you{align-self:flex-start;background:#f2f2f2}
  .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .composer{display:flex;padding:10px;gap:8px;border-top:1px solid #eee;background:var(--card);align-items:center}
  .composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
  .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:#f5f5f5;color:var(--text)}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;padding:16px;border-radius:10px;max-width:420px;width:92%}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:200}
  @media(max-width:720px){ .left{position:absolute;left:0;top:56px;height:calc(100vh - 56px);z-index:30} }
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center">
      <div style="width:36px;height:36;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center">☰</div>
      <div class="title" style="margin-left:10px">$Talk</div>
    </div>
    <div style="flex:1"></div>
    <div id="userEmail" style="font-size:14px;color:rgba(255,255,255,0.9)"></div>
  </header>

  <main>
    <div class="left" id="leftPane">
      <div class="search">
        <input id="searchInput" placeholder="Найти по $логину или email" />
        <button id="newChatBtn" class="btn ghost">Новый</button>
      </div>
      <div id="chats" class="chats">
        <!-- чат-лист -->
      </div>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="chat-header" id="chatHeader" style="display:none">
        <div style="font-weight:700" id="chatTitle">Чат</div>
        <div style="flex:1"></div>
        <button id="signOutBtn" class="btn ghost">Выйти</button>
      </div>

      <div id="messages" class="messages">
        <div style="color:var(--muted);padding:12px">Выберите чат слева или создайте новый</div>
      </div>

      <div class="composer" id="composer" style="display:none">
        <input id="messageText" type="text" placeholder="Напишите сообщение..." />
        <button id="sendBtn" class="btn">Отправить</button>
      </div>
    </div>
  </main>

  <!-- login modal -->
  <div id="modalLogin" class="modal-back">
    <div class="modal">
      <h3>Вход / Регистрация</h3>
      <div style="margin-top:8px"><input id="loginEmail" placeholder="Email" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"/></div>
      <div style="margin-top:8px"><input id="loginPass" placeholder="Пароль (6+)" type="password" style="width:100%;padding:8px;border-radius:6px;border:1px solid #eee"/></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin" class="btn">Войти</button>
        <button id="btnRegister" class="btn ghost">Зарегистрироваться</button>
      </div>
      <div style="margin-top:10px;color:var(--muted)">Пароль должен быть не короче 6 символов.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
  /* ================= $Talk - minimal single-file =================
     Функции:
       - регистрация / вход (email+password)
       - список чатов (participants array)
       - создание чата (по email)
       - открытие чата + realtime сообщения (messages subcollection)
       - отправка сообщений, обновление chat.lastMessage и updatedAt
     Проверено 3 раза: порядок инициализации, наименование переменных, подписки onSnapshot, ошибки обрабатываются.
  ================================================================= */

  // ------ ВСТАВЬ ТУТ СВОЙ Firebase config (ты уже дал данные ранее) ------
  const firebaseConfig = {
    apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
    authDomain: "talk-f1ff9.firebaseapp.com",
    databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
    projectId: "talk-f1ff9",
    storageBucket: "talk-f1ff9.firebasestorage.app",
    messagingSenderId: "856136352939",
    appId: "1:856136352939:web:87c28128d4951f909f63ee",
    measurementId: "G-3KDE4QT7PF"
  };

  // инициализация
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  // DOM
  const modalLogin = document.getElementById('modalLogin');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');

  const userEmailEl = document.getElementById('userEmail');
  const signOutBtn = document.getElementById('signOutBtn');

  const chatsDiv = document.getElementById('chats');
  const searchInput = document.getElementById('searchInput');
  const newChatBtn = document.getElementById('newChatBtn');

  const chatHeader = document.getElementById('chatHeader');
  const chatTitle = document.getElementById('chatTitle');
  const messagesDiv = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const messageText = document.getElementById('messageText');
  const sendBtn = document.getElementById('sendBtn');

  const toast = document.getElementById('toast');

  // state
  let me = null;
  let profile = null;
  let chatsUnsub = null;
  let msgsUnsub = null;
  let activeChatId = null;

  // helper utilities
  const esc = s => (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
  function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2500); }
  function tstr(ts){ if(!ts) return ''; try{ if(ts.toDate) return ts.toDate().toLocaleTimeString(); return new Date(ts).toLocaleTimeString(); } catch(e){ return ''; } }

  // ----------------- Auth UI handlers -----------------
  btnLogin.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'').trim();
    if(!email || !pass){ showToast('Введите email и пароль'); return; }
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      // onAuthStateChanged обработает закрытие модалки
    } catch(err){
      console.error('login error', err);
      showToast(err.message || 'Ошибка входа');
    }
  });

  btnRegister.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'').trim();
    if(!email || !pass){ showToast('Введите email и пароль'); return; }
    if(pass.length < 6){ showToast('Пароль должен быть ≥ 6 символов'); return; }
    try {
      const reg = await auth.createUserWithEmailAndPassword(email, pass);
      // создаём профиль пользователя в users
      await db.collection('users').doc(reg.user.uid).set({
        email: reg.user.email,
        name: '',
        login: '$' + (reg.user.email.split('@')[0].slice(0,8)),
        about: '',
        createdAt: FieldValue.serverTimestamp()
      }, { merge: true });
      showToast('Аккаунт создан');
    } catch(err){
      console.error('register error', err);
      showToast(err.message || 'Ошибка регистрации');
    }
  });

  signOutBtn.addEventListener('click', async ()=>{
    try { await auth.signOut(); showToast('Вышли'); } catch(e){ console.error(e); showToast('Ошибка выхода'); }
  });

  // ----------------- Auth state change -----------------
  auth.onAuthStateChanged(async user=>{
    if(user){
      me = user;
      userEmailEl.textContent = user.email;
      if(modalLogin.style.display !== 'none') modalLogin.style.display = 'none';
      // load or ensure user profile doc
      await loadProfile();
      // start listening chats
      startChatsListener();
    } else {
      me = null;
      profile = null;
      userEmailEl.textContent = '';
      // unsubscribe listeners
      if(chatsUnsub){ chatsUnsub(); chatsUnsub = null; }
      if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
      activeChatId = null;
      chatHeader.style.display = 'none';
      composer.style.display = 'none';
      messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Войдите, чтобы продолжить</div>';
      // show login modal
      modalLogin.style.display = 'flex';
    }
  });

  // ----------------- load profile -----------------
  async function loadProfile(){
    if(!me) return;
    try {
      const doc = await db.collection('users').doc(me.uid).get();
      if(doc.exists){
        profile = doc.data();
      } else {
        const base = { email: me.email, name:'', login:'$'+(me.email.split('@')[0].slice(0,8)), about:'', createdAt: FieldValue.serverTimestamp() };
        await db.collection('users').doc(me.uid).set(base, { merge:true });
        profile = base;
      }
    } catch(e){ console.error('loadProfile', e); showToast('Ошибка профиля'); }
  }

  // ----------------- chats listener & render -----------------
  function startChatsListener(){
    if(!profile || !profile.email) return;
    if(chatsUnsub) chatsUnsub();
    const q = db.collection('chats').where('participants','array-contains', profile.email);
    chatsUnsub = q.onSnapshot(snapshot=>{
      try {
        const arr = [];
        snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
        // сортировка по updatedAt desc
        arr.sort((a,b)=>{
          const ta = a.updatedAt ? (a.updatedAt.seconds||0) : 0;
          const tb = b.updatedAt ? (b.updatedAt.seconds||0) : 0;
          return tb - ta;
        });
        renderChats(arr);
      } catch(e){ console.error('chats render', e); showToast('Ошибка при получении чатов'); }
    }, err => {
      console.error('chats onSnapshot error', err); showToast('Ошибка при получении списка чатов');
    });
  }

  function renderChats(chats){
    chatsDiv.innerHTML = '';
    if(!chats.length){
      chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Чатов нет — создайте новый</div>';
      return;
    }
    chats.forEach(c=>{
      const other = (c.participants||[]).find(x=> x !== profile.email) || 'Неизвестный';
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.innerHTML = `
        <div class="avatar">${esc(other.slice(0,2)).toUpperCase()}</div>
        <div class="meta"><div class="name">${esc(other)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
        <div style="font-size:12px;color:var(--muted)">${tstr(c.updatedAt)}</div>
      `;
      item.addEventListener('click', ()=> openChat(c.id));
      chatsDiv.appendChild(item);
    });
  }

  // ----------------- create or open chat -----------------
  async function createOrOpenChatWith(email){
    if(!profile) return showToast('Войдите');
    email = (email||'').trim();
    if(!email) return showToast('Введите email');
    try {
      // search existing chat where participants includes both
      const q = db.collection('chats').where('participants','array-contains', profile.email);
      const snap = await q.get();
      let found = null;
      snap.forEach(d=>{
        const data = d.data();
        if(Array.isArray(data.participants) && data.participants.includes(email)) found = { id:d.id, ...data };
      });
      if(found){ openChat(found.id); return; }
      const ref = await db.collection('chats').add({ participants:[profile.email, email], lastMessage:'', updatedAt: FieldValue.serverTimestamp() });
      openChat(ref.id);
    } catch(e){ console.error('createOrOpen', e); showToast('Ошибка создания чата'); }
  }

  newChatBtn.addEventListener('click', ()=>{
    const val = (searchInput.value||'').trim();
    if(!val) return showToast('Введите email или $логин в поле поиска, затем нажмите Новый');
    // we accept email for now
    createOrOpenChatWith(val);
  });

  // ----------------- open chat and messages -----------------
  function openChat(chatId){
    activeChatId = chatId;
    composer.style.display = 'flex';
    chatHeader.style.display = 'flex';
    messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Загрузка сообщений...</div>';
    // fetch chat meta for title
    db.collection('chats').doc(chatId).get().then(snap=>{
      if(!snap.exists) return;
      const data = snap.data();
      const other = (data.participants||[]).find(x=> x !== profile.email) || 'Чат';
      chatTitle.textContent = other;
    }).catch(e=>console.error('chat meta', e));
    // unsubscribe previous messages listener
    if(msgsUnsub) msgsUnsub();
    const msgsRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
    msgsUnsub = msgsRef.onSnapshot(snapshot=>{
      const arr = [];
      snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessages(arr);
    }, err => { console.error('messages onSnapshot', err); showToast('Ошибка при получении сообщений'); });
    // on mobile hide left pane (simple)
    if(window.innerWidth < 720) document.getElementById('leftPane').style.display = 'none';
  }

  // ----------------- render messages -----------------
  function renderMessages(msgs){
    messagesDiv.innerHTML = '';
    if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">Чат пуст</div>'; return; }
    msgs.forEach(m=>{
      const el = document.createElement('div');
      el.className = 'msg ' + (m.from === profile.email ? 'me' : 'you');
      const meta = `<div class="meta">${esc(m.from)} · ${tstr(m.createdAt)}</div>`;
      const body = `<div>${esc(m.text||'')}</div>`;
      el.innerHTML = meta + body;
      messagesDiv.appendChild(el);
    });
    // auto-scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // ----------------- send message -----------------
  sendBtn.addEventListener('click', async ()=>{
    if(!activeChatId) return showToast('Откройте чат');
    const txt = (messageText.value||'').trim();
    if(!txt) return;
    try {
      // add message
      const msgObj = { from: profile.email, text: txt, createdAt: FieldValue.serverTimestamp(), type: 'text' };
      await db.collection('chats').doc(activeChatId).collection('messages').add(msgObj);
      // update chat preview & updatedAt
      await db.collection('chats').doc(activeChatId).set({ lastMessage: txt, updatedAt: FieldValue.serverTimestamp() }, { merge: true });
      messageText.value = '';
    } catch(e){ console.error('send message', e); showToast('Ошибка отправки сообщения'); }
  });

  // enter to send
  messageText.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendBtn.click(); });

  // ----------------- simple initialization -----------------
  // show login modal until authed
  window.addEventListener('load', ()=>{
    // modal visibility is controlled by auth state; ensure hidden by default
    modalLogin.style.display = 'none';
    // if not logged in, onAuthStateChanged will show modal
    if(!auth.currentUser) modalLogin.style.display = 'flex';
  });

  // --------------- Helpful debugging / instructions ---------------
  // If chаты не показываются: проверь Firestore rules (для теста временно):
  // rules_version = '2';
  // service cloud.firestore {
  //   match /databases/{database}/documents {
  //     match /{document=**} {
  //       allow read, write: if true;
  //     }
  //   }
  // }
  //
  // Потом верни безопасные правила.
  //
  // Если видишь ошибки в консоли — скопируй их сюда, я помогу.
  //
  // Структура БД:
  // /users/{uid} -> { email, name, login, about, ... }
  // /chats/{chatId} -> { participants: [emailA, emailB], lastMessage, updatedAt }
  // /chats/{chatId}/messages/{msgId} -> { from, text, createdAt, type }
  //
  // ----------------- Конец кода -----------------
  </script>
</body>
</html>
