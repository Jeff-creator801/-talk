<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>$Talk ‚Äî Firebase (—Å –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏)</title>
<meta name="theme-color" content="#1e90ff" />
<style>
/* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ ‚Äî —Ç–µ–º–∞ light/dark, –ø—Ä–æ—Å—Ç–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
:root{
  --primary:#1e90ff; --primary-strong:#1673d6; --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --text:#111;
  --bubble-me:#dbeafe; --bubble-you:#f2f3f5; --danger:#ff4d4f;
}
[data-theme="dark"]{
  --primary:#4aa3ff; --primary-strong:#2b7fe8; --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --text:#e6eef8;
  --bubble-me:#08306b; --bubble-you:#15202b; --danger:#ff7575;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100vh}
/* Header */
.header{height:56px;background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;display:flex;align-items:center;padding:8px 12px;gap:12px}
.menu-btn{width:40px;height:40;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.theme-toggle{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 8px;border-radius:8px;cursor:pointer}

/* Layout */
.main{display:flex;flex:1;overflow:hidden}
.left{width:320px;max-width:100%;border-right:1px solid rgba(0,0,0,0.06);background:var(--card);display:flex;flex-direction:column}
.search{padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg)}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:var(--card);cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.meta{flex:1}
.name{font-weight:700}
.last{color:var(--muted);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.time{font-size:12px;color:var(--muted)}
.badge{background:var(--danger);color:#fff;padding:3px 7px;border-radius:999px;font-size:12px;margin-left:8px}

/* Chat area */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--card)}
.chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);gap:8px}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.chat-title{font-weight:700;cursor:pointer}
.chat-sub{font-size:12px;color:var(--muted)}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(var(--card),var(--bg));-webkit-overflow-scrolling:touch}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative}
.msg.me{align-self:flex-end;background:var(--bubble-me)}
.msg.you{align-self:flex-start;background:var(--bubble-you)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.msg .checks{font-weight:700;margin-left:6px;color:var(--muted)}
.sticker{font-size:36px;line-height:1}

/* Composer */
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);align-items:center}
.composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.btn{background: var(--primary);color: #fff;border: none;padding: 10px 12px;border-radius: 10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
.small{padding:8px 10px;font-size:14px}

/* Drawer / modal */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--card);padding:16px;border-radius:10px;max-width:420px;width:92%}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:200}

/* Stickers */
.sticker-panel{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:transparent}
.sticker-btn{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:1px solid rgba(0,0,0,0.04);background:var(--card)}

@media(max-width:720px){
  .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20}
  .drawer{width:92%}
  .chat-title{font-size:16px}
}
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <div class="header">
    <div id="menuBtn" class="menu-btn" title="–ú–µ–Ω—é">‚ò∞</div>
    <div class="title">$Talk</div>
    <div class="header-right">
      <button id="themeToggle" class="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">–¢–µ–º–∞</button>
      <div id="userName" style="min-width:90px;text-align:right">–ì–æ—Å—Ç—å</div>
    </div>
  </div>

  <div class="main">
    <div id="leftPane" class="left">
      <div class="search">
        <input id="searchInput" placeholder="$–ª–æ–≥–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä $alex)" />
        <button id="newChatBtn" class="btn small">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="chats" class="chats"></div>
    </div>

    <div class="chat-area" id="chatArea">
      <div id="chatHeader" class="chat-header" style="display:none">
        <div id="backBtn" class="back-btn">‚Üê</div>
        <div>
          <div id="chatTitle" class="chat-title">–ß–∞—Ç</div>
          <div id="chatSub" class="chat-sub"></div>
        </div>
      </div>

      <div id="messages" class="messages">
        <div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ $–ª–æ–≥–∏–Ω—É</div>
      </div>

      <div id="composer" class="composer" style="display:none">
        <button id="stickerToggle" class="btn ghost small">üòÄ</button>
        <input id="messageText" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <h3>–ú–µ–Ω—é</h3>
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
      <button id="openProfileBtn" class="btn ghost">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
      <button id="openSettingsBtn" class="btn ghost">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button id="walletBtn" class="btn ghost">–ö–æ—à–µ–ª—ë–∫ (—Å–∫–æ—Ä–æ)</button>
    </div>

    <hr style="margin:12px 0"/>

    <div id="profilePanel" style="margin-top:8px">
      <div><label>–ò–º—è</label><input id="d_name" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px" /></div>
      <div style="margin-top:8px"><label>–õ–æ–≥–∏–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å $)</label><input id="d_login" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px" /></div>
      <div style="margin-top:8px"><label>–û —Å–µ–±–µ (‚â§100)</label><textarea id="d_about" maxlength="100" rows="3" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="avatarInput" type="file" accept="image/*" style="flex:1"/>
        <button id="d_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="d_logout" class="btn ghost">–í—ã–π—Ç–∏</button></div>
    </div>
  </div>

  <div id="overlay" class="overlay"></div>

  <div id="modalLogin" class="modal-back">
    <div class="modal">
      <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div style="margin-top:8px"><input id="loginEmail" placeholder="Email" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"/></div>
      <div style="margin-top:8px"><input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å (6+)" type="password" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)"/></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
        <button id="btnRegister" class="btn small">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
      <div id="loginHint" style="margin-top:10px;color:var(--muted)">–ï—Å–ª–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å Firestore rules.</div>
    </div>
  </div>

  <div id="modalStickers" class="modal-back">
    <div class="modal">
      <h3>–°—Ç–∏–∫–µ—Ä—ã</h3>
      <div class="sticker-panel" id="stickerPanel"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="closeStickers" class="btn small">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
/* ----------------- –ö–æ–Ω—Ñ–∏–≥ Firebase (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) ----------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
  authDomain: "talk-f1ff9.firebaseapp.com",
  databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
  projectId: "talk-f1ff9",
  storageBucket: "talk-f1ff9.firebasestorage.app",
  messagingSenderId: "856136352939",
  appId: "1:856136352939:web:87c28128d4951f909f63ee",
  measurementId: "G-3KDE4QT7PF"
};
firebase.initializeApp(firebaseConfig);
const fbAuth = firebase.auth();
const fbDb = firebase.firestore();
const fbStorage = firebase.storage();

/* ----------------- DOM refs ----------------- */
const appEl = document.getElementById('app');
const themeToggle = document.getElementById('themeToggle');
const menuBtn = document.getElementById('menuBtn');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const leftPane = document.getElementById('leftPane');
const searchInput = document.getElementById('searchInput');
const newChatBtn = document.getElementById('newChatBtn');
const chatsDiv = document.getElementById('chats');

const chatHeader = document.getElementById('chatHeader');
const backBtn = document.getElementById('backBtn');
const chatTitle = document.getElementById('chatTitle');
const chatSub = document.getElementById('chatSub');
const messagesDiv = document.getElementById('messages');
const composer = document.getElementById('composer');
const messageText = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');
const stickerToggle = document.getElementById('stickerToggle');

const userNameEl = document.getElementById('userName');

const modalLogin = document.getElementById('modalLogin');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');

const modalStickers = document.getElementById('modalStickers');
const stickerPanel = document.getElementById('stickerPanel');
const closeStickers = document.getElementById('closeStickers');

const d_name = document.getElementById('d_name');
const d_login = document.getElementById('d_login');
const d_about = document.getElementById('d_about');
const d_save = document.getElementById('d_save');
const d_logout = document.getElementById('d_logout');
const avatarInput = document.getElementById('avatarInput');

const toast = document.getElementById('toast');

/* ----------------- state ----------------- */
let me = null;
let profile = null;
let activeChatId = null;
let activeChatOther = null;
let listeners = { chats:null, messages:null };

/* ----------------- utils ----------------- */
function showToast(t){ toast.textContent = t; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2400); }
function esc(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function nowISO(){ return new Date().toISOString(); }

/* ----------------- theme ----------------- */
const THEME_KEY = 'talk_theme';
function loadTheme(){
  const t = localStorage.getItem(THEME_KEY) || 'light';
  appEl.setAttribute('data-theme', t);
  themeToggle.textContent = t === 'dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å';
}
function toggleTheme(){
  const cur = appEl.getAttribute('data-theme') || 'light';
  const next = cur === 'dark' ? 'light' : 'dark';
  appEl.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY, next);
  themeToggle.textContent = next === 'dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å';
}
themeToggle.addEventListener('click', ()=> toggleTheme());

/* ----------------- drawer ----------------- */
menuBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); });
overlay.addEventListener('click', closeDrawer);
function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }

/* ----------------- stickers ----------------- */
const STICKERS = ['üòÄ','üòÇ','üòç','üò≠','üòé','ü§Ø','üî•','üéâ','‚ù§Ô∏è','üëç','ü§ñ','ü¶ä','üçï','üåà'];
function renderStickers(){
  stickerPanel.innerHTML = '';
  STICKERS.forEach(s=>{
    const b = document.createElement('button');
    b.className = 'sticker-btn';
    b.innerHTML = `<span class="sticker">${s}</span>`;
    b.onclick = ()=>{ sendSticker(s); closeModal(modalStickers); };
    stickerPanel.appendChild(b);
  });
}
stickerToggle.addEventListener('click', ()=> openModal(modalStickers));
closeStickers.addEventListener('click', ()=> closeModal(modalStickers));

/* ----------------- modals ----------------- */
function openModal(el){ el.style.display = 'flex'; }
function closeModal(el){ el.style.display = 'none'; }

/* ----------------- ensure chats collection exists ----------------- */
/*
 If Firestore has strict rules or is empty, client queries may fail.
 This function tries to query 1 doc; if empty it creates a small _meta doc so the collection exists.
 UI will ignore document with id '_meta'.
*/
async function ensureChatsCollection(){
  try{
    const snap = await fbDb.collection('chats').limit(1).get();
    if(snap.empty){
      // create a small meta doc. It's ignored by UI.
      await fbDb.collection('chats').doc('_meta').set({ meta:true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      console.info('chats._meta created');
    }
  } catch(err){
    console.warn('ensureChatsCollection error', err);
    // handle permission errors specially
    if(err && err.code === 'permission-denied'){
      showToast('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore (permission-denied). –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ –≤ Firebase Console.');
      document.getElementById('loginHint').textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –æ—Ç–∫—Ä–æ–π Firestore rules –¥–ª—è —Ç–µ—Å—Ç–∞.';
    } else {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é —á–∞—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å.');
    }
  }
}

/* ----------------- Auth ----------------- */
btnRegister.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim();
  const pass = (loginPass.value||'').trim();
  if(!email || !pass || pass.length < 6) return showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏ –ø–∞—Ä–æ–ª—å ‚â•6');
  try{
    const cred = await fbAuth.createUserWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    const defaultLogin = '$' + email.split('@')[0].replace(/[^a-z0-9]/ig,'').slice(0,12);
    let loginToUse = defaultLogin;
    const q = await fbDb.collection('users').where('login','==', loginToUse).get();
    if(!q.empty) loginToUse = defaultLogin + '_' + Math.random().toString(36).slice(2,5);
    const profileDoc = { uid, email, login: loginToUse, name: '', about:'', avatarUrl:'', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await fbDb.collection('users').doc(uid).set(profileDoc);
    showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
    closeModal(modalLogin);
  } catch(e){
    console.error('register err', e);
    showToast(e.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
  }
});

btnLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim();
  const pass = (loginPass.value||'').trim();
  if(!email || !pass) return showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  try{
    await fbAuth.signInWithEmailAndPassword(email, pass);
    closeModal(modalLogin);
  } catch(e){
    console.error('login err', e);
    if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password'){
      showToast('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    } else {
      showToast(e.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
    }
  }
});

/* ----------------- load/save profile ----------------- */
async function loadProfile(uid){
  try{
    const doc = await fbDb.collection('users').doc(uid).get();
    if(doc.exists){ profile = doc.data(); profile.uid = uid; userNameEl.textContent = profile.name || profile.login || profile.email; return profile; }
    return null;
  } catch(e){
    console.error('loadProfile err', e);
    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–æ–≤–µ—Ä—å Firestore rules.');
    return null;
  }
}

/* save profile (avatar upload included) */
d_save.addEventListener('click', async ()=>{
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  const name = (d_name.value||'').trim();
  let loginVal = (d_login.value||'').trim();
  const about = (d_about.value||'').trim();
  if(!loginVal.startsWith('$')) return showToast('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $');
  try{
    // check unique
    const q = await fbDb.collection('users').where('login','==', loginVal).get();
    let conflict = false;
    q.forEach(doc => { if(doc.id !== profile.uid) conflict = true; });
    if(conflict) return showToast('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
    // avatar
    if(avatarInput.files && avatarInput.files[0]){
      const file = avatarInput.files[0];
      const ref = fbStorage.ref().child(`avatars/${profile.uid}_${Date.now()}.jpg`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about, avatarUrl: url }, { merge:true });
    } else {
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about }, { merge:true });
    }
    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  } catch(e){
    console.error('save profile err', e);
    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è. –°–º. –∫–æ–Ω—Å–æ–ª—å');
  }
});

/* logout */
d_logout.addEventListener('click', async ()=>{
  try{
    await fbAuth.signOut();
    profile = null; me = null; userNameEl.textContent = '–ì–æ—Å—Ç—å';
    if(listeners.chats) listeners.chats(); listeners.chats = null;
    if(listeners.messages) listeners.messages(); listeners.messages = null;
    openModal(modalLogin);
  } catch(e){ console.error('logout err', e); }
});

/* ----------------- subscribe to chats (realtime) ----------------- */
async function subscribeChats(){
  if(!profile) return;
  try{
    // ensure collection exists (helps when Firestore empty)
    await ensureChatsCollection();
    if(listeners.chats) listeners.chats();
    listeners.chats = fbDb.collection('chats').where('participants','array-contains', profile.login).orderBy('updatedAt','desc')
      .onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>{
          if(d.id === '_meta') return; // ignore meta doc
          arr.push({ id:d.id, ...d.data() });
        });
        renderChatsUI(arr);
      }, err=>{
        console.error('chats snapshot err', err);
        if(err && err.code === 'permission-denied'){
          showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É (permission-denied). –ü—Ä–æ–≤–µ—Ä—å Firestore rules.');
        } else {
          showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Å–æ–ª—å.');
        }
      });
  } catch(e){
    console.error('subscribeChats err', e);
    if(e && e.code === 'permission-denied'){
      showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore (permission-denied). –û—Ç–∫—Ä–æ–π –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∞.');
    } else {
      showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —á–∞—Ç—ã. –°–º. –∫–æ–Ω—Å–æ–ª—å.');
    }
  }
}

/* render chats UI */
function renderChatsUI(chatsArr){
  chatsDiv.innerHTML = '';
  if(!chatsArr.length){ chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤ ‚Äî –Ω–∞–π–¥–∏—Ç–µ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å –ø–æ $–ª–æ–≥–∏–Ω—É</div>'; return; }
  chatsArr.forEach(c=>{
    const other = c.participants.find(p=> p !== profile.login) || c.participants[0];
    const el = document.createElement('div'); el.className='chat-item';
    el.innerHTML = `<div class="ava">${esc(other.slice(0,2)).toUpperCase()}</div>
      <div class="meta"><div class="name">${esc(other)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
      <div class="time">${c.updatedAt ? new Date(c.updatedAt.toDate ? c.updatedAt.toDate() : c.updatedAt).toLocaleTimeString() : ''}</div>`;
    el.addEventListener('click', ()=> openChat(c.id, other));
    chatsDiv.appendChild(el);
  });
}

/* ----------------- create/open chat */
newChatBtn.addEventListener('click', ()=> createOrOpenChatWith((searchInput.value||'').trim()));
async function createOrOpenChatWith(otherLogin){
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  if(!otherLogin || !otherLogin.startsWith('$')) return showToast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å $');
  try{
    const snap = await fbDb.collection('users').where('login','==', otherLogin).limit(1).get();
    if(snap.empty) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    // check existing chat that contains both participants
    const chatsSnap = await fbDb.collection('chats').where('participants','array-contains', profile.login).get();
    let found = null;
    chatsSnap.forEach(d=>{
      const data = d.data();
      if(Array.isArray(data.participants) && data.participants.includes(otherLogin)) found = { id:d.id, ...data };
    });
    if(found){ openChat(found.id, otherLogin); return; }
    // create chat document
    const ref = await fbDb.collection('chats').add({ participants: [profile.login, otherLogin], lastMessage:'', updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    openChat(ref.id, otherLogin);
  } catch(e){
    console.error('createOrOpenChat err', e);
    if(e && e.code === 'permission-denied') showToast('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ (permission-denied).');
    else showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–∏—Å–∫–∞ —á–∞—Ç–∞');
  }
}

/* ----------------- open chat & messages (realtime) ----------------- */
async function openChat(chatId, otherLogin){
  activeChatId = chatId;
  activeChatOther = otherLogin || null;
  chatHeader.style.display = 'flex';
  composer.style.display = 'flex';
  chatTitle.textContent = otherLogin || '–ß–∞—Ç';
  chatSub.textContent = '';
  // unsubscribe previous messages
  if(listeners.messages) listeners.messages();
  // subscribe to messages sorted by createdAt
  const msgsRef = fbDb.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
  listeners.messages = msgsRef.onSnapshot(async snap=>{
    const arr = [];
    snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
    renderMessagesUI(arr);
    // delivered marking
    for(const m of arr){
      if(m.from !== profile.login && !m.deliveredAt){
        try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(m.id).update({ deliveredAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
      }
    }
    // mark read
    markMessagesReadFirebase(chatId);
  }, err=>{
    console.error('messages snapshot err', err);
    if(err && err.code === 'permission-denied') showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º (permission-denied).');
    else showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.');
  });
  if(window.innerWidth < 720) leftPane.style.display = 'none';
}

/* render messages */
function renderMessagesUI(msgs){
  messagesDiv.innerHTML = '';
  if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–ß–∞—Ç –ø—É—Å—Ç</div>'; return; }
  msgs.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === profile.login ? 'me' : 'you');
    const checks = (m.from === profile.login) ? (m.readAt ? '‚úì‚úì' : (m.deliveredAt ? '‚úì' : '')) : '';
    const created = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleTimeString() : (m.createdAt||'');
    const metaHtml = `<div class="meta"><span>${esc(m.from)}</span> ¬∑ <span>${created}</span><span class="checks">${esc(checks)}</span></div>`;
    let bodyHtml = '';
    if(m.sticker) bodyHtml = `<div class="sticker">${esc(m.sticker)}</div>`; else bodyHtml = `<div>${esc(m.text||'')}</div>`;
    el.innerHTML = metaHtml + bodyHtml;
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(m.from === profile.login) showMessageActions(m); });
    el.addEventListener('dblclick', ()=>{ if(m.from !== profile.login) viewProfileByLogin(m.from); });
    messagesDiv.appendChild(el);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* message actions (edit/delete) */
function showMessageActions(m){
  const choice = prompt('–í–≤–µ–¥–∏—Ç–µ "edit" —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, "delete" —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å. –û—Ç–º–µ–Ω–∞ ‚Äî –ø—É—Å—Ç–æ.');
  if(!choice) return;
  if(choice === 'delete'){
    if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) deleteMessage(activeChatId, m.id);
  } else if(choice === 'edit'){
    const newText = prompt('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', m.text||'');
    if(newText !== null) editMessage(activeChatId, m.id, newText);
  }
}
async function deleteMessage(chatId, msgId){
  try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).delete(); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'); } catch(e){ console.error('delete msg err', e); showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
}
async function editMessage(chatId, msgId, newText){
  try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).update({ text: newText, edited:true }); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ'); } catch(e){ console.error('edit msg err', e); showToast('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); }
}

/* send text/sticker */
sendBtn.addEventListener('click', ()=> sendText());
messageText.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendText(); });

async function sendText(){
  if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
  const txt = (messageText.value||'').trim();
  if(!txt) return;
  try{
    await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text: txt, sticker:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false });
    await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: txt, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    messageText.value = '';
  } catch(e){ console.error('sendText err', e); if(e.code === 'permission-denied') showToast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π'); else showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}

async function sendSticker(st){
  if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
  try{
    await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text:'', sticker:st, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false });
    await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: '[–°—Ç–∏–∫–µ—Ä]', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
  } catch(e){ console.error('sendSticker err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞'); }
}

/* mark read */
async function markMessagesReadFirebase(chatId){
  if(!profile) return;
  try{
    const q = await fbDb.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.login).where('readAt','==', null).get();
    const batch = fbDb.batch();
    q.forEach(docSnap => batch.update(docSnap.ref, { readAt: firebase.firestore.FieldValue.serverTimestamp() }) );
    await batch.commit();
  } catch(e){ console.error('mark read err', e); }
}

/* view profile by login */
async function viewProfileByLogin(login){
  try{
    const snap = await fbDb.collection('users').where('login','==', login).limit(1).get();
    if(snap.empty) return showToast('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const d = snap.docs[0].data();
    alert(`–ü—Ä–æ—Ñ–∏–ª—å:\n–ò–º—è: ${d.name || '-'}\n–õ–æ–≥–∏–Ω: ${d.login}\n–û —Å–µ–±–µ: ${d.about || '-'}\nEmail: ${d.email || '-'}`);
  } catch(e){ console.error('viewProfile err', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è'); }
}

/* open/close UI helpers */
menuBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); overlay.classList.add('show'); });
document.querySelectorAll('.modal-back').forEach(el=> el.addEventListener('click', (ev)=>{ if(ev.target === el) el.style.display='none'; }));
function closeChat(){ activeChatId = null; activeChatOther = null; composer.style.display='none'; chatHeader.style.display='none'; messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ $–ª–æ–≥–∏–Ω—É</div>'; if(window.innerWidth < 720) leftPane.style.display = 'block'; }
backBtn.addEventListener('click', ()=> closeChat());

/* drawer controls */
openProfileBtn.addEventListener('click', ()=> { drawer.classList.remove('open'); overlay.classList.remove('show'); openProfileEditor(); });
openSettingsBtn.addEventListener('click', ()=> { drawer.classList.remove('open'); overlay.classList.remove('show'); openSettings(); });
document.getElementById('walletBtn').addEventListener('click', ()=> showToast('–ö–æ—à–µ–ª—ë–∫ –ø–æ—è–≤–∏—Ç—Å—è —Å–∫–æ—Ä–æ ‚Äî —Å–ª–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'));

function openProfileEditor(){
  if(!profile) return openModal(modalLogin);
  d_name.value = profile.name || '';
  d_login.value = profile.login || '';
  d_about.value = profile.about || '';
  drawer.classList.add('open'); overlay.classList.add('show');
}
function openSettings(){ drawer.classList.add('open'); overlay.classList.add('show'); }

/* ----------------- auth state init ----------------- */
loadTheme();
renderStickers();

fbAuth.onAuthStateChanged(async (user)=>{
  if(user){
    me = user;
    await loadProfile(user.uid);
    await subscribeChats(); // subscribe with ensureChatsCollection
    closeModal(modalLogin);
  } else {
    me = null; profile = null;
    openModal(modalLogin);
  }
});

/* Optional: seed helper removed (don't auto-seed) */

/* Done. –ö–æ–¥ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω:
   - –ø–æ–¥–ø–∏—Å–∫–∏/–æ—Ç–ø–∏—Å–∫–∏ listeners
   - ensureChatsCollection —Å–æ–∑–¥–∞–µ—Ç _meta, UI –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç _meta
   - –æ—à–∏–±–∫–∏ permission-denied –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ —Å–æ–≤–µ—Ç—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
*/
</script>
</body>
</html>
