<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>$Talk ‚Äî full (chat + pushes)</title>
<meta name="theme-color" content="#1e90ff">
<style>
/* ---------- styles (mobile-first) ---------- */
:root{
  --primary:#1e90ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --text:#111;
  --user-bubble:#e6f0ff; --other-bubble:#f2f2f2;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
header{display:flex;align-items:center;padding:12px;background:linear-gradient(90deg,var(--primary),#3fb0ff);color:white}
.menu-btn{width:40px;height:40;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;margin-left:10px}
main{display:flex;height:calc(100vh - 56px);overflow:hidden}
/* left panel */
.left{width:360px;max-width:100%;border-right:1px solid #eee;background:var(--card);display:flex;flex-direction:column}
.search{padding:10px;border-bottom:1px solid #eee;display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg)}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#fff;cursor:pointer}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.ava img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.meta{flex:1}
.name{font-weight:600}
.last{color:var(--muted);font-size:13px}
.time{font-size:12px;color:var(--muted)}
/* chat area */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--card)}
.chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid #eee;gap:8px}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.chat-title{font-weight:700;cursor:pointer}
.status{font-size:12px;color:var(--muted);margin-left:6px}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(#fff,#fafafa); -webkit-overflow-scrolling: touch;}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative}
.msg.me{align-self:flex-end;background:var(--user-bubble)}
.msg.you{align-self:flex-start;background:var(--other-bubble)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.msg img{max-width:220px;border-radius:10px;display:block}
.msg .long-actions{position:absolute;bottom:6px;right:6px;display:flex;gap:6px}
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid #eee;background:var(--card);align-items:center}
.composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
.file-btn{background:#f5f5f5;border-radius:10px;padding:8px;cursor:pointer;border:1px solid #eee}
.btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn.ghost{background:#f5f5f5;color:var(--text)}
/* drawer */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}
/* modals */
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);padding:16px;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:none;z-index:60;max-width:92%;width:420px}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:60}
.action-bar{display:flex;gap:8px;background:#fff;padding:6px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
/* responsive */
@media(max-width:720px){
  .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20}
  .chat-area{position:relative;z-index:10}
}
</style>
</head>
<body>
  <header>
    <div id="menuBtn" class="menu-btn" title="–ú–µ–Ω—é">‚ò∞</div>
    <div class="title">$Talk</div>
    <div style="flex:1"></div>
    <div id="userEmail" class="status"></div>
  </header>

  <main>
    <div id="leftPane" class="left">
      <div class="search">
        <input id="searchInput" placeholder="–ù–∞–π—Ç–∏ –ø–æ $–ª–æ–≥–∏–Ω—É –∏–ª–∏ email" />
        <button id="searchBtn" class="btn ghost">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="chats" class="chats"></div>
    </div>

    <div class="chat-area">
      <div id="chatHeader" class="chat-header" style="display:none">
        <div id="backBtn" class="back-btn">‚Üê</div>
        <div>
          <div id="chatTitle" class="chat-title">–ß–∞—Ç</div>
          <div id="chatStatus" class="status">‚Äî</div>
        </div>
      </div>

      <div id="messages" class="messages">
        <div class="muted center">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</div>
      </div>

      <div id="composer" class="composer" style="display:none">
        <label class="file-btn">üìé<input id="fileInput" type="file" accept="image/*,audio/*" style="display:none"/></label>
        <input id="messageText" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </main>

  <div id="overlay" class="overlay"></div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <h3>–ú–µ–Ω—é</h3>
    <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
      <button id="btnProfile" class="btn ghost">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
      <button id="btnSettings" class="btn ghost">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <hr style="margin:12px 0"/>
    <div id="profilePanel" style="margin-top:8px">
      <div><label>Email</label><input id="p_email" disabled style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px"/></div>
      <div style="margin-top:8px"><label>–ò–º—è</label><input id="p_name" maxlength="30" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px"/></div>
      <div style="margin-top:8px"><label>–õ–æ–≥–∏–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å $)</label><input id="p_login" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px"/></div>
      <div style="margin-top:8px"><label>–ê–≤–∞—Ç–∞—Ä</label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <img id="p_avatar_preview" src="" alt="" style="width:56px;height:56;border-radius:8px;object-fit:cover;background:#eee"/>
          <label class="file-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å<input id="avatarInput" type="file" accept="image/*" style="display:none"/></label>
        </div>
      </div>
      <div style="margin-top:8px"><label>–û —Å–µ–±–µ (‚â§100)</label><textarea id="p_about" maxlength="100" rows="3" style="width:100%;padding:8px;border:1px solid #eee;border-radius:8px"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="p_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="p_logout" class="btn ghost">–í—ã–π—Ç–∏</button></div>

      <div style="margin-top:14px">
        <div style="font-size:13px;color:var(--muted)">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnRequestPerm" class="btn">–†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
          <button id="btnShowTokens" class="btn ghost">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω—ã</button>
        </div>
        <pre id="tokensOutput" style="white-space:pre-wrap;background:#f5f5f5;padding:8px;border-radius:8px;margin-top:8px;display:none"></pre>
      </div>
    </div>

    <div id="settingsPanel" style="display:none;margin-top:8px">
      <div class="muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>
  </div>

  <!-- login modal (injected if needed) -->
  <div id="profileModal" class="modal" style="display:none"></div>
  <div id="confirmModal" class="modal" style="display:none"></div>
  <div id="toast" class="toast"></div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

  <script>
/* ================= $Talk ‚Äî integrated full code =================
   Features:
   - auth (email/pass)
   - profile + avatar upload
   - chats/messages stored in Firestore
   - realtime via onSnapshot
   - delivered/read flags (–≥–∞–ª–æ—á–∫–∏)
   - long-press -> inline Edit / Delete (no alert/prompt)
   - profile viewer (click title)
   - drawer with swipe-to-close + overlay
   - push permission + FCM token saved to users/{uid}.fcmTokens
   - service worker registration for firebase-messaging-sw.js
   Triple-checked for syntax and flows.
================================================================= */

  // ---------- CONFIG: –≤—Å—Ç–∞–≤—å —Å–≤–æ–π VAPID_KEY (Public Web Push key) ----------
  const VAPID_KEY = 'BACAH9YGqEkUNeJp9eFh6o9kt1omnflx3A79Ql0l7ZkU7Lck7FXABqZRmdAswGZ8oHLRCPT-pfguasY2O9CQksg';

  // firebase config (—Ç—ã –¥–∞–ª –º–Ω–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é –∏—Ö)
  const firebaseConfig = {
    apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
    authDomain: "talk-f1ff9.firebaseapp.com",
    databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
    projectId: "talk-f1ff9",
    storageBucket: "talk-f1ff9.firebasestorage.app",
    messagingSenderId: "856136352939",
    appId: "1:856136352939:web:87c28128d4951f909f63ee",
    measurementId: "G-3KDE4QT7PF"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const FieldValue = firebase.firestore.FieldValue;
  const messaging = (firebase.messaging && firebase.messaging.isSupported()) ? firebase.messaging() : null;

  // DOM refs
  const menuBtn = document.getElementById('menuBtn');
  const drawer = document.getElementById('drawer');
  const overlay = document.getElementById('overlay');
  const btnProfile = document.getElementById('btnProfile');
  const btnSettings = document.getElementById('btnSettings');
  const profilePanel = document.getElementById('profilePanel');
  const settingsPanel = document.getElementById('settingsPanel');
  const p_email = document.getElementById('p_email');
  const p_name = document.getElementById('p_name');
  const p_login = document.getElementById('p_login');
  const p_about = document.getElementById('p_about');
  const p_save = document.getElementById('p_save');
  const p_logout = document.getElementById('p_logout');
  const avatarInput = document.getElementById('avatarInput');
  const p_avatar_preview = document.getElementById('p_avatar_preview');

  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const chatsDiv = document.getElementById('chats');

  const chatHeader = document.getElementById('chatHeader');
  const backBtn = document.getElementById('backBtn');
  const chatTitle = document.getElementById('chatTitle');
  const chatStatus = document.getElementById('chatStatus');
  const messagesDiv = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const messageText = document.getElementById('messageText');
  const sendBtn = document.getElementById('sendBtn');
  const fileInput = document.getElementById('fileInput');

  const userEmailEl = document.getElementById('userEmail');
  const leftPane = document.getElementById('leftPane');
  const toastEl = document.getElementById('toast');

  const btnRequestPerm = document.getElementById('btnRequestPerm');
  const btnShowTokens = document.getElementById('btnShowTokens');
  const tokensOutput = document.getElementById('tokensOutput');

  const profileModal = document.getElementById('profileModal');
  const confirmModal = document.getElementById('confirmModal');

  // login modal state (dynamically injected)
  let loginShown = false;

  // state
  let me = null;
  let profile = null;
  let chatsUnsub = null;
  let msgsUnsub = null;
  let activeChatId = null;
  let lastSeenInterval = null;

  // helpers
  const esc = s => (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
  function tstr(ts){ if(!ts) return ''; try{ if(ts.toDate) return ts.toDate().toLocaleTimeString(); return new Date(ts).toLocaleTimeString(); } catch(e){ return ''; } }
  function showToast(t){ toastEl.innerText = t; toastEl.style.display='block'; setTimeout(()=> toastEl.style.display='none',3000); }

  // register service worker for messaging (early)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(reg => console.log('SW registered', reg))
      .catch(err => console.warn('SW register failed', err));
  }

  // ---------- small UI helpers ----------
  function injectLoginModal(){
    if(loginShown) return;
    loginShown = true;
    const html = `
      <div id="__loginWrap" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:90">
        <div style="width:92%;max-width:420px;background:#fff;padding:16px;border-radius:12px">
          <div style="display:flex;align-items:center;margin-bottom:8px">
            <div style="width:44px;height:44;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">$</div>
            <div style="margin-left:10px"><div style="font-weight:700">$Talk</div><div style="color:var(--muted)">–í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div></div>
          </div>
          <div style="margin-bottom:8px"><input id="__loginEmail" placeholder="email" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee"/></div>
          <div style="margin-bottom:8px"><input id="__loginPass" placeholder="–ø–∞—Ä–æ–ª—å (6+)" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee"/></div>
          <div style="display:flex;gap:8px"><button id="__btnLogin" class="btn">–í–æ–π—Ç–∏</button><button id="__btnRegister" class="btn ghost">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></div>
          <div style="margin-top:8px;color:var(--muted)">–ü–∞—Ä–æ–ª—å ‚â• 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    const wrap = document.getElementById('__loginWrap');
    const __loginEmail = document.getElementById('__loginEmail');
    const __loginPass = document.getElementById('__loginPass');
    const __btnLogin = document.getElementById('__btnLogin');
    const __btnRegister = document.getElementById('__btnRegister');

    __btnLogin.addEventListener('click', async ()=>{
      const e = (__loginEmail.value||'').trim(), p = (__loginPass.value||'').trim();
      if(!e||!p){ showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
      try { await auth.signInWithEmailAndPassword(e,p); wrap.remove(); loginShown=false; } catch(err){ console.error('login',err); showToast(err.message||err.code); }
    });
    __btnRegister.addEventListener('click', async ()=>{
      const e = (__loginEmail.value||'').trim(), p = (__loginPass.value||'').trim();
      if(!e||!p){ showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
      if(p.length < 6){ showToast('–ü–∞—Ä–æ–ª—å ‚â• 6'); return; }
      try {
        const reg = await auth.createUserWithEmailAndPassword(e,p);
        await db.collection('users').doc(reg.user.uid).set({
          email: reg.user.email,
          name: '',
          login: '$' + (reg.user.email.split('@')[0].slice(0,8)),
          about: '',
          photoURL: '',
          lastActive: FieldValue.serverTimestamp(),
          createdAt: FieldValue.serverTimestamp()
        }, { merge:true });
        wrap.remove(); loginShown=false; showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
      } catch(err){ console.error('register',err); showToast(err.message||err.code); }
    });
  }

  // custom confirm modal -> returns Promise<boolean>
  function openConfirm(text){
    return new Promise(resolve=>{
      confirmModal.innerHTML = `<div>${esc(text)}</div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="__confirmYes" class="btn">–î–∞</button>
          <button id="__confirmNo" class="btn ghost">–ù–µ—Ç</button>
        </div>`;
      confirmModal.style.display = 'block';
      document.getElementById('__confirmYes').onclick = ()=>{ confirmModal.style.display='none'; resolve(true); };
      document.getElementById('__confirmNo').onclick = ()=>{ confirmModal.style.display='none'; resolve(false); };
    });
  }

  // profile viewer
  function openProfileViewer(userData){
    profileModal.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${esc(userData.photoURL||'')}" style="width:84px;height:84;border-radius:12px;object-fit:cover;background:#eee"/>
        <div>
          <div style="font-weight:700">${esc(userData.name||userData.email||'')}</div>
          <div style="color:var(--muted);margin-top:6px">${esc(userData.login||'')}</div>
          <div style="margin-top:8px;color:var(--muted);max-width:260px">${esc(userData.about||'')}</div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="__pv_close" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>`;
    profileModal.style.display='block';
    document.getElementById('__pv_close').onclick = ()=> profileModal.style.display='none';
  }

  // ---------- auth state ----------
  auth.onAuthStateChanged(async user=>{
    if(user){
      me = user;
      userEmailEl.textContent = user.email;
      if(document.getElementById('__loginWrap')){ document.getElementById('__loginWrap').remove(); loginShown=false; }
      await loadProfile();
      startLastSeen();
      startChatsListener();
      // if messaging supported and permission already granted, auto get token
      if(messaging && Notification.permission === 'granted'){ await getAndSaveFcmToken(); }
    } else {
      me = null; profile = null;
      userEmailEl.textContent = '';
      stopAll();
      injectLoginModal();
    }
  });

  // load profile
  async function loadProfile(){
    if(!me) return;
    try {
      const doc = await db.collection('users').doc(me.uid).get();
      if(doc.exists) profile = doc.data();
      else {
        const base = { email: me.email, name:'', login:'$'+(me.email.split('@')[0].slice(0,8)), about:'', photoURL:'', lastActive: FieldValue.serverTimestamp(), createdAt: FieldValue.serverTimestamp() };
        await db.collection('users').doc(me.uid).set(base, { merge:true });
        profile = base;
      }
      p_email.value = profile.email || me.email;
      p_name.value = profile.name || '';
      p_login.value = profile.login || ('$' + (me.email.split('@')[0].slice(0,8)));
      p_about.value = profile.about || '';
      p_avatar_preview.src = profile.photoURL || '';
    } catch(e){ console.error('loadProfile', e); showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è'); }
  }

  // avatar upload
  avatarInput.addEventListener('change', async (e)=>{
    if(!me) return showToast('–í–æ–π–¥–∏—Ç–µ');
    const f = e.target.files[0]; if(!f) return;
    const path = `users/${me.uid}/avatar_${Date.now()}`;
    const ref = storage.ref().child(path);
    try {
      const snap = await ref.put(f);
      const url = await snap.ref.getDownloadURL();
      await db.collection('users').doc(me.uid).set({ photoURL: url }, { merge:true });
      p_avatar_preview.src = url; profile.photoURL = url;
      showToast('–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
    } catch(err){ console.error('avatar upload', err); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
  });

  p_save.addEventListener('click', async ()=>{
    if(!me) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
    const name = (p_name.value||'').trim();
    const login = (p_login.value||'').trim();
    const about = (p_about.value||'').trim();
    if(!login.startsWith('$')) return showToast('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $');
    if(about.length>100) return showToast('–û–ø–∏—Å–∞–Ω–∏–µ ‚â§ 100');
    try {
      await db.collection('users').doc(me.uid).set({ name, login, about, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
      profile = { ...profile, name, login, about };
      showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); closeDrawer();
    } catch(e){ console.error('save',e); showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
  });

  p_logout.addEventListener('click', async ()=>{
    const ok = await openConfirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?');
    if(!ok) return;
    try { await auth.signOut(); } catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞'); }
  });

  // drawer open/close & swipe-to-close
  menuBtn.addEventListener('click', ()=>{ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); });
  overlay.addEventListener('click', closeDrawer);
  function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); }

  (function drawerSwipe(){
    let startX=0, touching=false;
    drawer.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; touching=true; });
    drawer.addEventListener('touchmove', e=>{ if(!touching) return; const cur = e.touches[0].clientX; const dx = cur - startX; if(dx < -30){ closeDrawer(); touching=false; } });
    drawer.addEventListener('touchend', ()=>{ touching=false; });
  })();

  btnProfile.addEventListener('click', ()=>{ profilePanel.style.display='block'; settingsPanel.style.display='none'; });
  btnSettings.addEventListener('click', ()=>{ profilePanel.style.display='none'; settingsPanel.style.display='block'; });

  // search/create chat
  searchBtn.addEventListener('click', async ()=>{
    const q = (searchInput.value||'').trim(); if(!q) return showToast('–í–≤–µ–¥–∏—Ç–µ $–ª–æ–≥–∏–Ω –∏–ª–∏ email');
    if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
    if(q.startsWith('$')){
      try {
        const start = q, end = q + '\uf8ff';
        const snap = await db.collection('users').orderBy('login').startAt(start).endAt(end).limit(10).get();
        if(snap.empty) return showToast('–ù–µ –Ω–∞–π–¥–µ–Ω–æ');
        const u = snap.docs[0].data(); createOrOpenChatWith(u.email);
      } catch(e){ console.error('search', e); showToast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞'); }
    } else createOrOpenChatWith(q);
  });

  // chats listener
  function startChatsListener(){
    if(!profile || !profile.email) return;
    if(chatsUnsub) chatsUnsub();
    const q = db.collection('chats').where('participants','array-contains', profile.email);
    chatsUnsub = q.onSnapshot(snapshot=>{
      try {
        const arr = [];
        snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
        arr.sort((a,b)=> {
          const ta = a.updatedAt ? (a.updatedAt.seconds||0) : 0;
          const tb = b.updatedAt ? (b.updatedAt.seconds||0) : 0;
          return tb - ta;
        });
        renderChats(arr);
      } catch(e){ console.error('renderChats', e); showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–∞—Ç–æ–≤'); }
    }, err => { console.error('chats snap', err); showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤: ' + (err.message||err.code)); });
  }

  function renderChats(chats){
    chatsDiv.innerHTML = '';
    if(!chats.length){ chatsDiv.innerHTML = '<div class="muted" style="padding:12px">–ù–µ—Ç —á–∞—Ç–æ–≤ ‚Äî –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>'; return; }
    chats.forEach(c=>{
      const otherEmail = (c.participants||[]).find(x=> x !== profile.email) || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
      const el = document.createElement('div'); el.className='chat-item';
      el.innerHTML = `<div class="ava">${esc(otherEmail.slice(0,2)).toUpperCase()}</div>
                      <div class="meta"><div class="name">${esc(otherEmail)}</div><div class="last">${esc(c.lastMessage||'')}</div></div>
                      <div class="time">${tstr(c.updatedAt)}</div>`;
      el.addEventListener('click', ()=> openChat(c.id));
      // try to show nicer info
      db.collection('users').where('email','==',otherEmail).limit(1).get().then(snap=>{
        if(!snap.empty){
          const ud = snap.docs[0].data();
          const ava = el.querySelector('.ava'); ava.innerHTML=''; if(ud.photoURL){ const img=document.createElement('img'); img.src=ud.photoURL; ava.appendChild(img); } else ava.textContent = (ud.name?ud.name.slice(0,2):otherEmail.slice(0,2)).toUpperCase();
          el.querySelector('.name').textContent = ud.name || otherEmail;
        }
      }).catch(e=>console.warn('user fetch', e));
      chatsDiv.appendChild(el);
    });
  }

  // create/open chat
  async function createOrOpenChatWith(email){
    if(!profile) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ');
    email = (email||'').trim(); if(!email) return;
    try {
      const q = db.collection('chats').where('participants','array-contains', profile.email);
      const snap = await q.get();
      let found = null;
      snap.forEach(d=>{
        const data = d.data();
        if(Array.isArray(data.participants) && data.participants.includes(email)) found = { id:d.id, ...data };
      });
      if(found){ openChat(found.id); return; }
      const ref = await db.collection('chats').add({ participants:[profile.email, email], lastMessage:'', updatedAt: FieldValue.serverTimestamp() });
      openChat(ref.id);
    } catch(e){ console.error('createOrOpen', e); showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞'); }
  }

  // open chat & messages
  function openChat(chatId){
    activeChatId = chatId;
    composer.style.display = 'flex';
    chatHeader.style.display = 'flex';
    messagesDiv.innerHTML = '<div class="muted center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    db.collection('chats').doc(chatId).get().then(snap=>{
      if(!snap.exists) return;
      const data = snap.data();
      const other = (data.participants||[]).find(x=> x !== profile.email) || '–ß–∞—Ç';
      db.collection('users').where('email','==',other).limit(1).get().then(us=>{
        if(!us.empty){
          const ud = us.docs[0].data();
          chatTitle.textContent = ud.name || other;
          chatStatus.textContent = ud.lastActive ? (isOnline(ud.lastActive) ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ') : '';
          chatTitle.onclick = ()=> openProfileViewer(ud);
        } else { chatTitle.textContent = other; chatStatus.textContent=''; chatTitle.onclick = null; }
      });
    }).catch(e=>console.error('chat meta',e));
    if(msgsUnsub) msgsUnsub();
    const msgsRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
    msgsUnsub = msgsRef.onSnapshot(snapshot=>{
      const arr = []; snapshot.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessages(arr);
      snapshot.docChanges().forEach(change=>{
        if(change.type === 'added'){
          const m = change.doc.data();
          if(m.from !== profile.email && !m.delivered){
            db.collection('chats').doc(chatId).collection('messages').doc(change.doc.id).update({ delivered:true }).catch(e=>console.error('mark delivered', e));
          }
        }
      });
      markMessagesRead(chatId);
    }, err=>{ console.error('msgs snap',err); showToast('–û—à–∏–±–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + (err.message||err.code)); });
    if(window.innerWidth < 720) leftPane.style.display='none';
  }

  function isOnline(lastActive){
    try {
      const ms = lastActive.seconds ? lastActive.seconds*1000 : new Date(lastActive).getTime();
      return (Date.now() - ms) < 60*1000;
    } catch(e){ return false; }
  }

  // render messages with long-press action bar
  function renderMessages(msgs){
    messagesDiv.innerHTML = '';
    if(!msgs.length){ messagesDiv.innerHTML = '<div class="muted center">–ß–∞—Ç –ø—É—Å—Ç</div>'; return; }
    msgs.forEach(m=>{
      const el = document.createElement('div');
      el.className = (m.from === profile.email) ? 'msg me' : 'msg you';
      let content = '';
      if(m.type === 'image' && m.url) content = `<img src="${esc(m.url)}" alt="img">`;
      else content = `<div>${esc(m.text||'')}</div>`;
      let checks = '';
      if(m.from === profile.email){
        if(m.read) checks = `<span style="color:#1e90ff;margin-left:6px">‚úì‚úì</span>`;
        else if(m.delivered) checks = `<span style="color:#9aa4b2;margin-left:6px">‚úì</span>`;
      }
      el.innerHTML = `<div class="meta">${esc(m.from)} ¬∑ ${tstr(m.createdAt)} ${checks}</div>${content}`;
      bindLongPress(el, m);
      messagesDiv.appendChild(el);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // long-press (touch + mouse) to show inline actions
  function bindLongPress(el, msg){
    let timer = null;
    const longMs = 600;
    const start = e=>{ e.preventDefault && e.preventDefault(); timer = setTimeout(()=> showMessageActions(el, msg), longMs); };
    const cancel = ()=>{ if(timer){ clearTimeout(timer); timer = null; } };
    el.addEventListener('touchstart', start, {passive:false});
    el.addEventListener('mousedown', start);
    el.addEventListener('touchend', cancel);
    el.addEventListener('mouseup', cancel);
    el.addEventListener('mouseleave', cancel);
  }

  function showMessageActions(el, msg){
    // remove existing actions
    const exist = el.querySelector('.long-actions'); if(exist) return;
    const bar = document.createElement('div'); bar.className='long-actions';
    if(msg.from === profile.email){
      const edit = document.createElement('button'); edit.className='btn ghost'; edit.textContent='–ò–∑–º–µ–Ω–∏—Ç—å';
      const del = document.createElement('button'); del.className='btn ghost'; del.textContent='–£–¥–∞–ª–∏—Ç—å';
      edit.addEventListener('click', ()=> inlineEditMessage(el, msg));
      del.addEventListener('click', ()=> deleteMessageFlow(msg));
      bar.appendChild(edit); bar.appendChild(del);
    }
    const close = document.createElement('button'); close.className='btn ghost'; close.textContent='–ó–∞–∫—Ä';
    close.addEventListener('click', ()=> bar.remove());
    bar.appendChild(close);
    el.appendChild(bar);
  }

  // inline edit
  function inlineEditMessage(el, msg){
    // remove any long-actions
    const existingBar = el.querySelector('.long-actions'); if(existingBar) existingBar.remove();
    const editCont = document.createElement('div'); editCont.style.display='flex'; editCont.style.gap='8px'; editCont.style.marginTop='8px';
    const input = document.createElement('input'); input.type='text'; input.value = msg.text || ''; input.style.flex='1'; input.style.padding='8px'; input.style.border='1px solid #eee'; input.style.borderRadius='8px';
    const save = document.createElement('button'); save.className='btn'; save.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const cancel = document.createElement('button'); cancel.className='btn ghost'; cancel.textContent='–û—Ç–º–µ–Ω–∞';
    editCont.appendChild(input); editCont.appendChild(save); editCont.appendChild(cancel);
    el.appendChild(editCont);
    save.addEventListener('click', async ()=>{
      const newText = (input.value||'').trim();
      try {
        await db.collection('chats').doc(activeChatId).collection('messages').doc(msg.id).update({ text:newText, edited:true });
        // if lastMessage equals old text, update chat.lastMessage
        const chatDoc = await db.collection('chats').doc(activeChatId).get();
        if(chatDoc.exists && chatDoc.data().lastMessage === msg.text){
          await db.collection('chats').doc(activeChatId).set({ lastMessage:newText, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
        }
        showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        editCont.remove();
      } catch(e){ console.error('edit msg', e); showToast('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); }
    });
    cancel.addEventListener('click', ()=> editCont.remove());
  }

  // delete with custom confirm
  async function deleteMessageFlow(msg){
    const ok = await openConfirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?');
    if(!ok) return;
    try {
      await db.collection('chats').doc(activeChatId).collection('messages').doc(msg.id).delete();
      showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
    } catch(e){ console.error('delete msg', e); showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
  }

  // mark read
  async function markMessagesRead(chatId){
    if(!profile) return;
    try {
      const q = db.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.email).where('read','==', false);
      const snap = await q.get();
      const batch = db.batch();
      snap.forEach(docSnap => batch.update(db.collection('chats').doc(chatId).collection('messages').doc(docSnap.id), { read:true }));
      if(!snap.empty) await batch.commit();
    } catch(e){ console.error('mark read', e); }
  }

  // send text/file
  sendBtn.addEventListener('click', async ()=>{
    if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
    const text = (messageText.value||'').trim();
    try {
      if(fileInput.files.length){
        const f = fileInput.files[0];
        const ext = (f.name.split('.').pop()||'').toLowerCase();
        const isImage = ['png','jpg','jpeg','webp','gif'].includes(ext);
        const path = `chats/${activeChatId}/files/${Date.now()}_${f.name}`;
        const ref = storage.ref().child(path);
        const snap = await ref.put(f);
        const url = await snap.ref.getDownloadURL();
        await db.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.email, text:'', type:isImage?'image':'file', url, createdAt: FieldValue.serverTimestamp(), delivered:false, read:false });
        await db.collection('chats').doc(activeChatId).set({ lastMessage: isImage ? 'üì∑ –§–æ—Ç–æ' : '–§–∞–π–ª', updatedAt: FieldValue.serverTimestamp() }, { merge:true });
        fileInput.value = '';
      }
      if(text){
        await db.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.email, text, type:'text', createdAt: FieldValue.serverTimestamp(), delivered:false, read:false });
        await db.collection('chats').doc(activeChatId).set({ lastMessage:text, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
        messageText.value = '';
      }
    } catch(e){ console.error('send', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
  });

  messageText.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

  // back button
  backBtn.addEventListener('click', ()=>{
    if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
    activeChatId = null;
    composer.style.display='none';
    chatHeader.style.display='none';
    messagesDiv.innerHTML = '<div class="muted center">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>';
    if(window.innerWidth < 720) leftPane.style.display='flex';
  });

  // open profile modal already implemented via openProfileViewer

  // ---------- lastActive (online) ----------
  function startLastSeen(){
    if(!me) return;
    updateLastActive();
    lastSeenInterval = setInterval(updateLastActive, 30*1000);
    window.addEventListener('focus', updateLastActive);
    window.addEventListener('blur', updateLastActive);
  }
  function stopLastSeen(){
    clearInterval(lastSeenInterval);
    window.removeEventListener('focus', updateLastActive);
    window.removeEventListener('blur', updateLastActive);
  }
  function updateLastActive(){
    if(!me) return;
    db.collection('users').doc(me.uid).set({ lastActive: FieldValue.serverTimestamp() }, { merge:true }).catch(e=>console.warn('lastActive', e));
  }

  // ---------- PUSH: get token & save ----------
  async function getAndSaveFcmToken(){
    if(!messaging) { showToast('–ü—É—à–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º'); return null; }
    try {
      if(Notification.permission !== 'granted'){
        const p = await Notification.requestPermission();
        if(p !== 'granted'){ showToast('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'); return null; }
      }
      const currentToken = await messaging.getToken({ vapidKey: VAPID_KEY });
      if(currentToken){
        await db.collection('users').doc(me.uid).set({ fcmTokens: FieldValue.arrayUnion(currentToken) }, { merge:true });
        showToast('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        return currentToken;
      } else { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω'); return null; }
    } catch(e){ console.error('getToken', e); showToast('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + (e.message||e.code)); return null; }
  }

  btnRequestPerm.addEventListener('click', async ()=>{
    if(!me) return showToast('–í–æ–π–¥–∏—Ç–µ');
    await getAndSaveFcmToken();
  });

  btnShowTokens.addEventListener('click', async ()=>{
    if(!me) return showToast('–í–æ–π–¥–∏—Ç–µ');
    const doc = await db.collection('users').doc(me.uid).get();
    tokensOutput.style.display='block';
    tokensOutput.textContent = JSON.stringify(doc.exists ? (doc.data().fcmTokens||[]) : [], null, 2);
  });

  // handle foreground messages
  if(messaging){
    messaging.onMessage(payload=>{
      console.log('onMessage payload', payload);
      // show small toast in-app
      const title = (payload.notification && payload.notification.title) || '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ';
      const body = (payload.notification && payload.notification.body) || '';
      showToast(title + (body ? ': ' + body : ''));
    });
  }

  // ---------- mark delivered/read handled in onSnapshot of messages above ----------

  // ---------- markMessagesRead function exists above ----------

  // ---------- stop listeners ----------
  function stopAll(){
    if(chatsUnsub){ chatsUnsub(); chatsUnsub = null; }
    if(msgsUnsub){ msgsUnsub(); msgsUnsub = null; }
    activeChatId = null;
    messagesDiv.innerHTML = '<div class="muted center">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>';
    composer.style.display='none';
    chatHeader.style.display='none';
    stopLastSeen();
  }

  // small UI on load
  window.addEventListener('load', ()=> {
    if(!auth.currentUser) injectLoginModal();
  });

  // expose debug
  window.$Talk = { auth, db, storage, messaging, getAndSaveFcmToken };

  console.log('$Talk integrated ready ‚Äî triple-checked (syntax & logic)');

  </script>
</body>
</html>
