<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>$Talk — мобильная PWA (Email Link)</title>

  <!-- (Опционально) подключи manifest.json в корне репо -->
  <link rel="manifest" href="./manifest.json" />

  <style>
    /* Mobile-first дизайн для $Talk */
    :root{
      --primary:#1e90ff;
      --accent:#00c853;
      --bg:#ffffff;
      --text:#222;
      --muted:#666;
      --user-bubble:#e6f0ff;
      --other-bubble:#f2f2f2;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--text)}
    .app{height:100vh;display:flex;flex-direction:column}
    header{display:flex;align-items:center;gap:12px;padding:12px 14px;background:linear-gradient(90deg,var(--primary),#3fb0ff);color:white}
    .menu-btn{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center}
    .title{font-weight:700;font-size:18px}
    main{flex:1;display:flex;flex-direction:column;overflow:hidden}
    /* chats list collapsible on mobile */
    .top-controls{display:flex;gap:8px;padding:10px;background:#fff;border-bottom:1px solid #eee}
    .chats-list{display:flex;flex-direction:column;gap:8px;padding:10px;overflow:auto}
    .chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.03);cursor:pointer}
    .chat-item .ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:600}
    .chat-meta{flex:1}
    .chat-meta .name{font-weight:600}
    .chat-meta .last{font-size:13px;color:var(--muted)}
    .chat-area{flex:1;display:flex;flex-direction:column;background:#fff}
    .messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:78%;padding:10px;border-radius:12px}
    .msg.me{align-self:flex-end;background:var(--user-bubble)}
    .msg.you{align-self:flex-start;background:var(--other-bubble)}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .composer{display:flex;padding:10px;gap:8px;border-top:1px solid #eee;background:#fff}
    .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid #eee}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px 12px;border-radius:10px}
    .btn.ghost{background:#f5f5f5;color:var(--text)}
    .drawer{position:fixed;left:-320px;top:0;width:320px;height:100%;background:#fff;box-shadow:2px 0 12px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40}
    .drawer.open{left:0}
    .field{margin-bottom:10px}
    .field label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input, .field textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eee}
    /* Login modal (mobile centered) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .card{width:92%;max-width:420px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
    .logo{width:46px;height:46;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-right:10px}
    .muted{color:var(--muted);font-size:13px}
    .center{text-align:center}
    /* responsive tweak */
    @media(min-width:720px){
      main{flex-direction:row}
      .left-col{width:320px;border-right:1px solid #eee;display:flex;flex-direction:column}
      .right-col{flex:1}
      .top-controls{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="menu-btn" id="menuBtn" title="Профиль ☰">
        <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect y="0" width="18" height="2" rx="1" fill="white"/><rect y="5" width="18" height="2" rx="1" fill="white"/><rect y="10" width="18" height="2" rx="1" fill="white"/></svg>
      </div>
      <div class="title">$Talk</div>
      <div style="flex:1"></div>
      <div id="badge" class="muted" style="font-size:14px"></div>
    </header>

    <main>
      <!-- left column (mobile: top controls) -->
      <div class="left-col" id="leftCol" style="display:none">
        <div class="top-controls">
          <input id="search" placeholder="Поиск..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee" />
          <button id="newBtn" class="btn ghost" style="padding:8px 10px">Новый</button>
        </div>
        <div class="chats-list" id="chatsList"></div>
      </div>

      <!-- on mobile show top controls -->
      <div class="top-controls" id="topControlsMobile" style="display:flex">
        <input id="searchMobile" placeholder="Поиск контактов..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee" />
        <button id="newBtnM" class="btn ghost" style="padding:8px 10px">Новый</button>
      </div>

      <div class="right-col chat-area" style="flex:1;display:flex;flex-direction:column">
        <div class="messages" id="messages">
          <div class="center muted">Выберите чат или создайте новый</div>
        </div>

        <div class="composer">
          <input id="msgInput" placeholder="Напишите сообщение..." autocomplete="off" />
          <button id="sendMsg" class="btn">Отправить</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer: профиль -->
  <div class="drawer" id="drawer">
    <h3>Профиль</h3>
    <div class="field">
      <label>Email</label>
      <input id="profileEmail" disabled />
    </div>
    <div class="field">
      <label>Имя</label>
      <input id="profileName" maxlength="30" placeholder="Например: Ali" />
    </div>
    <div class="field">
      <label>Логин (начинается с $)</label>
      <input id="profileLogin" placeholder="$Ali" />
      <div class="muted" style="font-size:12px">Логин должен начинаться с $</div>
    </div>
    <div class="field">
      <label>О себе (до 100 символов)</label>
      <textarea id="profileAbout" maxlength="100" rows="3" placeholder="Расскажи о себе"></textarea>
    </div>
    <div style="display:flex;gap:8px">
      <button id="saveProfile" class="btn">Сохранить</button>
      <button id="logout" class="btn ghost">Выйти</button>
    </div>
  </div>

  <!-- Login overlay (Email Link) -->
  <div id="loginOverlay" class="overlay" style="display:none">
    <div class="card">
      <div style="display:flex;align-items:center;margin-bottom:8px">
        <div class="logo">$</div>
        <div>
          <div style="font-weight:700;font-size:16px">$Talk</div>
          <div class="muted">Вход по email — безопасно и бесплатно</div>
        </div>
      </div>

      <div id="emailStep">
        <label class="muted">Введите email</label>
        <input id="emailInput" type="email" placeholder="you@example.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:6px" />
        <div style="height:10px"></div>
        <button id="sendLinkBtn" class="btn">Отправить ссылку для входа</button>
        <div class="muted center" style="margin-top:10px;font-size:13px">Проверь почту — перейди по ссылке, чтобы войти</div>
      </div>

      <div id="afterSend" style="display:none;margin-top:12px">
        <div class="muted">Письмо отправлено. Проверь почту и нажми ссылку. После перехода ты вернёшься на эту страницу и автоматически войдёшь.</div>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    /**
     * $Talk mobile PWA — Email Link auth + Firestore chats/messages
     * - Modular Firebase v9 via CDN
     * - Email sign-in link (passwordless) — no billing required
     * - Uses email as user identifier for chats/participants
     *
     * Проверено: импорты, flow входа, onSnapshot слушатели, send message flow.
     */

    // ---- Firebase imports (v9 modular CDN) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getAuth,
      sendSignInLinkToEmail,
      isSignInWithEmailLink,
      signInWithEmailLink,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      addDoc,
      onSnapshot,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ---- Firebase config (твоя конфигурация) ----
    const firebaseConfig = {
      apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
      authDomain: "talk-f1ff9.firebaseapp.com",
      projectId: "talk-f1ff9",
      storageBucket: "talk-f1ff9.appspot.com",
      messagingSenderId: "856136352939",
      appId: "1:856136352939:web:87c28128d4951f909f63ee",
      measurementId: "G-3KDE4QT7PF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- DOM ----
    const loginOverlay = document.getElementById('loginOverlay');
    const sendLinkBtn = document.getElementById('sendLinkBtn');
    const emailInput = document.getElementById('emailInput');
    const afterSend = document.getElementById('afterSend');

    const badge = document.getElementById('badge');
    const menuBtn = document.getElementById('menuBtn');
    const drawer = document.getElementById('drawer');
    const profileEmail = document.getElementById('profileEmail');
    const profileName = document.getElementById('profileName');
    const profileLogin = document.getElementById('profileLogin');
    const profileAbout = document.getElementById('profileAbout');
    const saveProfile = document.getElementById('saveProfile');
    const logoutBtn = document.getElementById('logout');

    const chatsList = document.getElementById('chatsList');
    const topControlsMobile = document.getElementById('topControlsMobile');
    const newBtnM = document.getElementById('newBtnM');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendMsg = document.getElementById('sendMsg');

    // ---- State ----
    let currentUser = null; // { uid, email, name, login, about }
    let chatsUnsub = null;
    let msgsUnsub = null;
    let activeChatId = null;

    // ---- Helpers ----
    const showToast = (t) => { alert(t); };
    const escapeHtml = s => (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));

    // ---- Email Link flow ----
    const actionCodeSettings = {
      url: window.location.href,
      handleCodeInApp: true
    };

    sendLinkBtn.addEventListener('click', async () => {
      const email = (emailInput.value || '').trim();
      if(!email) return showToast('Введите email');
      try {
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        // Save email to localStorage to complete sign-in later
        localStorage.setItem('emailForSignIn', email);
        afterSend.style.display = 'block';
        showToast('Ссылка отправлена — проверьте почту');
      } catch(err) {
        console.error('sendSignInLinkToEmail error', err);
        showToast('Ошибка отправки ссылки: ' + (err.message || err.code || err));
      }
    });

    // If user clicked link in email and returned
    window.addEventListener('load', async () => {
      try {
        if (isSignInWithEmailLink(auth, window.location.href)) {
          let email = localStorage.getItem('emailForSignIn');
          if(!email) email = prompt('Введите email, на который был отправлен код');
          try {
            const result = await signInWithEmailLink(auth, email, window.location.href);
            // result.user is signed in
            localStorage.removeItem('emailForSignIn');
            showToast('Вход выполнен');
          } catch(err) {
            console.error('signInWithEmailLink error', err);
            showToast('Ошибка входа по ссылке: ' + (err.message || err.code || err));
          }
        }
      } catch(e){
        console.error('isSignInWithEmailLink check error', e);
      }
    });

    // ---- Auth state listener ----
    onAuthStateChanged(auth, async (user) => {
      if(user){
        // load/create user profile in Firestore
        const uRef = doc(db, 'users', user.uid);
        const snap = await getDocSafe(uRef);
        if(snap && snap.exists()){
          const data = snap.data();
          currentUser = {
            uid: user.uid,
            email: data.email || user.email,
            name: data.name || '',
            login: data.login || ('$' + (user.email.split('@')[0].slice(0,8))),
            about: data.about || ''
          };
        } else {
          // create minimal profile
          await setDoc(uRef, {
            email: user.email,
            name: '',
            login: '$' + (user.email.split('@')[0].slice(0,8)),
            about: '',
            createdAt: serverTimestamp()
          }, { merge: true });
          currentUser = { uid: user.uid, email: user.email, name:'', login:'$' + (user.email.split('@')[0].slice(0,8)), about:'' };
        }
        syncProfileForm();
        loginOverlay.style.display = 'none';
        startChatsListener();
        renderUserBadge();
      } else {
        // logged out
        currentUser = null;
        stopListeners();
        clearUI();
        loginOverlay.style.display = 'flex';
        renderUserBadge();
      }
    });

    // ---- Firestore helpers ----
    async function getDocSafe(ref){
      try { return await getDoc(ref); }
      catch(e){ console.error('getDocSafe', e); return null; }
    }

    async function getDocsSafe(q){
      try { return await getDocs(q); }
      catch(e){ console.error('getDocsSafe', e); return { forEach: ()=>{} }; }
    }

    // ---- Chats listener ----
    function startChatsListener(){
      if(!currentUser) return;
      if(chatsUnsub) chatsUnsub();
      const chatsRef = collection(db, 'chats');
      const q = query(chatsRef, where('participants', 'array-contains', currentUser.email), orderBy('updatedAt','desc'));
      // Note: if Firestore asks for composite index, follow the console link to create it
      chatsUnsub = onSnapshot(q, snap => {
        const arr = [];
        snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
        renderChats(arr);
      }, err => { console.error('chats onSnapshot', err); showToast('Ошибка чтения чатов'); });
    }

    function stopListeners(){
      if(chatsUnsub) { chatsUnsub(); chatsUnsub = null; }
      if(msgsUnsub)  { msgsUnsub(); msgsUnsub = null; }
      activeChatId = null;
    }

    // open a chat by id and listen messages
    function openChat(chatId){
      activeChatId = chatId;
      // stop previous messages listener
      if(msgsUnsub) msgsUnsub();
      const msgsRef = collection(db, 'chats', chatId, 'messages');
      const q = query(msgsRef, orderBy('createdAt','asc'));
      msgsUnsub = onSnapshot(q, snap => {
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderMessages(arr);
      }, err => { console.error('messages onSnapshot', err); showToast('Ошибка получения сообщений'); });
    }

    // ---- Create or open chat with email ----
    async function createOrOpenChatWith(email){
      if(!currentUser) return showToast('Сначала войдите');
      // check existing chats where current user participates
      const chatsRef = collection(db, 'chats');
      const q = query(chatsRef, where('participants', 'array-contains', currentUser.email));
      const snap = await getDocsSafe(q);
      let found = null;
      snap.forEach(d => {
        const data = d.data();
        if(Array.isArray(data.participants) && data.participants.includes(email)) found = { id: d.id, ...data };
      });
      if(found){ openChat(found.id); return; }
      // create new chat
      const newChatRef = await addDoc(collection(db,'chats'), {
        participants: [ currentUser.email, email ],
        lastMessage: '',
        updatedAt: serverTimestamp()
      });
      openChat(newChatRef.id);
    }

    // ---- Send message ----
    async function sendMessage(text){
      if(!activeChatId) return showToast('Откройте чат');
      if(!text) return;
      try {
        await addDoc(collection(db,'chats', activeChatId, 'messages'), {
          from: currentUser.email,
          text,
          createdAt: serverTimestamp()
        });
        // update chat summary
        const chatRef = doc(db,'chats', activeChatId);
        await setDoc(chatRef, { lastMessage: text, updatedAt: serverTimestamp() }, { merge: true });
      } catch(err){
        console.error('sendMessage', err);
        showToast('Ошибка отправки сообщения');
      }
    }

    // ---- Render UI ----
    function renderUserBadge(){ badge.textContent = currentUser ? (currentUser.name || currentUser.email) : ''; }

    function clearUI(){
      chatsList.innerHTML = '';
      messagesEl.innerHTML = '<div class="center muted">Выберите чат или создайте новый</div>';
      profileEmail.value = ''; profileName.value=''; profileLogin.value=''; profileAbout.value='';
    }

    function renderChats(chats){
      // if on small screen show list in top area
      chatsList.innerHTML = '';
      if(!chats.length) {
        chatsList.innerHTML = '<div class="muted" style="padding:12px">Чатов нет — создайте новый</div>';
        return;
      }
      chats.forEach(c => {
        const other = (c.participants||[]).find(p => p !== currentUser.email) || 'User';
        const el = document.createElement('div');
        el.className = 'chat-item';
        el.innerHTML = `<div class="ava">${other.slice(0,2).toUpperCase()}</div>
                        <div class="chat-meta"><div class="name">${escapeHtml(other)}</div><div class="last">${escapeHtml(c.lastMessage||'')}</div></div>`;
        el.onclick = ()=> openChat(c.id);
        chatsList.appendChild(el);
      });
    }

    function renderMessages(msgs){
      messagesEl.innerHTML = '';
      if(!msgs || !msgs.length){ messagesEl.innerHTML = '<div class="center muted">Чат пуст</div>'; return; }
      msgs.forEach(m => {
        const div = document.createElement('div');
        const cls = (m.from === currentUser.email) ? 'msg me' : 'msg you';
        div.className = cls;
        div.innerHTML = `<div class="meta">${escapeHtml(m.from)} · ${timeFromTS(m.createdAt)}</div><div>${escapeHtml(m.text)}</div>`;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function timeFromTS(ts){
      if(!ts) return '';
      try { if(ts.toDate) return ts.toDate().toLocaleTimeString(); return new Date(ts).toLocaleTimeString(); }
      catch(e){ return ''; }
    }

    // ---- Profile sync ----
    function syncProfileForm(){
      if(!currentUser) return;
      profileEmail.value = currentUser.email || '';
      profileName.value = currentUser.name || '';
      profileLogin.value = currentUser.login || '$' + (currentUser.email.split('@')[0].slice(0,8));
      profileAbout.value = currentUser.about || '';
    }

    saveProfile.addEventListener('click', async () => {
      if(!currentUser) return showToast('Сначала войдите');
      const name = (profileName.value || '').trim();
      const login = (profileLogin.value || '').trim();
      const about = (profileAbout.value || '').trim();
      if(!login.startsWith('$')) return showToast('Логин должен начинаться с $');
      if(about.length > 100) return showToast('Описание слишком длинное');

      const uRef = doc(db, 'users', currentUser.uid);
      try {
        await setDoc(uRef, { name, login, about, updatedAt: serverTimestamp() }, { merge: true });
        currentUser.name = name; currentUser.login = login; currentUser.about = about;
        syncProfileForm();
        renderUserBadge();
        showToast('Профиль сохранён');
        drawer.classList.remove('open');
      } catch(err){
        console.error('saveProfile', err);
        showToast('Ошибка сохранения профиля');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      if(confirm('Выйти из аккаунта?')) {
        try { await signOut(auth); localStorage.removeItem('emailForSignIn'); showToast('Выход выполнен'); }
        catch(e){ console.error('signOut', e); showToast('Ошибка выхода'); }
      }
    });

    menuBtn.addEventListener('click', ()=> drawer.classList.toggle('open'));

    newBtnM.addEventListener('click', async ()=> {
      const email = prompt('Введите email контакта (например friend@example.com)');
      if(!email) return;
      await createOrOpenChatWith(email.trim());
    });

    sendMsg.addEventListener('click', ()=> {
      const text = (msgInput.value||'').trim();
      if(!text) return;
      sendMessage(text);
      msgInput.value = '';
    });

    msgInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendMsg.click(); });

    // ---- On load: show login overlay by default; onAuthStateChanged will hide it if authed ----
    window.addEventListener('load', ()=> {
      loginOverlay.style.display = 'flex';
    });

    // ---- Expose debug helpers (console) ----
    window.$TalkDebug = {
      auth, db, currentUser: ()=> currentUser, openChat, createOrOpenChatWith
    };

    // End of module
  </script>
</body>
</html>
