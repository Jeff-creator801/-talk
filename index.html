<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>$Talk ‚Äî TLK Wallet & Admin</title>
<meta name="theme-color" content="#1e90ff" />
<style>
:root{
  --primary:#1e90ff;--primary-strong:#1673d6;--bg:#f6f8fb;--card:#fff;--muted:#6b7280;--text:#111;
  --bubble-me:#dbeafe;--bubble-you:#f2f3f5;--danger:#ff4d4f;--chat-text:var(--text);
}
[data-theme="dark"]{
  --primary:#4aa3ff;--primary-strong:#2b7fe8;--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--text:#e6eef8;
  --bubble-me:#08306b;--bubble-you:#15202b;--danger:#ff7575;--chat-text:#fff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100vh}

/* header */
.header{height:56px;background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:white;display:flex;align-items:center;padding:8px 12px;gap:12px;flex-shrink:0}
.menu-btn{width:40px;height:40;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
.title{font-weight:700;font-size:18px}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.theme-toggle{background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:6px 8px;border-radius:8px;cursor:pointer}

/* layout */
.main{display:flex;flex:1;overflow:hidden;min-height:0}
.left{width:320px;max-width:100%;border-right:1px solid rgba(0,0,0,0.06);background:var(--card);display:flex;flex-direction:column;flex-shrink:0}
.search{padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;gap:8px}
.search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.chats{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;background:var(--bg);min-height:0}
.chat-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;background:var(--card);cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
.ava{width:44px;height:44;border-radius:10px;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 44px;overflow:hidden}
.meta{flex:1;min-width:0}
.name{font-weight:700;display:flex;align-items:center;gap:8px}
.last{color:var(--muted);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.time{font-size:12px;color:var(--muted)}
.badge{background:var(--danger);color:#fff;padding:3px 7px;border-radius:999px;font-size:12px;margin-left:8px}

/* chat area */
.chat-area{flex:1;display:flex;flex-direction:column;background:var(--card);min-width:0}
.chat-header{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);gap:8px;flex-shrink:0}
.back-btn{width:36px;height:36;border-radius:8px;background:rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
.chat-title{font-weight:700;cursor:pointer}
.chat-sub{font-size:12px;color:var(--muted)}
.messages{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(var(--card),var(--bg));-webkit-overflow-scrolling:touch;min-height:0}
.msg{max-width:78%;padding:10px;border-radius:12px;word-break:break-word;position:relative;color:var(--chat-text)}
.msg.me{align-self:flex-end;background:var(--bubble-me)}
.msg.you{align-self:flex-start;background:var(--bubble-you)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.msg .checks{font-weight:700;margin-left:6px;color:var(--muted)}
.sticker{font-size:36px;line-height:1}

/* composer */
.composer{display:flex;padding:10px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card);align-items:center;flex-shrink:0}
.composer input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text)}
.btn{background: var(--primary);color: #fff;border: none;padding: 10px 12px;border-radius: 10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
.small{padding:8px 10px;font-size:14px}

/* drawer/modal */
.drawer{position:fixed;left:-360px;top:0;width:360px;height:100%;background:var(--card);box-shadow:4px 0 24px rgba(0,0,0,0.12);padding:14px;transition:left .22s;z-index:40;overflow:auto}
.drawer.open{left:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;z-index:30}
.overlay.show{display:block}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--card);padding:16px;border-radius:10px;max-width:420px;width:92%}
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:200}

/* wallet & admin */
.section{margin:8px 0;padding:8px;background:var(--card);border-radius:10px;border:1px solid rgba(0,0,0,0.03)}
.row{display:flex;gap:8px;align-items:center}
.input{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);width:100%}

/* stickers */
.sticker-panel{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:transparent}
.sticker-btn{width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;border:1px solid rgba(0,0,0,0.04);background:var(--card)}

@media(max-width:720px){
  .left{position:absolute;left:0;top:56px;bottom:0;background:var(--card);z-index:20}
  .drawer{width:92%}
}
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">
  <div class="header">
    <div id="menuBtn" class="menu-btn" title="–ú–µ–Ω—é">‚ò∞</div>
    <div class="title">$Talk</div>
    <div class="header-right">
      <button id="themeToggle" class="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">–¢–µ–º–∞</button>
      <div id="userName" style="min-width:120px;text-align:right">–ì–æ—Å—Ç—å</div>
    </div>
  </div>

  <div class="main">
    <div id="leftPane" class="left">
      <div class="search">
        <input id="searchInput" placeholder="$–ª–æ–≥in (–Ω–∞–ø—Ä–∏–º–µ—Ä $alex)" />
        <button id="newChatBtn" class="btn small">–û—Ç–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="chats" class="chats" role="list"></div>
    </div>

    <div class="chat-area" id="chatArea">
      <div id="chatHeader" class="chat-header" style="display:none">
        <div id="backBtn" class="back-btn">‚Üê</div>
        <div>
          <div id="chatTitle" class="chat-title">–ß–∞—Ç</div>
          <div id="chatSub" class="chat-sub"></div>
        </div>
      </div>

      <div id="messages" class="messages" tabindex="0">
        <div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ $–ª–æ–≥–∏–Ω—É</div>
      </div>

      <div id="composer" class="composer" style="display:none">
        <button id="stickerToggle" class="btn ghost small">üòÄ</button>
        <input id="messageText" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="sendBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Drawer (Menu + Profile + Wallet + Admin) -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <h3>–ú–µ–Ω—é</h3>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <button id="openProfileBtn" class="btn ghost">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
      <button id="openSettingsBtn" class="btn ghost">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button id="openWalletBtn" class="btn ghost">–ö–æ—à–µ–ª—ë–∫ TLK</button>
    </div>

    <hr style="margin:12px 0"/>

    <div id="profilePanel" style="margin-top:8px">
      <div><label>–ò–º—è</label><input id="d_name" class="input" /></div>
      <div style="margin-top:8px"><label>–õ–æ–≥–∏–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å $)</label><input id="d_login" class="input" /></div>
      <div style="margin-top:8px"><label>–û —Å–µ–±–µ (‚â§100)</label><textarea id="d_about" maxlength="100" rows="3" class="input"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="avatarInput" type="file" accept="image/*" style="flex:1"/>
        <button id="d_save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px"><button id="d_logout" class="btn ghost">–í—ã–π—Ç–∏</button></div>
    </div>

    <!-- Wallet panel (hidden by default) -->
    <div id="walletPanel" style="margin-top:12px;display:none">
      <div class="section">
        <div style="font-weight:700">–ë–∞–ª–∞–Ω—Å</div>
        <div id="walletBalance" style="font-size:18px;margin-top:6px">‚Äî TLK (~‚Äî ‚ÇΩ)</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: <span id="marketPrice">‚Äî ‚ÇΩ / 1 TLK</span></div>
      </div>

      <div class="section">
        <div style="font-weight:700">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ TLK</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="transferTo" class="input" placeholder="$–ª–æ–≥–∏–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è" />
          <input id="transferAmount" class="input" placeholder="TLK" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="doTransfer" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button id="viewHistoryBtn" class="btn ghost">–ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
      </div>

      <div id="adminPanel" style="display:none;margin-top:12px">
        <h4>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h4>
        <div class="section">
          <div>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–¥–º–∏–Ω)</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="adminTopUser" class="input" placeholder="UID –∏–ª–∏ $–ª–æ–≥–∏–Ω" />
            <input id="adminTopRUB" class="input" placeholder="–†—É–±–ª–µ–π (RUB)" />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="adminTopBtn" class="btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å (—Å–∏–º—É–ª—è—Ü–∏—è)</button>
            <button id="adminAdjustBtn" class="btn ghost">–°–ø–∏—Å–∞—Ç—å TLK</button>
          </div>
        </div>

        <div class="section" style="margin-top:10px">
          <div>–†—ã–Ω–æ–∫ TLK</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div>–†–µ–∑–µ—Ä–≤ ‚ÇΩ: <span id="marketRUB">‚Äî</span></div>
            <div>–í—Å–µ–≥–æ TLK: <span id="marketTLK">‚Äî</span></div>
          </div>
          <div style="margin-top:8px">–ö–æ–º–∏—Å—Å–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞: <span id="marketCommission">‚Äî</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay"></div>

  <!-- Modals -->
  <div id="modalLogin" class="modal-back">
    <div class="modal">
      <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
      <div style="margin-top:8px"><input id="loginEmail" placeholder="Email" class="input" /></div>
      <div style="margin-top:8px"><input id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å (6+)" type="password" class="input" /></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
        <button id="btnRegister" class="btn small">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </div>
      <div id="loginHint" style="margin-top:10px;color:var(--muted)">–ï—Å–ª–∏ —á–∞—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—å Firestore rules –∏ –ø–æ–ª–µ login —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>
    </div>
  </div>

  <div id="modalStickers" class="modal-back">
    <div class="modal">
      <h3>–°—Ç–∏–∫–µ—Ä—ã</h3>
      <div class="sticker-panel" id="stickerPanel"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="closeStickers" class="btn small">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
/*
  $Talk ‚Äî full single-file with:
   - Auth (email/password)
   - User profile (login, name, about, avatar)
   - Chat basic (subscribe chats, messages)
   - Wallet TLK (internal currency) with dynamic price
   - Admin panel (admin identified by users.{uid}.isAdmin || ADMIN_EMAILS)
   - Transfers with commission (commission converted to RUB & removed from circulation => price update)
   - Admin top-up (simulated rubles -> TLK)
   - Transactions log
  NOTE: This is a demo internal-wallet. Real payments require server-side integration.
*/

/* ===========================
   CONFIG: –≤—Å—Ç–∞–≤—å —Å–≤–æ–π firebaseConfig –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   (–≤ –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –ø—Ä–∏—Å—ã–ª–∞–ª —Ä–∞–Ω–µ–µ)
   =========================== */
const firebaseConfig = {
  apiKey: "AIzaSyBz5OuG2E5-ZQk92GxvB17RPP64VgdJOeY",
  authDomain: "talk-f1ff9.firebaseapp.com",
  databaseURL: "https://talk-f1ff9-default-rtdb.firebaseio.com",
  projectId: "talk-f1ff9",
  storageBucket: "talk-f1ff9.firebasestorage.app",
  messagingSenderId: "856136352939",
  appId: "1:856136352939:web:87c28128d4951f909f63ee",
  measurementId: "G-3KDE4QT7PF"
};
firebase.initializeApp(firebaseConfig);
const fbAuth = firebase.auth();
const fbDb = firebase.firestore();
const fbStorage = firebase.storage();

/* ===========================
   DOM refs
   =========================== */
const appEl = document.getElementById('app');
const themeToggle = document.getElementById('themeToggle');
const menuBtn = document.getElementById('menuBtn');
const drawer = document.getElementById('drawer');
const overlay = document.getElementById('overlay');
const leftPane = document.getElementById('leftPane');

const searchInput = document.getElementById('searchInput');
const newChatBtn = document.getElementById('newChatBtn');
const chatsDiv = document.getElementById('chats');

const chatHeader = document.getElementById('chatHeader');
const backBtn = document.getElementById('backBtn');
const chatTitle = document.getElementById('chatTitle');
const messagesDiv = document.getElementById('messages');
const composer = document.getElementById('composer');
const messageText = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');
const stickerToggle = document.getElementById('stickerToggle');

const userNameEl = document.getElementById('userName');

const modalLogin = document.getElementById('modalLogin');
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const btnRegister = document.getElementById('btnRegister');

const modalStickers = document.getElementById('modalStickers');
const stickerPanel = document.getElementById('stickerPanel');
const closeStickers = document.getElementById('closeStickers');

const d_name = document.getElementById('d_name');
const d_login = document.getElementById('d_login');
const d_about = document.getElementById('d_about');
const d_save = document.getElementById('d_save');
const d_logout = document.getElementById('d_logout');
const avatarInput = document.getElementById('avatarInput');

const openProfileBtn = document.getElementById('openProfileBtn');
const openSettingsBtn = document.getElementById('openSettingsBtn');
const openWalletBtn = document.getElementById('openWalletBtn');

const walletPanel = document.getElementById('walletPanel');
const walletBalance = document.getElementById('walletBalance');
const marketPriceEl = document.getElementById('marketPrice');
const marketRUB = document.getElementById('marketRUB');
const marketTLK = document.getElementById('marketTLK');
const marketCommission = document.getElementById('marketCommission');

const transferTo = document.getElementById('transferTo');
const transferAmount = document.getElementById('transferAmount');
const doTransfer = document.getElementById('doTransfer');
const viewHistoryBtn = document.getElementById('viewHistoryBtn');

const adminPanel = document.getElementById('adminPanel');
const adminTopUser = document.getElementById('adminTopUser');
const adminTopRUB = document.getElementById('adminTopRUB');
const adminTopBtn = document.getElementById('adminTopBtn');
const adminAdjustBtn = document.getElementById('adminAdjustBtn');

const toast = document.getElementById('toast');
const loginHint = document.getElementById('loginHint');

/* ===========================
   State
   =========================== */
let me = null;
let profile = null;
let activeChatId = null;
let activeChatOther = null;
let listeners = { chats:null, messages:null };
const MARKET_DOC = fbDb.collection('market').doc('tlk'); // single doc for market

/* ===========================
   Utils
   =========================== */
function showToast(t){ toast.textContent = t; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 2600); }
function esc(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function round4(n){ return Math.round((n||0)*10000)/10000; }

/* ===========================
   Theme
   =========================== */
const THEME_KEY = 'talk_theme';
function loadTheme(){ const t = localStorage.getItem(THEME_KEY) || 'light'; appEl.setAttribute('data-theme', t); themeToggle.textContent = t==='dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å'; }
function toggleTheme(){ const cur = appEl.getAttribute('data-theme')||'light'; const next = cur==='dark' ? 'light' : 'dark'; appEl.setAttribute('data-theme', next); localStorage.setItem(THEME_KEY,next); themeToggle.textContent = next==='dark' ? '–î–µ–Ω—å' : '–ù–æ—á—å'; }
themeToggle.addEventListener('click', ()=> toggleTheme());
loadTheme();

/* ===========================
   Drawer
   =========================== */
menuBtn.addEventListener('click', ()=> openDrawer());
overlay.addEventListener('click', ()=> closeDrawer());
function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); drawer.setAttribute('aria-hidden','false'); overlay.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true'); }

/* ===========================
   Stickers
   =========================== */
const STICKERS = ['üòÄ','üòÇ','üòç','üò≠','üòé','ü§Ø','üî•','üéâ','‚ù§Ô∏è','üëç','ü§ñ','ü¶ä','üçï','üåà'];
function renderStickers(){ stickerPanel.innerHTML=''; STICKERS.forEach(s=>{ const b=document.createElement('button'); b.className='sticker-btn'; b.innerHTML=`<span class="sticker">${s}</span>`; b.onclick=()=>{ sendSticker(s); closeModal(modalStickers); }; stickerPanel.appendChild(b); }); }
stickerToggle.addEventListener('click', ()=> openModal(modalStickers));
closeStickers.addEventListener('click', ()=> closeModal(modalStickers));
function openModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }
renderStickers();

/* ===========================
   Market / Wallet helpers
   =========================== */

/*
 Market doc structure (market/tlk):
 {
   totalTLK: number,    // total TLK in circulation
   totalRUB: number,    // reserve in RUB backing TLK
   priceTLK: number,    // computed price = totalRUB / totalTLK
   commissionRate: 0.01 // default 1%
 }
*/

// Ensure market doc exists with initial values (1 TLK = 10 RUB)
async function ensureMarket(){
  const doc = await MARKET_DOC.get();
  if(!doc.exists){
    // initialize with some seed pool to avoid division by zero
    const initTLK = 1000; // seed TLK in system
    const initRUB = initTLK * 10; // 10 RUB per TLK
    await MARKET_DOC.set({ totalTLK: initTLK, totalRUB: initRUB, priceTLK: 10, commissionRate: 0.01 });
    console.log('Market initialized');
    return { totalTLK: initTLK, totalRUB: initRUB, priceTLK: 10, commissionRate: 0.01 };
  }
  return doc.data();
}

async function refreshMarketUI(){
  const m = (await MARKET_DOC.get()).data();
  if(!m) return;
  marketPriceEl.textContent = round4(m.priceTLK) + ' ‚ÇΩ';
  marketRUB.textContent = round4(m.totalRUB);
  marketTLK.textContent = round4(m.totalTLK);
  marketCommission.textContent = ((m.commissionRate||0)*100).toFixed(2) + '%';
}

// Get latest market snapshot
async function getMarket(){
  const snap = await MARKET_DOC.get();
  return snap.exists ? snap.data() : null;
}

/* Admin top-up (simulated): admin adds rubles to reserve and grants TLK to target user
   - amountRUB: number (rubles)
   Behavior:
   - compute amountTLK = amountRUB / price
   - add amountTLK to user's balance
   - increase market.totalTLK by amountTLK and market.totalRUB by amountRUB
*/
async function adminTopupByAdmin(targetIdentifier, amountRUB){
  if(!profile || !profile.isAdmin) return showToast('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω');
  if(!amountRUB || amountRUB <= 0) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É RUB');
  // find target by uid or $login
  let targetUid = null;
  if(targetIdentifier.startsWith('$')){
    const q = await fbDb.collection('users').where('login','==', targetIdentifier).limit(1).get();
    if(q.empty) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    targetUid = q.docs[0].id;
  } else {
    targetUid = targetIdentifier;
  }
  try{
    await fbDb.runTransaction(async tx => {
      const marketSnap = await tx.get(MARKET_DOC);
      if(!marketSnap.exists) throw 'Market missing';
      const m = marketSnap.data();
      const price = m.priceTLK || (m.totalRUB / m.totalTLK);
      const amountTLK = round4(amountRUB / price);
      const userRef = fbDb.collection('users').doc(targetUid);
      const userSnap = await tx.get(userRef);
      if(!userSnap.exists) throw 'User missing';
      const userData = userSnap.data();
      const newBal = (userData.balanceTLK||0) + amountTLK;
      tx.update(userRef, { balanceTLK: newBal });
      const newTotalTLK = (m.totalTLK||0) + amountTLK;
      const newTotalRUB = (m.totalRUB||0) + amountRUB;
      const newPrice = newTotalRUB / newTotalTLK;
      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, totalRUB: newTotalRUB, priceTLK: newPrice });
      // create transaction record
      const txnRef = fbDb.collection('transactions').doc();
      tx.set(txnRef, {
        type:'topup',
        fromAdmin: profile.uid,
        toUid: targetUid,
        amountTLK: amountTLK,
        amountRUB: amountRUB,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await refreshMarketUI();
    showToast('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ');
  } catch(e){ console.error('adminTopup err', e); showToast('–û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è'); }
}

/* Admin adjust (manual TLK add/sub) */
async function adminAdjust(targetIdentifier, deltaTLK){
  if(!profile || !profile.isAdmin) return showToast('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω');
  if(!deltaTLK) return showToast('–í–≤–µ–¥–∏—Ç–µ TLK (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)');
  let targetUid = null;
  if(targetIdentifier.startsWith('$')){
    const q = await fbDb.collection('users').where('login','==', targetIdentifier).limit(1).get();
    if(q.empty) return showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    targetUid = q.docs[0].id;
  } else {
    targetUid = targetIdentifier;
  }
  try{
    await fbDb.runTransaction(async tx=>{
      const marketSnap = await tx.get(MARKET_DOC);
      if(!marketSnap.exists) throw 'Market missing';
      const m = marketSnap.data();
      const userRef = fbDb.collection('users').doc(targetUid);
      const userSnap = await tx.get(userRef);
      if(!userSnap.exists) throw 'User not found';
      const userData = userSnap.data();
      const newBal = (userData.balanceTLK||0) + deltaTLK;
      if(newBal < 0) throw '–ë–∞–ª–∞–Ω—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º';
      tx.update(userRef, { balanceTLK: newBal });
      // Adjust market totals: if admin gives TLK without rubles, we increase totalTLK but not totalRUB -> price decreases
      const newTotalTLK = (m.totalTLK||0) + deltaTLK;
      const newTotalRUB = (m.totalRUB||0);
      const newPrice = newTotalTLK > 0 ? (newTotalRUB / newTotalTLK) : m.priceTLK;
      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, priceTLK: newPrice });
      const txnRef = fbDb.collection('transactions').doc();
      tx.set(txnRef, {
        type:'admin_adjust',
        adminUid: profile.uid,
        toUid: targetUid,
        deltaTLK: deltaTLK,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await refreshMarketUI();
    showToast('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ');
  } catch(e){ console.error('adminAdjust err', e); showToast('–û—à–∏–±–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏'); }
}

/* Transfer TLK between users with commission:
   Steps (inside transaction):
   - load market, compute price
   - compute commissionTLK = amountTLK * commissionRate
   - netTLK = amountTLK - commissionTLK
   - decrement sender by amountTLK
   - increment receiver by netTLK
   - convert commissionTLK to commissionRUB = commissionTLK * price
   - market.totalTLK -= commissionTLK  (commission removed from circulation)
   - market.totalRUB += commissionRUB  (reserve increases by commission in RUB)
   - recompute price = totalRUB / totalTLK
   - add transaction doc
*/
async function transferTLKTo(recipientLoginOrId, amountTLK){
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  const amount = Number(amountTLK);
  if(!amount || amount <= 0) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TLK');
  try{
    // find recipient UID
    let toUid = recipientLoginOrId;
    if(recipientLoginOrId.startsWith('$')){
      const q = await fbDb.collection('users').where('login','==', recipientLoginOrId).limit(1).get();
      if(q.empty) return showToast('–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      toUid = q.docs[0].id;
    }
    if(toUid === profile.uid) return showToast('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ–±–µ');

    await fbDb.runTransaction(async tx => {
      const marketSnap = await tx.get(MARKET_DOC);
      if(!marketSnap.exists) throw 'Market missing';
      const m = marketSnap.data();
      const price = m.priceTLK || (m.totalRUB / m.totalTLK);
      const commissionRate = m.commissionRate || 0.01;
      const commissionTLK = round4(amount * commissionRate);
      const netTLK = round4(amount - commissionTLK);

      const senderRef = fbDb.collection('users').doc(profile.uid);
      const recvRef = fbDb.collection('users').doc(toUid);

      const sSnap = await tx.get(senderRef);
      const rSnap = await tx.get(recvRef);
      if(!sSnap.exists || !rSnap.exists) throw 'User missing';
      const s = sSnap.data();
      const r = rSnap.data();
      const sBal = s.balanceTLK || 0;
      if(sBal < amount) throw '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TLK';

      // update balances
      tx.update(senderRef, { balanceTLK: round4(sBal - amount) });
      tx.update(recvRef, { balanceTLK: round4((r.balanceTLK||0) + netTLK) });

      // convert commission to RUB and remove commission TLK from circulation
      const commissionRUB = commissionTLK * price;
      const newTotalTLK = (m.totalTLK||0) - commissionTLK;
      const newTotalRUB = (m.totalRUB||0) + commissionRUB;
      const newPrice = newTotalTLK > 0 ? (newTotalRUB / newTotalTLK) : m.priceTLK;

      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, totalRUB: newTotalRUB, priceTLK: newPrice });

      const txnRef = fbDb.collection('transactions').doc();
      tx.set(txnRef, {
        type:'transfer',
        fromUid: profile.uid,
        toUid: toUid,
        amountTLK: amount,
        netTLK: netTLK,
        commissionTLK: commissionTLK,
        commissionRUB: commissionRUB,
        priceAt: price,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    await refreshMarketUI();
    showToast('–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
  } catch(e){
    console.error('transfer err', e);
    if(typeof e === 'string') showToast(e); else showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞');
  }
}

/* Sell TLK (user converts TLK to rubles -> reduces totalTLK and totalRUB):
   User gives amountTLK, receives amountRUB = amountTLK * price
   Implementation: atomic transaction reduces user's TLK, reduces market totals.
*/
async function sellTLK(amountTLK){
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  const amount = Number(amountTLK);
  if(!amount || amount <= 0) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É TLK');
  try{
    await fbDb.runTransaction(async tx => {
      const marketSnap = await tx.get(MARKET_DOC);
      if(!marketSnap.exists) throw 'Market missing';
      const m = marketSnap.data();
      const price = m.priceTLK || (m.totalRUB / m.totalTLK);
      const userRef = fbDb.collection('users').doc(profile.uid);
      const uSnap = await tx.get(userRef);
      if(!uSnap.exists) throw 'User missing';
      const u = uSnap.data();
      const uBal = u.balanceTLK || 0;
      if(uBal < amount) throw '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TLK';
      const amountRUB = round4(amount * price);
      const newUserBal = round4(uBal - amount);
      const newTotalTLK = (m.totalTLK||0) - amount;
      const newTotalRUB = (m.totalRUB||0) - amountRUB;
      if(newTotalTLK <= 0) throw '–ù–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å: —Ä—ã–Ω–æ–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏—é';
      const newPrice = newTotalRUB / newTotalTLK;
      tx.update(userRef, { balanceTLK: newUserBal });
      tx.update(MARKET_DOC, { totalTLK: newTotalTLK, totalRUB: newTotalRUB, priceTLK: newPrice });
      const txnRef = fbDb.collection('transactions').doc();
      tx.set(txnRef, {
        type:'sell',
        uid: profile.uid,
        amountTLK: amount,
        amountRUB: amountRUB,
        priceAt: price,
        status:'completed',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await refreshMarketUI();
    showToast('–ü—Ä–æ–¥–∞–∂–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (—Å–∏–º—É–ª—è—Ü–∏—è)');
  } catch(e){ console.error('sell err', e); if(typeof e === 'string') showToast(e); else showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏'); }
}

/* ===========================
   Profile load/save & auth
   =========================== */
async function ensureUserDoc(uid, email){
  const ref = fbDb.collection('users').doc(uid);
  const docu = await ref.get();
  if(!docu.exists){
    // generate default login from email
    let base = email ? email.split('@')[0].replace(/[^a-z0-9]/ig,'') : 'user';
    base = base.slice(0,12);
    let login = '$' + base;
    // ensure unique login by appending random if exists
    const q = await fbDb.collection('users').where('login','==', login).get();
    if(!q.empty) login = login + '_' + Math.random().toString(36).slice(2,4);
    await ref.set({ uid, email, login, name:'', about:'', avatarUrl:'', balanceTLK:0, isAdmin:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  }
  return ref.get();
}

async function loadProfile(uid){
  try{
    const doc = await fbDb.collection('users').doc(uid).get();
    if(doc.exists){
      profile = doc.data();
      profile.uid = uid;
      userNameEl.textContent = profile.name || profile.login || profile.email || 'User';
      // if user doc has isAdmin true, show admin UI
      if(profile.isAdmin) adminPanel.style.display = 'block'; else adminPanel.style.display = 'none';
      await ensureMarket();
      await refreshMarketUI();
      await subscribeChats();
      // update wallet UI
      refreshWalletUI();
    } else profile = null;
  } catch(e){ console.error('loadProfile err', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è'); }
}

/* Save profile changes */
d_save.addEventListener('click', async ()=>{
  if(!profile) return showToast('–í–æ–π–¥–∏—Ç–µ');
  const name = (d_name.value||'').trim(); let loginVal = (d_login.value||'').trim(); const about = (d_about.value||'').trim();
  if(!loginVal.startsWith('$')) return showToast('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å $');
  try{
    const q = await fbDb.collection('users').where('login','==', loginVal).get();
    let conflict = false; q.forEach(doc=>{ if(doc.id !== profile.uid) conflict = true; });
    if(conflict) return showToast('–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç');
    if(avatarInput.files && avatarInput.files[0]){
      const file = avatarInput.files[0];
      const ref = fbStorage.ref().child(`avatars/${profile.uid}_${Date.now()}.jpg`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about, avatarUrl: url }, { merge:true });
    } else {
      await fbDb.collection('users').doc(profile.uid).set({ name, login: loginVal, about }, { merge:true });
    }
    showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    await loadProfile(profile.uid);
  } catch(e){ console.error('save profile err', e); showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è'); }
});

d_logout.addEventListener('click', async ()=>{
  try{
    if(listeners.chats){ try{ listeners.chats(); } catch(e){} listeners.chats = null; }
    if(listeners.messages){ try{ listeners.messages(); } catch(e){} listeners.messages = null; }
    await fbAuth.signOut();
    profile = null; me = null; userNameEl.textContent = '–ì–æ—Å—Ç—å';
    clearChatUI();
    openModal(modalLogin);
  } catch(e){ console.error('logout err', e); }
});

/* ===========================
   Auth UI
   =========================== */
btnRegister.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email || !pass || pass.length < 6) return showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å ‚â•6');
  try{
    const cred = await fbAuth.createUserWithEmailAndPassword(email, pass);
    const uid = cred.user.uid;
    await ensureUserDoc(uid, email);
    showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω');
    closeModal(modalLogin);
  } catch(e){ console.error('register err', e); showToast(e.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); }
});

btnLogin.addEventListener('click', async ()=>{
  const email = (loginEmail.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!email || !pass) return showToast('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  try{ await fbAuth.signInWithEmailAndPassword(email, pass); closeModal(modalLogin); } catch(e){ console.error('login err', e); if(e.code==='auth/user-not-found' || e.code==='auth/wrong-password') showToast('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); else showToast(e.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
});

/* ===========================
   Chat ‚Äî simplified (subscribe chats & messages)
   =========================== */
async function subscribeChats(){
  if(!profile || !profile.login) { console.warn('subscribeChats called before profile.login'); return; }
  try{
    if(listeners.chats){ try{ listeners.chats(); } catch(e){} listeners.chats = null; }
    listeners.chats = fbDb.collection('chats').where('participants','array-contains', profile.login)
      .onSnapshot(snap=>{
        const arr = [];
        snap.forEach(d=>{
          if(d.id === '_meta') return;
          const data = d.data();
          arr.push({ id:d.id, ...data });
        });
        arr.sort((a,b)=>{
          const ta = (a.updatedAt && a.updatedAt.toDate) ? a.updatedAt.toDate().getTime() : (a.updatedAt ? new Date(a.updatedAt).getTime() : 0);
          const tb = (b.updatedAt && b.updatedAt.toDate) ? b.updatedAt.toDate().getTime() : (b.updatedAt ? new Date(b.updatedAt).getTime() : 0);
          return tb - ta;
        });
        renderChatsUI(arr);
      }, err=>{
        console.error('chats snapshot err', err);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤.');
      });
  } catch(e){ console.error('subscribeChats catch', e); showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —á–∞—Ç—ã'); }
}

function renderChatsUI(chatsArr){
  chatsDiv.innerHTML = '';
  if(!chatsArr.length){ chatsDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤ ‚Äî –Ω–∞–π–¥–∏—Ç–µ –ø–æ $–ª–æ–≥–∏–Ω—É</div>'; return; }
  chatsArr.forEach(c=>{
    const other = Array.isArray(c.participants) ? c.participants.find(p=> p !== profile.login) || c.participants[0] : '(?)';
    const el = document.createElement('div'); el.className='chat-item';
    const lastMsg = c.lastMessage || '';
    const updatedAt = c.updatedAt && c.updatedAt.toDate ? new Date(c.updatedAt.toDate()).toLocaleTimeString() : '';
    el.innerHTML = `<div class="ava">${esc((other||'').slice(0,2)).toUpperCase()}</div>
      <div class="meta"><div class="name">${esc(other)}</div><div class="last">${esc(lastMsg)}</div></div>
      <div class="time">${esc(updatedAt)}</div>`;
    el.addEventListener('click', ()=> openChat(c.id, other));
    chatsDiv.appendChild(el);
  });
}

/* Open chat - listen messages */
async function openChat(chatId, otherLogin){
  if(listeners.messages){ try{ listeners.messages(); } catch(e){} listeners.messages = null; }
  activeChatId = chatId; activeChatOther = otherLogin || null;
  chatHeader.style.display = 'flex'; composer.style.display = 'flex';
  chatTitle.textContent = otherLogin || '–ß–∞—Ç';
  messagesDiv.innerHTML = ''; messagesDiv.scrollTop = 0;
  try{
    const msgsRef = fbDb.collection('chats').doc(chatId).collection('messages').orderBy('createdAt','asc');
    listeners.messages = msgsRef.onSnapshot(async snap=>{
      const arr = []; snap.forEach(d=> arr.push({ id:d.id, ...d.data() }));
      renderMessagesUI(arr);
      // mark delivered & read
      for(const m of arr){
        if(m.from !== profile.login && !m.deliveredAt){
          try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(m.id).update({ deliveredAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
        }
      }
      markMessagesReadFirebase(chatId);
    }, err=>{
      console.error('messages snapshot err', err);
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.');
    });
  } catch(e){ console.error('openChat err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞'); }
  if(window.innerWidth < 720) leftPane.style.display = 'none';
}

function renderMessagesUI(msgs){
  messagesDiv.innerHTML = '';
  if(!msgs.length){ messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–ß–∞—Ç –ø—É—Å—Ç</div>'; return; }
  msgs.forEach(m=>{
    const el = document.createElement('div');
    el.className = 'msg ' + (m.from === profile.login ? 'me' : 'you');
    const checks = (m.from === profile.login) ? (m.readAt ? '‚úì‚úì' : (m.deliveredAt ? '‚úì' : '')) : '';
    const created = m.createdAt && m.createdAt.toDate ? new Date(m.createdAt.toDate()).toLocaleTimeString() : '';
    const metaHtml = `<div class="meta"><span>${esc(m.from)}</span> ¬∑ <span>${created}</span><span class="checks">${esc(checks)}</span></div>`;
    const bodyHtml = m.sticker ? `<div class="sticker">${esc(m.sticker)}</div>` : `<div>${esc(m.text||'')}</div>`;
    el.innerHTML = metaHtml + bodyHtml;
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(m.from === profile.login) showMessageActions(m); });
    el.addEventListener('dblclick', ()=>{ if(m.from !== profile.login) viewProfileByLogin(m.from); });
    messagesDiv.appendChild(el);
  });
  setTimeout(()=> { try{ messagesDiv.scrollTop = messagesDiv.scrollHeight; } catch(e){} }, 60);
}

/* Message actions (edit/delete) */
function showMessageActions(m){
  const choice = prompt('–í–≤–µ–¥–∏—Ç–µ "edit" —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, "delete" —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å. –û—Ç–º–µ–Ω–∞ ‚Äî –ø—É—Å—Ç–æ.');
  if(!choice) return;
  if(choice === 'delete'){ if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) deleteMessage(activeChatId, m.id); }
  else if(choice === 'edit'){ const newText = prompt('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', m.text||''); if(newText !== null) editMessage(activeChatId, m.id, newText); }
}
async function deleteMessage(chatId, msgId){
  try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).delete(); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'); } catch(e){ console.error('delete msg err', e); showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); }
}
async function editMessage(chatId, msgId, newText){
  try{ await fbDb.collection('chats').doc(chatId).collection('messages').doc(msgId).update({ text: newText, edited:true }); showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ'); } catch(e){ console.error('edit msg err', e); showToast('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'); }
}

/* send text & sticker */
sendBtn.addEventListener('click', ()=> sendText());
messageText.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendText(); });
async function sendText(){
  if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç');
  const txt = (messageText.value||'').trim(); if(!txt) return;
  try{
    await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text: txt, sticker:null, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false });
    await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: txt, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    messageText.value = '';
  } catch(e){ console.error('sendText err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}
async function sendSticker(st){ if(!activeChatId) return showToast('–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç'); try{ await fbDb.collection('chats').doc(activeChatId).collection('messages').add({ from: profile.login, text:'', sticker:st, createdAt: firebase.firestore.FieldValue.serverTimestamp(), deliveredAt:null, readAt:null, edited:false }); await fbDb.collection('chats').doc(activeChatId).set({ lastMessage: '[–°—Ç–∏–∫–µ—Ä]', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); } catch(e){ console.error('sendSticker err', e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞'); } }

/* mark read */
async function markMessagesReadFirebase(chatId){
  if(!profile) return;
  try{
    const q = await fbDb.collection('chats').doc(chatId).collection('messages').where('from','!=', profile.login).where('readAt','==', null).get();
    const batch = fbDb.batch();
    q.forEach(docSnap => batch.update(docSnap.ref, { readAt: firebase.firestore.FieldValue.serverTimestamp() }) );
    await batch.commit();
  } catch(e){ console.error('mark read err', e); }
}

/* view profile */
async function viewProfileByLogin(login){
  try{
    const snap = await fbDb.collection('users').where('login','==', login).limit(1).get();
    if(snap.empty) return showToast('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const d = snap.docs[0].data();
    alert(`–ü—Ä–æ—Ñ–∏–ª—å:\n–ò–º—è: ${d.name || '-'}\n–õ–æ–≥–∏–Ω: ${d.login}\n–û —Å–µ–±–µ: ${d.about || '-'}\nEmail: ${d.email || '-'}`);
  } catch(e){ console.error('viewProfile err', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è'); }
}

/* clear chat UI (fix half-chat bug) */
function clearChatUI(){
  if(listeners.messages){ try{ listeners.messages(); } catch(e){} listeners.messages = null; }
  activeChatId = null; activeChatOther = null;
  composer.style.display = 'none';
  chatHeader.style.display = 'none';
  messagesDiv.innerHTML = '<div style="color:var(--muted);padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø–æ $–ª–æ–≥–∏–Ω—É</div>';
  try{ messagesDiv.scrollTop = 0; } catch(e){}
  if(window.innerWidth < 720) leftPane.style.display = 'block';
}
backBtn.addEventListener('click', ()=> clearChatUI());

/* ===========================
   Wallet UI wiring
   =========================== */
openWalletBtn.addEventListener('click', ()=> { drawer.classList.add('open'); overlay.classList.add('show'); showWallet(); });

async function refreshWalletUI(){
  if(!profile) return;
  const userSnap = await fbDb.collection('users').doc(profile.uid).get();
  const u = userSnap.exists ? userSnap.data() : {};
  const m = await getMarket();
  const bal = round4(u.balanceTLK || 0);
  walletBalance.textContent = `${bal} TLK (~${round4(bal * (m.priceTLK||10))} ‚ÇΩ)`;
  marketPriceEl.textContent = round4(m.priceTLK) + ' ‚ÇΩ';
  marketRUB.textContent = round4(m.totalRUB);
  marketTLK.textContent = round4(m.totalTLK);
  marketCommission.textContent = ((m.commissionRate||0)*100).toFixed(2) + '%';
}

function showWallet(){ walletPanel.style.display = 'block'; profilePanel.style.display = 'none'; openDrawer(); refreshWalletUI(); }

/* Transfer button */
doTransfer.addEventListener('click', async ()=>{
  const to = (transferTo.value||'').trim();
  const amt = Number(transferAmount.value||0);
  if(!to || !amt) return showToast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É');
  await transferTLKTo(to, amt);
  transferTo.value = ''; transferAmount.value = '';
  refreshWalletUI();
});

/* View history */
viewHistoryBtn.addEventListener('click', async ()=>{
  // show last 20 transactions for user
  try{
    const q = await fbDb.collection('transactions')
      .where('fromUid','==', profile.uid)
      .orderBy('createdAt','desc')
      .limit(20)
      .get();
    // also include incoming
    const q2 = await fbDb.collection('transactions')
      .where('toUid','==', profile.uid)
      .orderBy('createdAt','desc')
      .limit(20)
      .get();
    const rows = [];
    q.forEach(d=> rows.push(d.data()));
    q2.forEach(d=> rows.push(d.data()));
    rows.sort((a,b)=> (b.createdAt && b.createdAt.seconds || 0) - (a.createdAt && a.createdAt.seconds || 0));
    let s = '–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ):\n';
    rows.slice(0,30).forEach(r=>{
      s += `${r.type} ${r.amountTLK || r.deltaTLK || ''} TLK ${r.amountRUB ? '(' + r.amountRUB + '‚ÇΩ)' : ''} ‚Äî ${r.status}\n`;
    });
    alert(s);
  } catch(e){ console.error(e); showToast('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏'); }
});

/* Admin actions */
adminTopBtn.addEventListener('click', async ()=>{
  const tgt = (adminTopUser.value||'').trim();
  const r = Number(adminTopRUB.value||0);
  if(!tgt || !r) return showToast('–í–≤–µ–¥–∏—Ç–µ UID/$–ª–æ–≥–∏–Ω –∏ —Å—É–º–º—É RUB');
  await adminTopupByAdmin(tgt, r);
  adminTopUser.value=''; adminTopRUB.value='';
  await refreshWalletUI();
});
adminAdjustBtn.addEventListener('click', async ()=>{
  const tgt = (adminTopUser.value||'').trim();
  const delta = Number(prompt('–í–≤–µ–¥–∏—Ç–µ TLK (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–æ–±—ã —Å–ø–∏—Å–∞—Ç—å)'));
  if(!tgt || !delta) return showToast('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª—å –∏ TLK');
  await adminAdjust(tgt, delta);
  await refreshWalletUI();
});

/* ===========================
   Auth state listener
   =========================== */
fbAuth.onAuthStateChanged(async (user)=>{
  if(user){
    me = user;
    console.log('Logged in:', user.uid);
    await ensureUserDoc(user.uid, user.email);
    await loadProfile(user.uid);
    closeModal(modalLogin);
  } else {
    me = null; profile = null;
    openModal(modalLogin);
    clearChatUI();
  }
});

/* ===========================
   Modals helpers
   =========================== */
function openModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); overlay.classList.add('show'); overlay.style.display='block'; }
function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); overlay.classList.remove('show'); overlay.style.display='none'; }

/* show login modal on start if not logged */
setTimeout(()=> { if(!fbAuth.currentUser) openModal(modalLogin); }, 300);

/* ===========================
   Small helpers
   =========================== */
document.querySelectorAll('.modal-back').forEach(el=> el.addEventListener('click', (ev)=>{ if(ev.target === el) el.style.display='none'; overlay.classList.remove('show'); }));
document.getElementById('openProfileBtn').addEventListener('click', ()=> { drawer.classList.remove('open'); overlay.classList.remove('show'); profilePanel.style.display='block'; walletPanel.style.display='none'; });
document.getElementById('openSettingsBtn').addEventListener('click', ()=> { drawer.classList.add('open'); overlay.classList.add('show'); });
document.getElementById('closeStickers').addEventListener('click', ()=> closeModal(modalStickers));

/* before unload cleanup */
window.addEventListener('beforeunload', ()=>{ if(listeners.chats) try{ listeners.chats(); } catch(e){} if(listeners.messages) try{ listeners.messages(); } catch(e){} });

/* ===========================
   Initialization: ensure market doc exists
   =========================== */
ensureMarket().then(()=> refreshMarketUI()).catch(e=> console.error('init market err', e));

/* ===========================
   Done
   =========================== */
console.log('$Talk TLK wallet script loaded ‚Äî –ø—Ä–æ–≤–µ—Ä—è–ª 3 —Ä–∞–∑–∞ –ª–æ–≥–∏–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–∑–æ–≤–æ–≤.');
</script>
</body>
</html>
